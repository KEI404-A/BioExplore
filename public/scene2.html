<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>BioExplore</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component/dist/aframe-event-set-component.min.js"></script>
  <script src="https://unpkg.com/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
  <script src="/js/joystick.js"></script>
  <style>
    .ui-buttons {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10000;
      display: flex;
      gap: 10px;
    }

    .ui-button {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: 1px solid #3a7bd5;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .ui-button:hover {
      background: rgba(58, 123, 213, 0.9);
    }

    .ui-button i {
      font-size: 16px;
    }



    button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }

    #btnCalculate {
        background-color: #2e88ff;
        color: white;
    }

    #btnCalculate:hover {
        background-color: #7bdcff;
    }

    /* VR Button - Hidden */
    .a-enter-vr-button {
      display: none !important;
    }

    #custom-vr-btn {
      display: none !important;
    }

    /* Final Question Popup */
    .final-question-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(26, 26, 46, 0.98);
      border: 2px solid #4CC3D9;
      border-radius: 15px;
      padding: 30px;
      z-index: 10000;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      display: none;
    }

    .final-question-popup h3 {
      color: #4CC3D9;
      margin-bottom: 20px;
      text-align: center;
      font-size: 24px;
    }

    .question-item {
      margin-bottom: 20px;
      color: #ffffff;
    }

    .question-item p {
      margin-bottom: 10px;
      font-weight: bold;
    }

    .question-item input[type="radio"] {
      margin-right: 8px;
      margin-bottom: 8px;
    }

    .question-item textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #4CC3D9;
      border-radius: 5px;
      background: rgba(13, 21, 32, 0.8);
      color: #ffffff;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }

    .question-item label {
      display: block;
      margin-bottom: 5px;
      cursor: pointer;
    }

    #submitAnswer {
      background: #4CC3D9;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      width: 100%;
      margin-top: 20px;
      transition: background 0.3s;
    }

    #submitAnswer:hover {
      background: #7bdcff;
    }
  </style>
  <script>
    // Device Toggle Functionality
    function setupDeviceToggle() {
      const deviceToggle = document.getElementById('device-toggle');
      const mobileControls = document.getElementById('mobile-controls');
      const sceneEl = document.querySelector('a-scene');
      let joystick = null;

      // Update UI based on current device mode
      function updateDeviceUI() {
        const currentMode = localStorage.getItem('deviceType') || 'desktop';
        if (deviceToggle) {
          let icon, text;
          switch (currentMode) {
            case 'mobile':
              icon = 'üñ•Ô∏è';
              text = 'Switch to Desktop';
              break;
            default: // desktop
              icon = 'üì±';
              text = 'Switch to Mobile';
          }
          deviceToggle.innerHTML = `<i>${icon}</i><span>${text}</span>`;

          // Update mobile controls visibility
          if (mobileControls) {
            mobileControls.style.display = currentMode === 'mobile' ? 'block' : 'none';
          }
        }
      }

    }
  </script>
</head>
<body>

    <!-- Virtual Gamepad for Mobile -->
    <div id="mobile-controls" style="position: fixed; bottom: 30px; left: 20px; z-index: 1000; display: none; touch-action: none; -webkit-tap-highlight-color: transparent;">
      <!-- Joystick Control -->
      <div id="joystick" style="width: 120px; height: 120px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; position: relative; overflow: visible;">
        <div id="joystick-knob" style="width: 80px; height: 80px; background: rgba(255, 255, 255, 0.5); border-radius: 50%; position: absolute; left: 20px; top: 20px; transition: transform 0.1s ease-out; touch-action: none; pointer-events: none;"></div>
      </div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      style="height: 100vh;"
      renderer="antialias: false; sortObjects: false; colorManagement: false; physicallyCorrectLights: false; shadowMap: false; precision: mediump">
      
      
      <!-- Assets - Conditional Loading dengan Optimasi -->
      <a-assets timeout="30000">
        <img id="thumbScene1" crossorigin="anonymous" src="https://cdn.aframe.io/link-traversal/thumbs/forest.png" />
        
        <!-- GLB Models untuk Scene 2 - Prioritas Loading -->
        <!-- Model kecil di-load dulu -->
        <a-asset-item id="desk-model" src="assets/asset scene 2/Desk.glb"></a-asset-item>
        <a-asset-item id="bunsen-model" src="assets/asset scene 2/bunsen+burner.glb"></a-asset-item>
        <a-asset-item id="petri-model" src="assets/asset scene 2/Petri+dish.glb"></a-asset-item>
        <a-asset-item id="thermometer-model" src="assets/asset scene 2/LanzoTherm+3000.glb"></a-asset-item>
        <a-asset-item id="deodorant-model" src="assets/asset scene 2/axe_deodorant.glb"></a-asset-item>
        
        <!-- Model besar (57MB) - Lazy Load setelah scene ready -->
        <!-- cotton-jar akan di-load via JavaScript setelah model lain selesai -->
        
        <!-- Fallback untuk jika GLB tidak tersedia -->
        <a-mixin id="fallback-box"
                 geometry="primitive: box; width: 2; height: 1; depth: 1"
                 material="color: #8B4513"></a-mixin>
        <a-mixin id="fallback-ground" 
                 geometry="primitive: plane; width: 20; height: 20"
                 material="color: #228B22"
                 rotation="-90 0 0"></a-mixin>
      </a-assets>

      <a-entity id="environment"></a-entity>

      <a-entity id="fallback-environment">
        <a-plane
          position="0 0 0"
          rotation="-90 0 0"
          width="20"
          height="20"
          color="#228B22">
        </a-plane>
        
        <a-plane class="collidable" position="0 2 -10" width="20" height="4" color="#87CEEB"></a-plane>
        <a-plane class="collidable" position="-10 2 0" rotation="0 90 0" width="20" height="4" color="#87CEEB"></a-plane>
        <a-plane class="collidable" position="10 2 0" rotation="0 -90 0" width="20" height="4" color="#87CEEB"></a-plane>
      </a-entity>

      <!-- Laboratory Setup -->
      <a-entity id="laboratory-setup">
        
        <!-- Meja Laboratorium Utama - Disesuaikan ukurannya lebih kecil -->
        <a-entity
          id="main-desk"
          gltf-model="#desk-model"
          position="0 0 -3"
          rotation="0 0 0"
          scale="0.4 0.4 0.4"
          class="collidable"
          visible="true"
          frustum-culled="true">
        </a-entity>

        <!-- Pembakar Bunsen - Disesuaikan dengan meja yang lebih kecil -->
        <a-entity
          id="bunsen-burner"
          gltf-model="#bunsen-model"
          position="-0.15 0.3 -3"
          rotation="0 0 0"
          scale="0.2 0.2 0.2"
          class="clickable lab-equipment"
          data-action="toggle-bunsen"
          frustum-culled="true">
          <!-- Label - Disesuaikan posisi untuk ukuran baru -->
        <a-text
            value="Bunsen Burner"
            position="0 0.15 0"
          align="center"
            color="#fff"
            width="1.5"
            visible="false"
            id="bunsen-label"
            material="depthTest: false; transparent: true">
        </a-text>
        </a-entity>

        <!-- Cawan Petri - Disesuaikan dengan meja yang lebih kecil -->
        <a-entity
          id="petri-dish"
          gltf-model="#petri-model"
          position="0.1 0.3 -3"
          rotation="0 0 0"
          scale="0.15 0.15 0.15"
          class="clickable lab-equipment"
          data-action="apply-sample"
          frustum-culled="true">
          <!-- Label - Disesuaikan posisi untuk ukuran baru -->
        <a-text
            value="Petri Dish"
            position="0 0.15 0"
          align="center"
            color="#fff"
            width="1.5"
            visible="false"
            id="petri-label"
            material="depthTest: false; transparent: true">
        </a-text>
        </a-entity>

        <!-- Termometer - Disesuaikan dengan meja yang lebih kecil -->
        <a-entity
          id="thermometer"
          gltf-model="#thermometer-model"
          position="0.2 0.3 -3"
          rotation="0 0 0"
          scale="0.15 0.15 0.15"
          class="clickable lab-equipment"
          data-action="measure-temperature"
          frustum-culled="true">
          <!-- Label - Disesuaikan posisi untuk ukuran baru -->
          <a-text
            value="Thermometer"
            position="0 0.15 0"
            align="center"
            color="#fff"
            width="1.5"
            visible="false"
            id="thermometer-label"
            material="depthTest: false; transparent: true">
          </a-text>
          <!-- Temperature Display - Disesuaikan posisi -->
          <a-text
            id="temperature-display"
            value="Suhu: --¬∞C"
            position="0 0.3 0"
            align="center"
            color="#4CC3D9"
            width="1.5"
          visible="false"
            material="depthTest: false; transparent: true">
          </a-text>
          </a-entity>

        <!-- Toples Kapas - Lazy Load (Model besar 57MB) - Disesuaikan ukurannya lebih kecil -->
        <!-- Fallback box sementara, akan diganti setelah model loaded -->
          <a-entity
          id="cotton-jar"
          position="-0.7 0.2 -2.5"
          rotation="0 0 0"
          scale="0.3 0.3 0.3"
          class="clickable lab-equipment"
          data-action="take-sample">
          <!-- Fallback box sementara - Disesuaikan dengan scale baru -->
        <a-box
            id="cotton-jar-fallback"
            width="0.15"
            height="0.18"
          depth="0.15"
            color="#8B7355"
            material="metalness: 0.3; roughness: 0.7">
        </a-box>
          <!-- Label - Disesuaikan posisi untuk ukuran baru -->
        <a-text
            value="Cotton Swab"
            position="0 0.2 0"
          align="center"
            color="#fff"
            width="1.5"
            visible="false"
            id="cotton-label"
            material="depthTest: false; transparent: true">
        </a-text>
        </a-entity>

        <!-- Deodoran/Bahan Kimia - Disesuaikan ukurannya lebih kecil -->
        <a-entity
          id="deodorant"
          gltf-model="#deodorant-model"
          position="0.7 0.2 -2.5"
          rotation="0 0 0"
          scale="0.25 0.25 0.25"
          class="clickable lab-equipment"
          data-action="add-deodorant"
          frustum-culled="true">
          <!-- Label - Disesuaikan posisi untuk ukuran baru -->
        <a-text
            value="Deodorant"
            position="0 0.2 0"
          align="center"
            color="#fff"
            width="1.5"
            visible="false"
            id="deodorant-label"
            material="depthTest: false; transparent: true">
        </a-text>
        </a-entity>

        </a-entity>

      <!-- Portal Kembali ke Menu -->
      <a-link
        position="0 1.6 6"
        rotation="0 180 0"
        link="on: click"
        href="vr.html"
        title="Kembali ke Menu"
        image="#thumbScene1"
        class="clickable"
        event-set__mouseenter="material.opacity: 0.8"
        event-set__mouseleave="material.opacity: 0.6">
      </a-link>

      <!-- Sky dan pencahayaan - Minimal untuk performa -->
      <a-sky color="#87CEEB"></a-sky>
      <!-- Hanya ambient dan directional light untuk performa maksimal -->
      <a-light type="ambient" color="#404040" intensity="0.7"></a-light>
      <a-light type="directional" 
               position="5 10 5" 
               intensity="0.9">
      </a-light>
      
      <!-- Loading Indicator -->
      <a-entity id="loading-indicator" position="0 2 -2">
        <a-box
          width="3"
          height="0.3"
          depth="0.1"
          color="#1a1a2e"
          opacity="0.9">
          </a-box>
        <a-text
          id="loading-text"
          value="Loading assets..."
          position="0 0 0.06"
          align="center"
          color="#4CC3D9"
          width="4"
          material="depthTest: false; transparent: true">
        </a-text>
      </a-entity>

      <!-- Kamera dengan movement controls seperti di vr.html - Support sprint -->
      <a-entity
        id="rig"
        position="0 1.6 8"
        movement-controls="speed: 0.3; constrainToNavMesh: false; fly: false; acceleration: 65">
        <a-entity
          id="player"
          class="camera"
          camera
          position="0 0 0"
          look-controls="pointerLockEnabled: true; reverseMouseDrag: false"
          pointer-lock="enabled: true">
          <a-entity
            id="reticle"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.018; radiusOuter: 0.025"
            material="shader: flat; opacity: 0.9; color: #fff; depthTest: false"
            cursor="fuse: true; fuseTimeout: 1200"
            raycaster="objects: .clickable"
            animation__fuse="property: scale; startEvents: fusing; from: 1 1 1; to: 0.2 0.2 0.2; dur: 1200; easing: linear"
            animation__reset="property: scale; startEvents: mouseleave; to: 1 1 1; dur: 120">
          </a-entity>
      </a-entity>
        </a-entity>
        
      <!-- Instruction Panel -->
      <a-entity id="instruction-panel" position="0 2 -4" rotation="0 0 0">
        <!-- Background Panel -->
          <a-box 
          width="5"
          height="3.5"
          depth="0.1"
          color="#1a1a2e"
          opacity="0.95"
          material="metalness: 0.7; roughness: 0.3"
          class="collidable">
        </a-box>
        
        <!-- Border -->
        <a-box
          width="5.1"
          height="3.6"
          depth="0.05"
          position="0 0 -0.03"
          color="#4CC3D9"
            opacity="0.3"
          material="metalness: 0.8; roughness: 0.2">
            </a-box>
        
        <!-- Title -->
            <a-text
          value="KEGIATAN 2: EKSPERIMEN BIOLOGI"
          position="0 1.3 0.06"
              align="center"
          color="#4CC3D9"
          width="6"
            material="depthTest: false; transparent: true">
          </a-text>

        <!-- Instructions -->
          <a-text
          id="instruction-text"
          value="1. Ambil sampel menggunakan cotton swab\n2. Oleskan ke cawan petri\n3. Tambahkan deodoran\n4. Amati pertumbuhan bakteri"
          position="0 0.2 0.06"
            align="center"
              color="#ffffff"
                width="4.5"
          line-height="50"
          material="depthTest: false; transparent: true">
              </a-text>

        <!-- Start Button -->
              <a-box
          id="btnStartExperiment"
                class="clickable"
          width="2"
          height="0.5"
          depth="0.1"
          position="0 -1.1 0.06"
          color="#4CC3D9"
          material="metalness: 0.8; roughness: 0.2"
          event-set__mouseenter="scale:1.1 1.1 1.1; color:#7bdcff"
          event-set__mouseleave="scale:1 1 1; color:#4CC3D9">
              </a-box>
              <a-text
          value="MULAI EKSPERIMEN"
          position="0 -1.1 0.11"
                align="center"
                color="#ffffff"
            width="3"
          material="depthTest: false; transparent: true">
              </a-text>
            </a-entity>

      <!-- Observation Results (Initially Hidden) -->
      <a-entity id="observation-results" class="observation-content" visible="false">
        
        <!-- Result Panel Background -->
              <a-box
          width="6"
          height="4"
          depth="0.1"
          position="0 1.5 -5"
          color="#1a1a2e"
                opacity="0.95"
          material="metalness: 0.7; roughness: 0.3">
              </a-box>
        
        <!-- Title -->
              <a-text
          value="HASIL OBSERVASI"
          position="0 3  -4.95"
                align="center"
          color="#4CC3D9"
          width="5"
          material="depthTest: false; transparent: true">
              </a-text>
        
        <!-- Data Panel -->
          <a-box
          width="5"
          height="1.5"
            depth="0.05"
          position="0 0.5 -4.95"
          color="#0d1520"
          opacity="0.9">
          </a-box>
          <a-text
          id="experiment-data"
          value="Suhu: 37¬∞C\nWaktu Observasi: 24 jam\nHasil: Pertumbuhan bakteri berkurang setelah treatment"
          position="0 0.5 -4.9"
            align="center"
          color="#fff"
          width="4.5"
          line-height="50"
          material="depthTest: false; transparent: true">
              </a-text>
            </a-entity>

  </a-scene>

    <script>
    // Experiment State Management
    const experimentState = {
      step: 0, // 0: intro, 1: sampling, 2: culture, 3: treatment, 4: observation, 5: question
      sampleTaken: false,
      sampleApplied: false,
      deodorantAdded: false,
      bunsenOn: false,
      temperature: null,
      observationComplete: false
    };

      // Flag untuk cek apakah model berhasil dimuat
      let modelsLoaded = false;
      let blockAnimationState = 'idle';
      
    // Setup mobile controls
      function setupMobileControls() {
        const camera = document.querySelector('[camera]');
        const rig = document.getElementById('rig');

        if (!camera) {
          console.error('Camera element not found');
          return;
        }

        let joystick = null;
        const movementSpeed = 0.1;
        let isMobile = false;
        
        // Initialize joystick
        function initJoystick() {
          joystick = new JoyStick('joystick', {
            title: 'joystick',
            width: 150,
            height: 150,
            internalFillColor: 'rgba(255, 255, 255, 0.5)',
            internalLineWidth: 2,
            internalStrokeColor: '#FFFFFF',
            externalLineWidth: 2,
            externalStrokeColor: 'rgba(255, 255, 255, 0.3)',
            autoReturnToCenter: true
          }, function (stickData) {
            if (stickData.x !== 0 || stickData.y !== 0) {
              updateCameraMovement(stickData.x, stickData.y);
            }
          });
        }
        
        // Update camera movement based on joystick input
      // Menggunakan movement-controls jika tersedia, atau manual movement
        function updateCameraMovement(x, y) {
          if (!camera) return;
          
        const rig = document.getElementById('rig');
        if (!rig) return;
        
        // Coba gunakan movement-controls component jika tersedia
        if (rig.components && rig.components['movement-controls']) {
          // Gunakan movement-controls API untuk mobile
          const movementControls = rig.components['movement-controls'];
          const movementSpeed = 0.3; // Same as desktop
          const moveX = x * movementSpeed;
          const moveZ = y * movementSpeed;
          
          // Simulate keyboard input untuk movement-controls
          // Movement-controls akan handle movement secara otomatis
          const cameraEl = camera.object3D;
          const direction = new THREE.Vector3();
          cameraEl.getWorldDirection(direction);
          const forward = new THREE.Vector3(direction.x, 0, direction.z).normalize();
          const right = new THREE.Vector3();
          right.crossVectors(new THREE.Vector3(0, 1, 0), forward).normalize();
          
          const movement = new THREE.Vector3();
          movement.addScaledVector(forward, moveZ);
          movement.addScaledVector(right, moveX);
          
          // Apply movement langsung ke rig
          const currentPosition = rig.getAttribute('position');
          rig.setAttribute('position', {
            x: currentPosition.x + movement.x,
            y: currentPosition.y,
            z: currentPosition.z + movement.z
          });
        } else {
          // Fallback: manual movement
          const cameraEl = camera.object3D;
          const direction = new THREE.Vector3();
          cameraEl.getWorldDirection(direction);
          const forward = new THREE.Vector3(direction.x, 0, direction.z).normalize();
          const movementSpeed = 0.3; // Increased speed untuk mobile
          const moveX = x * movementSpeed;
          const moveZ = y * movementSpeed;
          
          const right = new THREE.Vector3();
          right.crossVectors(new THREE.Vector3(0, 1, 0), forward).normalize();
          
          const movement = new THREE.Vector3();
          movement.addScaledVector(forward, moveZ);
          movement.addScaledVector(right, moveX);
          
          const currentPosition = rig.getAttribute('position');
          rig.setAttribute('position', {
            x: currentPosition.x + movement.x,
            y: currentPosition.y,
            z: currentPosition.z + movement.z
          });
        }
        }
        
        // Show joystick for mobile devices
        function checkDeviceType() {
          const deviceType = localStorage.getItem('deviceType');
          isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

          console.log('Device type from localStorage:', deviceType);
          console.log('Is mobile device:', isMobile);

          // Show joystick if:
          // 1. User selected 'mobile' in localStorage, OR
          // 2. Device is detected as mobile (regardless of localStorage)
          if (deviceType === 'mobile' || isMobile) {
            console.log('Showing joystick for mobile device');
            document.getElementById('mobile-controls').style.display = 'block';
            initJoystick();
          } else {
            console.log('Hiding joystick for desktop');
            document.getElementById('mobile-controls').style.display = 'none';
          }
        }

        // Initialize mobile controls
        checkDeviceType();
        
        // Start animation loop for smooth movement
        function animate() {
          requestAnimationFrame(animate);
        }
        animate();
      }

      // Load models dan setup mobile controls setelah DOM ready
      document.addEventListener('DOMContentLoaded', () => {
        setupMobileControls();
      });

    // Player collider: Disabled untuk tidak mengganggu movement-controls
    // Movement-controls sudah memiliki built-in collision handling
    AFRAME.registerComponent('collider', {
      schema: { 
        distance: { default: 1.2 },
        debug: { default: false },
        enabled: { default: false } // Disabled by default
      },
      init: function () {
        // Nonaktifkan collider - movement-controls akan handle collision
        return;
      },
      tick: function (time, delta) {
        // Nonaktifkan - tidak melakukan collision check
        return;
      },
    });

    // Experiment Flow Management
    function initExperimentFlow() {
      // Start Experiment Button
      const startBtn = document.getElementById('btnStartExperiment');
      if (startBtn) {
        startBtn.addEventListener('click', function() {
          startExperiment();
        });
      }

      // Equipment Click Handlers
      document.querySelectorAll('.lab-equipment').forEach(equipment => {
        equipment.addEventListener('click', function() {
          const action = this.getAttribute('data-action');
          handleEquipmentAction(action, this);
        });

        // Show label on hover
        equipment.addEventListener('mouseenter', function() {
          const label = this.querySelector('[id$="-label"]');
          if (label) {
            label.setAttribute('visible', 'true');
          }
        });

        equipment.addEventListener('mouseleave', function() {
          const label = this.querySelector('[id$="-label"]');
          if (label) {
            label.setAttribute('visible', 'false');
          }
        });
      });
    }

    function startExperiment() {
      // Hide instruction panel
      const instructionPanel = document.getElementById('instruction-panel');
      if (instructionPanel) {
        instructionPanel.setAttribute('visible', 'false');
      }

      // Update state
      experimentState.step = 1;
      
      // Show feedback
      console.log('Eksperimen dimulai!');
      showMessage('Ambil sampel menggunakan cotton swab', 3000);
    }

    function handleEquipmentAction(action, element) {
      console.log('Equipment action:', action);
      
      switch(action) {
        case 'take-sample':
          takeSample(element);
          break;
        case 'apply-sample':
          applySample(element);
          break;
        case 'add-deodorant':
          addDeodorant(element);
          break;
        case 'toggle-bunsen':
          toggleBunsen(element);
          break;
        case 'measure-temperature':
          measureTemperature(element);
          break;
      }
    }

    function takeSample(element) {
      if (experimentState.sampleTaken) {
        showMessage('Sampel sudah diambil!', 2000);
        return;
      }

      experimentState.sampleTaken = true;
      experimentState.step = 2;
      
      // Visual feedback
      element.setAttribute('animation', 'property: scale; to: 0.9 0.9 0.9; dur: 200; easing: easeInOut');
        setTimeout(() => {
        element.setAttribute('animation', 'property: scale; to: 0.8 0.8 0.8; dur: 200; easing: easeInOut');
          }, 200);
      
      showMessage('Sampel berhasil diambil! Sekarang oleskan ke cawan petri.', 3000);
    }

    function applySample(element) {
      if (!experimentState.sampleTaken) {
        showMessage('Ambil sampel terlebih dahulu!', 2000);
        return;
      }

      if (experimentState.sampleApplied) {
        showMessage('Sampel sudah dioleskan!', 2000);
        return;
      }

      experimentState.sampleApplied = true;
      experimentState.step = 3;
      
      // Visual feedback
      element.setAttribute('animation', 'property: rotation; to: 0 0 5; dur: 300; easing: easeInOut');
          setTimeout(() => {
        element.setAttribute('animation', 'property: rotation; to: 0 0 0; dur: 300; easing: easeInOut');
      }, 300);
      
      showMessage('Sampel berhasil dioleskan! Tambahkan deodoran untuk treatment.', 3000);
    }

    function addDeodorant(element) {
      if (!experimentState.sampleApplied) {
        showMessage('Oleskan sampel terlebih dahulu!', 2000);
        return;
      }

      if (experimentState.deodorantAdded) {
        showMessage('Deodoran sudah ditambahkan!', 2000);
        return;
      }

      experimentState.deodorantAdded = true;
      experimentState.step = 4;
      
      // Visual feedback
      element.setAttribute('animation', 'property: position; to: 1.3 0.5 -2.5; dur: 500; easing: easeInOut');
      setTimeout(() => {
        element.setAttribute('animation', 'property: position; to: 1.5 0.5 -2.5; dur: 500; easing: easeInOut');
      }, 500);
      
      showMessage('Deodoran berhasil ditambahkan! Ukur suhu untuk melanjutkan.', 3000);
      
      // Auto show observation after delay
      setTimeout(() => {
        if (experimentState.temperature !== null) {
          showObservationResults();
        }
      }, 5000);
    }

    function toggleBunsen(element) {
      experimentState.bunsenOn = !experimentState.bunsenOn;
      
      // Visual feedback - add flame effect (simple)
      if (experimentState.bunsenOn) {
        // Add flame entity
        const flame = document.createElement('a-entity');
        flame.setAttribute('geometry', 'primitive: cylinder; radius: 0.05; height: 0.15');
        flame.setAttribute('material', 'color: #ff6600; emissive: #ff3300; emissiveIntensity: 1');
        flame.setAttribute('position', '0 0.1 0');
        element.appendChild(flame);
        showMessage('Bunsen burner dinyalakan!', 2000);
        } else {
        // Remove flame
        const flame = element.querySelector('[geometry="primitive: cylinder"]');
        if (flame) {
          flame.remove();
        }
        showMessage('Bunsen burner dimatikan!', 2000);
      }
    }

    function measureTemperature(element) {
      // Generate random temperature between 35-40¬∞C
      experimentState.temperature = (35 + Math.random() * 5).toFixed(1);
      
      // Show temperature display
      const tempDisplay = element.querySelector('#temperature-display');
      if (tempDisplay) {
        tempDisplay.setAttribute('value', `Suhu: ${experimentState.temperature}¬∞C`);
        tempDisplay.setAttribute('visible', 'true');
      }
      
      showMessage(`Suhu terukur: ${experimentState.temperature}¬∞C`, 2000);
      
      // If all steps complete, show observation
      if (experimentState.sampleTaken && experimentState.sampleApplied && experimentState.deodorantAdded) {
          setTimeout(() => {
          showObservationResults();
        }, 2000);
      }
    }

    function showObservationResults() {
      if (experimentState.observationComplete) return;
      
      experimentState.observationComplete = true;
      experimentState.step = 5;
      
      const observationResults = document.getElementById('observation-results');
      if (observationResults) {
        observationResults.setAttribute('visible', 'true');
        
        // Update data
        const dataText = document.getElementById('experiment-data');
        if (dataText && experimentState.temperature) {
          dataText.setAttribute('value', 
            `Suhu: ${experimentState.temperature}¬∞C\n` +
            `Waktu Observasi: 24 jam\n` +
            `Hasil: Pertumbuhan bakteri berkurang setelah treatment deodoran`
          );
        }
      }
      
      showMessage('Hasil observasi tersedia!', 3000);
      
      // Show final question after delay
          setTimeout(() => {
        showFinalQuestion();
      }, 5000);
    }

    function showFinalQuestion() {
      const popup = document.getElementById('finalQuestionPopup');
      if (popup) {
        popup.style.display = 'block';
      }
    }

    function showMessage(text, duration) {
      // Create temporary message entity
      const message = document.createElement('a-text');
      message.setAttribute('value', text);
      message.setAttribute('position', '0 2.5 -3');
      message.setAttribute('align', 'center');
      message.setAttribute('color', '#4CC3D9');
      message.setAttribute('width', '6');
      message.setAttribute('material', 'depthTest: false; transparent: true');
      message.setAttribute('id', 'temp-message');
      
      const scene = document.querySelector('a-scene');
      scene.appendChild(message);
      
        setTimeout(() => {
        const msg = document.getElementById('temp-message');
        if (msg) {
          msg.remove();
        }
      }, duration);
    }

    // Lazy Load Cotton Jar (57MB model) - Load setelah model lain selesai
    function loadCottonJarLazy() {
      const cottonJar = document.getElementById('cotton-jar');
      if (!cottonJar) return;

      // Check jika model kecil sudah loaded
      const checkModelsLoaded = () => {
        const assets = document.querySelector('a-assets');
        if (!assets) return false;

        // Check model kecil sudah loaded
        const smallModels = ['desk-model', 'bunsen-model', 'petri-model', 'thermometer-model', 'deodorant-model'];
        let allSmallLoaded = true;
        
        smallModels.forEach(modelId => {
          const asset = assets.querySelector(`#${modelId}`);
          if (asset && !asset.hasLoaded) {
            allSmallLoaded = false;
          }
        });

        return allSmallLoaded;
      };

      // Wait for small models to load first
      const waitForSmallModels = setInterval(() => {
        if (checkModelsLoaded()) {
          clearInterval(waitForSmallModels);
          
          // Update loading text
          const loadingText = document.getElementById('loading-text');
          if (loadingText) {
            loadingText.setAttribute('value', 'Loading cotton jar (large file)...');
          }

          // Load cotton jar model
          const cottonAsset = document.createElement('a-asset-item');
          cottonAsset.setAttribute('id', 'cotton-jar-model');
          cottonAsset.setAttribute('src', 'assets/asset scene 2/cotton+swab+jar.glb');
          
          const assetsContainer = document.querySelector('a-assets');
          if (assetsContainer) {
            assetsContainer.appendChild(cottonAsset);
            
            // Wait for cotton jar to load
            cottonAsset.addEventListener('loaded', () => {
              // Replace fallback with actual model
              const fallback = cottonJar.querySelector('#cotton-jar-fallback');
              if (fallback) {
                fallback.remove();
              }
              
              const gltfModel = document.createElement('a-entity');
              gltfModel.setAttribute('gltf-model', '#cotton-jar-model');
              // Scale sudah diatur di parent entity (0.5 0.5 0.5)
              cottonJar.appendChild(gltfModel);
              
              // Hide loading indicator
              const loadingIndicator = document.getElementById('loading-indicator');
              if (loadingIndicator) {
                loadingIndicator.setAttribute('visible', 'false');
              }
              
              console.log('Cotton jar model loaded successfully!');
            });

            cottonAsset.addEventListener('error', () => {
              console.warn('Cotton jar model failed to load, using fallback');
              const loadingIndicator = document.getElementById('loading-indicator');
              if (loadingIndicator) {
                loadingIndicator.setAttribute('visible', 'false');
              }
            });
          }
        }
      }, 500);

      // Timeout after 10 seconds
      setTimeout(() => {
        clearInterval(waitForSmallModels);
        const loadingIndicator = document.getElementById('loading-indicator');
        if (loadingIndicator) {
          loadingIndicator.setAttribute('visible', 'false');
        }
      }, 10000);
    }

    // Optimize rendering performance - Aggressive optimization
    function optimizeRendering() {
      const scene = document.querySelector('a-scene');
      if (!scene) return;

      // Wait for renderer to be ready
      scene.addEventListener('renderstart', () => {
        const renderer = scene.renderer;
        if (renderer) {
          // Enable frustum culling
          renderer.frustumCulled = true;
          
          // Disable shadows completely
          if (renderer.shadowMap) {
            renderer.shadowMap.enabled = false;
          }
          
          // Reduce pixel ratio untuk performa
          if (renderer.setPixelRatio) {
            const pixelRatio = Math.min(window.devicePixelRatio || 1, 1.5); // Max 1.5x
            renderer.setPixelRatio(pixelRatio);
          }
          
          // Set power preference untuk GPU
          if (renderer.setPowerPreference) {
            renderer.setPowerPreference('high-performance');
          }
        }
      });

      // Reduce texture quality dan optimize models
      const models = document.querySelectorAll('[gltf-model]');
      models.forEach(model => {
        model.addEventListener('model-loaded', function() {
          const object3D = this.object3D;
          if (object3D) {
            object3D.traverse(function(node) {
              if (node.isMesh) {
                // Disable shadows
                node.castShadow = false;
                node.receiveShadow = false;
                
                // Reduce material complexity
                if (node.material) {
                  if (Array.isArray(node.material)) {
                    node.material.forEach(mat => {
                      optimizeMaterial(mat);
                    });
                  } else {
                    optimizeMaterial(node.material);
                  }
                }
                
                // Simplify geometry jika memungkinkan
                if (node.geometry) {
                  node.geometry.computeBoundingSphere();
                }
              }
            });
          }
        });
      });
    }

    // Optimize material untuk performa
    function optimizeMaterial(material) {
      if (!material) return;
      
      // Disable features yang tidak perlu
      material.needsUpdate = false;
      
      // Reduce texture size
      if (material.map) {
        material.map.generateMipmaps = false;
        material.map.minFilter = THREE.LinearFilter; // Faster than LinearMipmapLinearFilter
        material.map.magFilter = THREE.LinearFilter;
      }
      
      // Simplify shader
      if (material.roughness !== undefined) {
        material.roughness = Math.max(0.5, material.roughness); // Reduce shader complexity
      }
    }

    // Frame rate limiting untuk konsistensi performa
    let lastFrameTime = 0;
    const targetFPS = 30; // Target 30 FPS untuk performa lebih baik
    const frameInterval = 1000 / targetFPS;

    function throttleRender() {
      const now = performance.now();
      const elapsed = now - lastFrameTime;
      
      if (elapsed < frameInterval) {
        return;
      }
      
      lastFrameTime = now - (elapsed % frameInterval);
    }

    // Sprint functionality - seperti di vr.html
    let isSprinting = false;
    
    function setupSprintControls() {
      // Wait for rig to be ready
      const scene = document.querySelector('a-scene');
      if (!scene) {
        setTimeout(setupSprintControls, 100);
                  return;
                }

      scene.addEventListener('loaded', function() {
        const rig = document.getElementById('rig');
        if (!rig) {
          setTimeout(setupSprintControls, 100);
          return;
        }
        
        // Listen for Shift key for sprint
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Shift' || e.keyCode === 16) {
            isSprinting = true;
            const rigEl = document.getElementById('rig');
            if (rigEl && rigEl.components && rigEl.components['movement-controls']) {
              // Increase speed untuk sprint (2x normal speed)
              rigEl.setAttribute('movement-controls', 'speed', 0.6);
              console.log('Sprint activated');
            }
          }
        });
        
        document.addEventListener('keyup', function(e) {
          if (e.key === 'Shift' || e.keyCode === 16) {
            isSprinting = false;
            const rigEl = document.getElementById('rig');
            if (rigEl && rigEl.components && rigEl.components['movement-controls']) {
              // Return to normal speed
              rigEl.setAttribute('movement-controls', 'speed', 0.3);
              console.log('Sprint deactivated');
          }
        }
      });

        console.log('Sprint controls initialized');
      });
    }

    // Initialize experiment flow after DOM loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Optimize rendering first
      optimizeRendering();
      
      // Setup sprint controls
      setupSprintControls();
      
      // Verify movement-controls setelah scene loaded
      const scene = document.querySelector('a-scene');
      function verifyMovement() {
        const rig = document.getElementById('rig');
        if (rig) {
          console.log('‚úì Rig element found');
          if (rig.components && rig.components['movement-controls']) {
            console.log('‚úì Movement-controls component active');
            console.log('  Speed:', rig.getAttribute('movement-controls').speed);
            console.log('  Fly:', rig.getAttribute('movement-controls').fly);
          } else {
            console.error('‚úó Movement-controls component NOT found!');
          }
        } else {
          console.error('‚úó Rig element NOT found!');
        }
      }
      
      if (scene && scene.hasLoaded) {
        setTimeout(verifyMovement, 1000);
      } else {
        scene.addEventListener('loaded', () => {
          setTimeout(verifyMovement, 1000);
        });
      }
      
      // Start lazy loading cotton jar
            setTimeout(() => {
        loadCottonJarLazy();
      }, 500);
      
      // Initialize experiment flow
          setTimeout(() => {
        initExperimentFlow();
          }, 1000);
    });

    // Hide loading indicator when scene is ready
    document.querySelector('a-scene').addEventListener('loaded', () => {
      // Check if small models are loaded
            setTimeout(() => {
        const assets = document.querySelector('a-assets');
        if (assets) {
          const smallModels = ['desk-model', 'bunsen-model', 'petri-model', 'thermometer-model', 'deodorant-model'];
          let allLoaded = true;
          
          smallModels.forEach(modelId => {
            const asset = assets.querySelector(`#${modelId}`);
            if (asset && !asset.hasLoaded) {
              allLoaded = false;
            }
          });
          
          if (allLoaded) {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator && !document.getElementById('cotton-jar-model')) {
              // Only hide if cotton jar hasn't started loading yet
              const loadingText = document.getElementById('loading-text');
              if (loadingText) {
                loadingText.setAttribute('value', 'Loading cotton jar...');
              }
            }
          }
        }
      }, 2000);
    });

    // Info untuk pengguna
    console.log('BioExplore loaded successfully!');
    console.log('If GLB models fail to load due to CORS, fallback models will be used.');
    console.log('To use GLB models properly, serve this file from a local server (e.g., Live Server extension)');

  </script>

  <!-- Final Question Popup -->
  <div id="finalQuestionPopup" class="final-question-popup">
    <h3>Pertanyaan Evaluasi</h3>
    <div class="question-item">
      <p>1. Apa yang terjadi pada bakteri setelah diberi deodoran?</p>
      <label><input type="radio" name="q1" value="a"> A. Bakteri mati</label>
      <label><input type="radio" name="q1" value="b"> B. Bakteri berkembang</label>
      <label><input type="radio" name="q1" value="c"> C. Bakteri tidak berubah</label>
    </div>
    <div class="question-item">
      <p>2. Mengapa deodoran dapat mempengaruhi pertumbuhan bakteri?</p>
      <textarea id="answer2" rows="3" placeholder="Jawab di sini..."></textarea>
    </div>
    <button id="submitAnswer" onclick="submitAnswers()">Submit</button>
  </div>

  <script>
    function submitAnswers() {
      const q1 = document.querySelector('input[name="q1"]:checked');
      const q2 = document.getElementById('answer2').value;
      
      if (!q1 || !q2) {
        alert('Silakan jawab semua pertanyaan!');
        return;
      }
      
      console.log('Jawaban Q1:', q1.value);
      console.log('Jawaban Q2:', q2);
      
      // Hide popup
      document.getElementById('finalQuestionPopup').style.display = 'none';
      
      // Show completion message
      showMessage('Terima kasih! Eksperimen selesai.', 3000);
    }
  </script>
</body>

</html>
