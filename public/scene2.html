<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>BioExplore</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component/dist/aframe-event-set-component.min.js"></script>
  <script src="https://unpkg.com/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
  <script src="/js/joystick.js"></script>
  <style>
    .ui-buttons {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10000;
      display: flex;
      gap: 10px;
    }

    .ui-button {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: 1px solid #3a7bd5;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .ui-button:hover {
      background: rgba(58, 123, 213, 0.9);
    }

    .ui-button i {
      font-size: 16px;
    }

    /* VR mode styles */
    .vr-mode .ui-button {
      z-index: 10001;
    }

    /* Hide UI elements in VR mode */
    .vr-mode .ui-buttons:not(.vr-visible) {
      display: none;
    }


    button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }

    #btnCalculate {
        background-color: #2e88ff;
        color: white;
    }

    #btnCalculate:hover {
        background-color: #7bdcff;
    }

    /* VR Button Repositioning - Kanan Tengah Layar */
    .a-enter-vr-button {
      right: 20px !important;
      bottom: auto !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      width: 70px !important;
      height: 70px !important;
      border-radius: 50% !important;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      border: 3px solid rgba(255,255,255,0.3) !important;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4) !important;
      transition: all 0.3s ease !important;
      z-index: 9999 !important;
    }

    .a-enter-vr-button:hover {
      transform: translateY(-50%) scale(1.1) !important;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6) !important;
    }

    /* Custom VR Button for better accessibility */
    #custom-vr-btn {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 9998;
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      transition: all 0.3s ease;
      border: 3px solid rgba(255,255,255,0.3);
    }

    #custom-vr-btn:hover {
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    #custom-vr-btn:active {
      transform: translateY(-50%) scale(0.95);
    }

    #custom-vr-btn span {
      font-size: 36px;
      user-select: none;
    }

    /* Hide custom button when in VR mode */
    body.vr-mode #custom-vr-btn {
      display: none;
    }
  </style>
  <script>
    // Device Toggle Functionality
    function setupDeviceToggle() {
      const deviceToggle = document.getElementById('device-toggle');
      const mobileControls = document.getElementById('mobile-controls');
      const sceneEl = document.querySelector('a-scene');
      let joystick = null;

      // Update UI based on current device mode
      function updateDeviceUI() {
        const currentMode = localStorage.getItem('deviceType') || 'desktop';
        if (deviceToggle) {
          let icon, text;
          switch (currentMode) {
            case 'mobile':
              icon = 'üñ•Ô∏è';
              text = 'Switch to Desktop';
              break;
            case 'vr':
              icon = 'üñ•Ô∏è';
              text = 'Switch to Desktop';
              break;
            default: // desktop
              icon = 'üéÆ';
              text = 'Switch to VR';
          }
          deviceToggle.innerHTML = `<i>${icon}</i><span>${text}</span>`;

          // Update mobile controls visibility
          if (mobileControls) {
            mobileControls.style.display = currentMode === 'mobile' ? 'block' : 'none';
          }
        }
      }

      // Enter VR mode
      function enterVR() {
        if (sceneEl) {
          document.body.classList.add('vr-mode');
          if (sceneEl.hasAttribute('vr-mode-ui')) {
            sceneEl.setAttribute('vr-mode-ui', 'enabled: true');
          }
          if (mobileControls) mobileControls.style.display = 'none';
        }
      }

      // Exit VR mode
      function exitVR() {
        if (sceneEl && sceneEl.is('vr-mode')) {
          sceneEl.exitVR();
        }
        document.body.classList.remove('vr-mode');
      }
    }
  </script>
</head>
<body>
    <!-- Custom VR Button - Kanan Tengah -->
    <div id="custom-vr-btn" title="Enter VR Mode">
      <span>ü•Ω</span>
    </div>

    <!-- Virtual Gamepad for Mobile -->
    <div id="mobile-controls" style="position: fixed; bottom: 30px; left: 20px; z-index: 1000; display: none; touch-action: none; -webkit-tap-highlight-color: transparent;">
      <!-- Joystick Control -->
      <div id="joystick" style="width: 120px; height: 120px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; position: relative; overflow: visible;">
        <div id="joystick-knob" style="width: 80px; height: 80px; background: rgba(255, 255, 255, 0.5); border-radius: 50%; position: absolute; left: 20px; top: 20px; transition: transform 0.1s ease-out; touch-action: none; pointer-events: none;"></div>
      </div>
    </div>

    <a-scene
      vr-mode-ui="enabled: true"
      embedded
      style="height: 100vh;"
      renderer="physicallyCorrectLights: true"
      physics="gravity: -9.8; debug: false">
      
      
      <!-- Assets - Conditional Loading -->
      <a-assets timeout="10000">
        <img id="thumbScene1" crossorigin="anonymous" src="https://cdn.aframe.io/link-traversal/thumbs/forest.png" />
        
        <!-- Audio assets untuk efek suara -->
        <audio id="collisionSound" crossorigin="anonymous" preload="auto">
          <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+r1yW8iCz5/yPTMgSUFK3nO9d2ONgcXZLjr6qaUGBBIo+3zxm0hCTp+wvLNfSMDL4TP9diALgUlcs7y2W4jBy+N0PLUbCEGMYnZ8c1wJAAzdNrz0G8gBSyCzfPLdSIEO5DV79JlGgU/jNXux2EaBC+N0vHKdCMCMnPN8tV3JQQM0Pb4rFA" type="audio/wav">
        </audio>

        <!-- Additional audio for damage effects -->
        <audio id="crackSound" crossorigin="anonymous" preload="auto">
          <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+r1yW8iCz5/yPTMgSUFK3nO9d2ONgcXZLjr6qaUGBBIo+3zxm0hCTp+wvLNfSMDL4TP9diALgUlcs7y2W4jBy+N0PLUbCEGMYnZ8c1wJAAzdNrz0G8gBSyCzfPLdSIEO5DV79JlGgU/jNXux2EaBC+N0vHKdCMCMnPN8tV3JQQM0Pb4rFA" type="audio/wav">
        </audio>

        <audio id="breakSound" crossorigin="anonymous" preload="auto">
          <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+r1yW8iCz5/yPTMgSUFK3nO9d2ONgcXZLjr6qaUGBBIo+3zxm0hCTp+wvLNfSMDL4TP9diALgUlcs7y2W4jBy+N0PLUbCEGMYnZ8c1wJAAzdNrz0G8gBSyCzfPLdSIEO5DV79JlGgU/jNXux2EaBC+N0vHKdCMCMnPN8tV3JQQM0Pb4rFA" type="audio/wav">
        </audio>

        <audio id="demoSound" crossorigin="anonymous" preload="auto">
          <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+r1yW8iCz5/yPTMgSUFK3nO9d2ONgcXZLjr6qaUGBBIo+3zxm0hCTp+wvLNfSMDL4TP9diALgUlcs7y2W4jBy+N0PLUbCEGMYnZ8c1wJAAzdNrz0G8gBSyCzfPLdSIEO5DV79JlGgU/jNXux2EaBC+N0vHKdCMCMnPN8tV3JQQM0Pb4rFA" type="audio/wav">
        </audio>
        
        <!-- Fallback untuk jika GLB tidak tersedia -->
        <a-mixin id="fallback-box"
                 geometry="primitive: box; width: 2; height: 1; depth: 1"
                 material="color: #8B4513"></a-mixin>
        <a-mixin id="fallback-ground" 
                 geometry="primitive: plane; width: 20; height: 20"
                 material="color: #228B22"
                 rotation="-90 0 0"></a-mixin>
      </a-assets>

      <a-entity id="environment"></a-entity>

      <a-entity id="fallback-environment">
        <a-plane
          position="0 0 0"
          rotation="-90 0 0"
          width="20"
          height="20"
          color="#228B22"
          shadow="receive: true">
        </a-plane>
        
        <a-plane class="collidable" position="0 2 -10" width="20" height="4" color="#87CEEB"></a-plane>
        <a-plane class="collidable" position="-10 2 0" rotation="0 90 0" width="20" height="4" color="#87CEEB"></a-plane>
        <a-plane class="collidable" position="10 2 0" rotation="0 -90 0" width="20" height="4" color="#87CEEB"></a-plane>
      </a-entity>

      <!-- Portal Kembali ke Menu -->
      <a-link
        position="0 1.6 6"
        rotation="0 180 0"
        link="on: click"
        href="vr.html"
        title="Kembali ke Menu"
        image="#thumbScene1"
        class="clickable"
        event-set__mouseenter="material.opacity: 0.8"
        event-set__mouseleave="material.opacity: 0.6">
      </a-link>

      <!-- Sky dan pencahayaan -->
      <a-sky color="#87CEEB"></a-sky>
      <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
      <a-light type="directional" 
               position="5 10 5" 
               intensity="0.6"
               shadow="cast: true; mapSize: 2048">
      </a-light>
      
      <!-- Collision flash light untuk dramatic effect -->
      <a-light id="collisionFlash"
               type="point" 
               position="0 0.3 -3" 
               intensity="0"
               color="#FFD700"
               distance="10"
               decay="2">
      </a-light>

      <!-- Compact 3D Friction Force Control Panel -->
      <a-entity id="friction-panel-3d" position="-5 3.5 -4.5" rotation="0 30 0" visible="false">
        <!-- Main Panel Frame with Depth -->
        <a-box
          id="panel-frame"
          width="4.5"
          height="6.5"
          depth="0.15"
          color="#2a2a2a"
          opacity="0.95"
          shadow="cast: true; receive: true"
          class="clickable">
        </a-box>

        <!-- Panel Border for 3D Effect -->
        <a-box
          width="4.7"
          height="6.7"
          depth="0.1"
          color="#1a1a1a"
          opacity="0.8"
          position="0 0 -0.05">
        </a-box>


        <!-- Panel Title -->
        <a-text
          value="SIMULASI GAYA GESEK"
          position="0 2.9 0.3"
          align="center"
          color="#00E676"
          font="kelsonsans"
          width="6">
        </a-text>

        <!-- Input Controls Section -->
        <a-box
          width="4.2"
          height="4.8"
          depth="0.05"
          color="#333333"
          opacity="0.9"
          position="0 0.8 0.08">
        </a-box>

        <!-- Massa Controls -->
        <a-text
          value="Massa Balok (kg)"
          position="0 2.4 0.12"
          align="center"
          color="#FFC107"
          font="kelsonsans"
          width="5">
        </a-text>

        <a-box
          id="massa-minus"
          width="0.25"
          height="0.25"
          depth="0.08"
          color="#FF5722"
          position="-1.2 2.0 0.12"
          class="clickable"
          cursor-listener
          event-set__mouseenter="color: #FF7043"
          event-set__mouseleave="color: #FF5722"
          shadow="cast: true">
          <a-text
            value="-"
            position="0 0 0.05"
            align="center"
            color="white"
            font="kelsonsans"
            width="10">
          </a-text>
        </a-box>

        <a-box
          width="1.2"
          height="0.25"
          depth="0.05"
          color="#1e1e1e"
          position="0 2.0 0.1">
          <a-text
            id="massa-display"
            value="5"
            position="0 0 0.03"
            align="center"
            color="#4CAF50"
            font="kelsonsans"
            width="6">
          </a-text>
        </a-box>

        <a-box
          id="massa-plus"
          width="0.25"
          height="0.25"
          depth="0.08"
          color="#4CAF50"
          position="1.2 2.0 0.12"
          class="clickable"
          cursor-listener
          event-set__mouseenter="color: #66BB6A"
          event-set__mouseleave="color: #4CAF50"
          shadow="cast: true">
          <a-text
            value="+"
            position="0 0 0.05"
            align="center"
            color="white"
            font="kelsonsans"
            width="10">
          </a-text>
        </a-box>

        <!-- Gaya Tarik Controls -->
        <a-text
          value="Gaya Tarik (N)"
          position="0 1.6 0.12"
          align="center"
          color="#FFC107"
          font="kelsonsans"
          width="5">
        </a-text>

        <a-box
          id="gaya-tarik-minus"
          width="0.25"
          height="0.25"
          depth="0.08"
          color="#FF5722"
          position="-1.2 1.2 0.12"
          class="clickable"
          cursor-listener
          event-set__mouseenter="color: #FF7043"
          event-set__mouseleave="color: #FF5722"
          shadow="cast: true">
          <a-text
            value="-"
            position="0 0 0.05"
            align="center"
            color="white"
            font="kelsonsans"
            width="10">
          </a-text>
        </a-box>

        <a-box
          width="1.2"
          height="0.25"
          depth="0.05"
          color="#1e1e1e"
          position="0 1.2 0.1">
          <a-text
            id="gaya-tarik-display"
            value="0"
            position="0 0 0.03"
            align="center"
            color="#4CAF50"
            font="kelsonsans"
            width="6">
          </a-text>
        </a-box>

        <a-box
          id="gaya-tarik-plus"
          width="0.25"
          height="0.25"
          depth="0.08"
          color="#4CAF50"
          position="1.2 1.2 0.12"
          class="clickable"
          cursor-listener
          event-set__mouseenter="color: #66BB6A"
          event-set__mouseleave="color: #4CAF50"
          shadow="cast: true">
          <a-text
            value="+"
            position="0 0 0.05"
            align="center"
            color="white"
            font="kelsonsans"
            width="10">
          </a-text>
        </a-box>

        <!-- Koefisien Statis Controls -->
        <a-text
          value="Koefisien Statis (Œºs)"
          position="0 0.8 0.12"
          align="center"
          color="#FFC107"
          font="kelsonsans"
          width="5">
        </a-text>

        <a-box
          id="koef-statis-minus"
          width="0.25"
          height="0.25"
          depth="0.08"
          color="#FF5722"
          position="-1.2 0.4 0.12"
          class="clickable"
          cursor-listener
          event-set__mouseenter="color: #FF7043"
          event-set__mouseleave="color: #FF5722"
          shadow="cast: true">
          <a-text
            value="-"
            position="0 0 0.05"
            align="center"
            color="white"
            font="kelsonsans"
            width="10">
          </a-text>
        </a-box>

        <a-box
          width="1.2"
          height="0.25"
          depth="0.05"
          color="#1e1e1e"
          position="0 0.4 0.1">
          <a-text
            id="koef-statis-display"
            value="0.5"
            position="0 0 0.03"
            align="center"
            color="#4CAF50"
            font="kelsonsans"
            width="6">
          </a-text>
        </a-box>

        <a-box
          id="koef-statis-plus"
          width="0.25"
          height="0.25"
          depth="0.08"
          color="#4CAF50"
          position="1.2 0.4 0.12"
          class="clickable"
          cursor-listener
          event-set__mouseenter="color: #66BB6A"
          event-set__mouseleave="color: #4CAF50"
          shadow="cast: true">
          <a-text
            value="+"
            position="0 0 0.05"
            align="center"
            color="white"
            font="kelsonsans"
            width="10">
          </a-text>
        </a-box>

        <!-- Koefisien Kinetis Controls -->
        <a-text
          value="Koefisien Kinetis (Œºk)"
          position="0 0.0 0.12"
          align="center"
          color="#FFC107"
          font="kelsonsans"
          width="5">
        </a-text>

        <a-box
          id="koef-kinetis-minus"
          width="0.25"
          height="0.25"
          depth="0.08"
          color="#FF5722"
          position="-1.2 -0.4 0.12"
          class="clickable"
          cursor-listener
          event-set__mouseenter="color: #FF7043"
          event-set__mouseleave="color: #FF5722"
          shadow="cast: true">
          <a-text
            value="-"
            position="0 0 0.05"
            align="center"
            color="white"
            font="kelsonsans"
            width="10">
          </a-text>
        </a-box>

        <a-box
          width="1.2"
          height="0.25"
          depth="0.05"
          color="#1e1e1e"
          position="0 -0.4 0.1">
          <a-text
            id="koef-kinetis-display"
            value="0.3"
            position="0 0 0.03"
            align="center"
            color="#4CAF50"
            font="kelsonsans"
            width="6">
          </a-text>
        </a-box>

        <a-box
          id="koef-kinetis-plus"
          width="0.25"
          height="0.25"
          depth="0.08"
          color="#4CAF50"
          position="1.2 -0.4 0.12"
          class="clickable"
          cursor-listener
          event-set__mouseenter="color: #66BB6A"
          event-set__mouseleave="color: #4CAF50"
          shadow="cast: true">
          <a-text
            value="+"
            position="0 0 0.05"
            align="center"
            color="white"
            font="kelsonsans"
            width="10">
          </a-text>
        </a-box>

        <!-- Calculate Button -->
        <a-box
          id="calculate-btn-3d"
          width="2.5"
          height="0.4"
          depth="0.1"
          color="#2196F3"
          position="0 -1.0 0.12"
          class="clickable"
          cursor-listener
          event-set__mouseenter="color: #42A5F5"
          event-set__mouseleave="color: #2196F3"
          shadow="cast: true">
          <a-text
            value="KALKULASI & ANIMASIKAN"
            position="0 0 0.05"
            align="center"
            color="white"
            font="kelsonsans"
            width="6">
          </a-text>
        </a-box>



        <!-- Result Display Panel -->
        <a-box
          id="result-panel-3d"
          width="5.5"
          height="3.5"
          depth="0.15"
          color="#1a1a1a"
          position="-5 -1 4"
          rotation="0 50 0"
          opacity="0.95"
          visible="false"
          shadow="cast: true; receive: true">

          <!-- Header Background -->
          <a-box
            width="5.3"
            height="0.4"
            depth="0.05"
            color="#00E676"
            opacity="0.2"
            position="0 1.45 0.05">
          </a-box>

          <a-text
            value="HASIL KALKULASI"
            position="0 1.45 0.08"
            align="center"
            color="#00E676"
            font="kelsonsans"
            width="6">
          </a-text>

          <!-- Separator Line -->
          <a-box
            width="5.0"
            height="0.02"
            depth="0.03"
            color="#00E676"
            opacity="0.5"
            position="0 1.15 0.08">
          </a-box>

          <!-- Background boxes untuk setiap baris hasil -->
          <a-box
            width="5.0"
            height="0.45"
            depth="0.04"
            color="#2a2a2a"
            opacity="0.8"
            position="0 0.7 0.06">
          </a-box>

          <a-box
            width="5.0"
            height="0.45"
            depth="0.04"
            color="#2a2a2a"
            opacity="0.8"
            position="0 0.15 0.06">
          </a-box>

          <a-box
            width="5.0"
            height="0.45"
            depth="0.04"
            color="#2a2a2a"
            opacity="0.8"
            position="0 -0.4 0.06">
          </a-box>

          <a-box
            width="5.0"
            height="0.45"
            depth="0.04"
            color="#2a2a2a"
            opacity="0.8"
            position="0 -0.95 0.06">
          </a-box>

          <a-box
            width="5.0"
            height="0.45"
            depth="0.04"
            color="#2a2a2a"
            opacity="0.8"
            position="0 -1.5 0.06">
          </a-box>

          <!-- Elemen hasil menggunakan entity agar bisa switch antara text dan canvas texture -->
          <a-entity
            id="result-normal-3d"
            position="0 0.7 0.08">
          </a-entity>

          <a-entity
            id="result-fsmax-3d"
            position="0 0.15 0.08">
          </a-entity>

          <a-entity
            id="result-fk-3d"
            position="0 -0.4 0.08">
          </a-entity>

          <a-entity
            id="result-kesimpulan-3d"
            position="0 -0.95 0.08">
          </a-entity>

          <a-entity
            id="result-percepatan-3d"
            position="0 -1.5 0.08">
          </a-entity>

        </a-box>

      </a-entity>

      <!-- Template Values Panel - Right Side of Control Panel -->
      <a-entity id="template-panel-3d" position="5 3.5 -5" rotation="0 -30 0" visible="false">
        <!-- Main Panel Frame with Depth -->
        <a-box
          id="template-panel-frame"
          width="3.5"
          height="6.5"
          depth="0.15"
          color="#2a2a2a"
          opacity="0.95"
          shadow="cast: true; receive: true"
          class="clickable">
        </a-box>

        <!-- Panel Border for 3D Effect -->
        <a-box
          width="3.7"
          height="6.7"
          depth="0.1"
          color="#1a1a1a"
          opacity="0.8"
          position="0 0 -0.05">
        </a-box>

        <!-- Panel Title -->
        <a-text
          value="TEMPLATE NILAI"
          position="0 2.9 0.3"
          align="center"
          color="#00E676"
          font="kelsonsans"
          width="5">
        </a-text>

        <!-- Massa Template Section -->
        <a-text
          value="Massa (kg)"
          position="0 2.2 0.12"
          align="center"
          color="#9C27B0"
          font="kelsonsans"
          width="4">
        </a-text>

        <!-- Massa Template Buttons - Row 1: 5, 10, 15, 20, 25 -->
        <a-entity position="0 1.8 0">
          <a-box id="massa-tmpl-5" width="0.55" height="0.25" depth="0.08" color="#9C27B0" position="-1.26 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #BA68C8" event-set__mouseleave="color: #9C27B0" shadow="cast: true">
            <a-text value="5" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="massa-tmpl-10" width="0.55" height="0.25" depth="0.08" color="#9C27B0" position="-0.63 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #BA68C8" event-set__mouseleave="color: #9C27B0" shadow="cast: true">
            <a-text value="10" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="massa-tmpl-15" width="0.55" height="0.25" depth="0.08" color="#9C27B0" position="0 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #BA68C8" event-set__mouseleave="color: #9C27B0" shadow="cast: true">
            <a-text value="15" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="massa-tmpl-20" width="0.55" height="0.25" depth="0.08" color="#9C27B0" position="0.63 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #BA68C8" event-set__mouseleave="color: #9C27B0" shadow="cast: true">
            <a-text value="20" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="massa-tmpl-25" width="0.55" height="0.25" depth="0.08" color="#9C27B0" position="1.26 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #BA68C8" event-set__mouseleave="color: #9C27B0" shadow="cast: true">
            <a-text value="25" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
        </a-entity>

        <!-- Massa Template Buttons - Row 2: 30, 35, 40, 45, 50 -->
        <a-entity position="0 1.4 0">
          <a-box id="massa-tmpl-30" width="0.55" height="0.25" depth="0.08" color="#9C27B0" position="-1.26 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #BA68C8" event-set__mouseleave="color: #9C27B0" shadow="cast: true">
            <a-text value="30" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="massa-tmpl-35" width="0.55" height="0.25" depth="0.08" color="#9C27B0" position="-0.63 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #BA68C8" event-set__mouseleave="color: #9C27B0" shadow="cast: true">
            <a-text value="35" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="massa-tmpl-40" width="0.55" height="0.25" depth="0.08" color="#9C27B0" position="0 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #BA68C8" event-set__mouseleave="color: #9C27B0" shadow="cast: true">
            <a-text value="40" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="massa-tmpl-45" width="0.55" height="0.25" depth="0.08" color="#9C27B0" position="0.63 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #BA68C8" event-set__mouseleave="color: #9C27B0" shadow="cast: true">
            <a-text value="45" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="massa-tmpl-50" width="0.55" height="0.25" depth="0.08" color="#9C27B0" position="1.26 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #BA68C8" event-set__mouseleave="color: #9C27B0" shadow="cast: true">
            <a-text value="50" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
        </a-entity>

        <!-- Separator Line -->
        <a-box
          width="3.2"
          height="0.02"
          depth="0.05"
          color="#00E676"
          opacity="0.5"
          position="0 1.1 0.12">
        </a-box>

        <!-- Gaya Tarik Template Section -->
        <a-text
          value="Gaya Tarik (N)"
          position="0 0.7 0.12"
          align="center"
          color="#FF6F00"
          font="kelsonsans"
          width="4">
        </a-text>

        <!-- Gaya Tarik Template Buttons - Row 1: 0, 10, 20, 30, 40, 50 -->
        <a-entity position="0 0.3 0">
          <a-box id="gaya-tmpl-0" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="-1.4 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="0" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="gaya-tmpl-10" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="-0.84 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="10" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="gaya-tmpl-20" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="-0.28 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="20" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="gaya-tmpl-30" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="0.28 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="30" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="gaya-tmpl-40" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="0.84 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="40" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="gaya-tmpl-50" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="1.4 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="50" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
        </a-entity>

        <!-- Gaya Tarik Template Buttons - Row 2: 75, 100, 125, 150 -->
        <a-entity position="0 -0.1 0">
          <a-box id="gaya-tmpl-75" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="-0.84 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="75" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="gaya-tmpl-100" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="-0.28 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="100" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="gaya-tmpl-125" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="0.28 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="125" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="gaya-tmpl-150" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="0.84 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="150" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
        </a-entity>

        <!-- Gaya Tarik Template Buttons - Row 3: 175, 200 (centered) -->
        <a-entity position="0 -0.5 0">
          <a-box id="gaya-tmpl-175" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="-0.28 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="175" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
          <a-box id="gaya-tmpl-200" width="0.48" height="0.25" depth="0.08" color="#FF6F00" position="0.28 0 0.12" class="clickable" cursor-listener event-set__mouseenter="color: #FF9800" event-set__mouseleave="color: #FF6F00" shadow="cast: true">
            <a-text value="200" position="0 0 0.05" align="center" color="white" font="kelsonsans" width="5"></a-text>
          </a-box>
        </a-entity>

        <!-- Info Text -->
        <a-text
          value="Klik untuk set nilai"
          position="0 -1.2 0.12"
          align="center"
          color="#888888"
          font="kelsonsans"
          width="3">
        </a-text>

      </a-entity>

      <!-- Kamera dengan gaze cursor -->
      <a-entity
        id="rig"
        collider="distance: 0.3"
        camera
        look-controls
        wasd-controls
        position="0 1.6 8"
        kinematic-body="radius: 0.3; height: 1.6;"
        sphere-collider="radius: 0.3">
          <a-entity
            id="reticle"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.018; radiusOuter: 0.025"
            material="shader: flat; opacity: 0.9; color: #fff; depthTest: false"
            cursor="fuse: true; fuseTimeout: 1200"
            raycaster="objects: .clickable"
            animation__fuse="property: scale; startEvents: fusing; from: 1 1 1; to: 0.2 0.2 0.2; dur: 1200; easing: linear"
            animation__reset="property: scale; startEvents: mouseleave; to: 1 1 1; dur: 120">
          </a-entity>
      </a-entity>
      
      <!-- Main Menu -->
      <a-entity id="mainmenu">
        <a-text 
          value="PILIH SIMULASI BIOLOGI"
          position="0 2.3 -0.5"
          align="center"
          color="white"
          width="8"
          scale="1.5 1.5 1.5"
          material="depthTest: false; transparent: true"
          geometry="primitive: plane; width: auto; height: auto"
          text="shader: msdf; font: roboto">
        </a-text>
        
        <a-entity position="-0.8 1.4 -0.5" rotation="0 0 0">
          <a-box 
            id="btnBab2" 
            class="clickable"
            depth="0.1" 
            height="0.8" 
            width="1.2" 
            color="#2e88ff"
            material="depthTest: true"
            event-set__enter="_event: mouseenter; scale:1.06 1.06 1.06; color:#7bdcff"
            event-set__leave="_event: mouseleave; scale:1 1 1; color:#2e88ff">
          </a-box>
          <a-text 
            value="Gaya Gesek" 
            color="#fff" 
            align="center" 
            width="4" 
            position="0 0 0.06"
            material="depthTest: false; transparent: true">
          </a-text>
        </a-entity>
        
        <a-entity position="0.8 1.4 -0.5" rotation="0 0 0">
          <a-box 
            id="btnBab3" 
            class="clickable"
            depth="0.1" 
            height="0.8" 
            width="1.2" 
            color="#2e88ff"
            material="depthTest: true"
            event-set__enter="_event: mouseenter; scale:1.06 1.06 1.06; color:#7bdcff"
            event-set__leave="_event: mouseleave; scale:1 1 1; color:#2e88ff">
          </a-box>
          <a-text 
            value="Tumbukan" 
            color="#fff" 
            align="center" 
            width="4" 
            position="0 0 0.06"
            material="depthTest: false; transparent: true">
          </a-text>
        </a-entity>
      </a-entity>

      <!-- Bab 2 - Gaya Gesek -->
      <a-entity id="bab2" visible="false">
      <a-entity id="myModel" position="0 0.55 -3" rotation="0 -90 0" scale="0.5 0.5 0.5">
        <a-box
          id="blockModel"
          class="collidable"
          position="0 0 0" width="2"
          height="1"
          depth="1"
          color="#8B4513"
          material="depthTest: true"
          shadow="cast: true">
        </a-box>

        <!-- Panah gaya F (applied force) ke kanan - mengikuti balok -->
        <a-entity
          id="forceArrow"
          position="1 0.5 -2"
          rotation="0 90 0"
          scale="1.5 1.5 1.5"
          visible="false">
          <!-- Batang panah -->
          <a-cylinder
            position="0 0 0"
            radius="0.04"
            height="1.2"
            color="#FF0000"
            rotation="0 0 90"
            material="depthTest: true">
          </a-cylinder>
          <!-- Kepala panah -->
          <a-cone
            position="0.6 0 0"
            radius-bottom="0.12"
            height="0.25"
            color="#FF0000"
            rotation="0 0 -90"
            material="depthTest: true">
          </a-cone>
          <!-- Label F -->
          <a-text
            value="F"
            position="0 0.25 0"
            align="center"
            color="#FF0000"
            width="6"
            material="depthTest: false">
          </a-text>
        </a-entity>

        <!-- Panah gaya gesek (fs/fk) ke kiri - mengikuti balok -->
        <a-entity
          id="frictionArrow"
          position="1 -0.5 2"
          rotation="0 -90 0"
          scale="1.5 1.5 1.5"
          visible="false">
          <!-- Batang panah -->
          <a-cylinder
            position="0 0 0"
            radius="0.04"
            height="1.2"
            color="#0000FF"
            rotation="0 0 90"
            material="depthTest: true">
          </a-cylinder>
          <!-- Kepala panah -->
          <a-cone
            position="0.6 0 0"
            radius-bottom="0.12"
            height="0.25"
            color="#0000FF"
            rotation="0 0 -90"
            material="depthTest: true">
          </a-cone>
          <!-- Label fs/fk -->
          <a-text
            id="frictionLabel"
            value="fs"
            position="0 0.25 0"
            rotation="0 180 0"
            align="center"
            color="#0000FF"
            width="6"
            material="depthTest: false">
          </a-text>
        </a-entity>


      </a-entity>

      <!-- Status Text with Frame/Background -->
      <a-entity position="0 2.2 -3">
        <!-- Background Frame/Panel -->
        <a-plane
          width="5"
          height="0.8"
          color="#1a1a1a"
          opacity="0.85"
          material="transparent: true"
          position="0 0 -0.05">
        </a-plane>

        <!-- Border/Frame -->
        <a-plane
          width="5.1"
          height="0.85"
          color="#00E676"
          opacity="0.6"
          material="transparent: true"
          position="0 0 -0.06">
        </a-plane>

        <!-- Status Text -->
        <a-text
          id="statusText"
          value="Masukkan nilai pada panel di kiri untuk memulai simulasi."
          position="0 0 0"
          align="center"
          color="white"
          width="4"
          material="depthTest: false; transparent: true">
        </a-text>
      </a-entity>

      <a-entity position="-0.5 0.2 -1" rotation="-30 0 0">
        <a-box
          id="btnKembali2"
          class="clickable"
          depth="0.1"
          height="0.2"
          width="0.6"
          color="#008800"
          material="depthTest: true"
          event-set__enter="_event: mouseenter; scale:1.06 1.06 1.06; color:#81db81"
          event-set__leave="_event: mouseleave; scale:1 1 1; color:#008800">
        </a-box>
        <a-text
          value="Kembali"
          color="#fff"
          align="center"
          width="2"
          position="0 0 0.06"
          material="depthTest: false; transparent: true">
        </a-text>
      </a-entity>

      <a-entity position="0.5 0.2 -1" rotation="-30 0 0">
        <a-box
          id="btnReset2"
          class="clickable"
          depth="0.1"
          height="0.2"
          width="0.6"
          color="#008800"
          material="depthTest: true"
          event-set__enter="_event: mouseenter; scale:1.06 1.06 1.06; color:#81db81"
          event-set__leave="_event: mouseleave; scale:1 1 1; color:#008800">
        </a-box>
        <a-text
          value="Reset"
          color="#fff"
          align="center"
          width="2"
          position="0 0 0.06"
          material="depthTest: false; transparent: true">
        </a-text>
      </a-entity>
    </a-entity>

      <!-- Bab 3 - Tumbukan -->
      <a-entity id="bab3" visible="false">
        <!-- Bola-bola untuk simulasi tumbukan -->
        <a-sphere
          id="ball1"
          class="collidable"
          position="-3 0.3 -3"
          radius="0.25"
          color="#cc2f2f"
          material="depthTest: true"
          shadow="cast: true"
          ball-deformation="intensity: 0.2; duration: 300"
          ball-damage="massRatio: 1.0; impactVelocity: 1.0; damageThreshold: 2.0"
          inelastic-collision="mass: 1.0; restitution: 0.0; damageEnabled: true">
        </a-sphere>
        <a-text 
          id="label1" 
          value="m1 = 1kg&#10;v1 = 1m/s" 
          position="-3 1 -3" 
          align="center"
          color="white"
          material="depthTest: false; transparent: true">
        </a-text>
        
        <a-sphere
          id="ball2"
          class="collidable"
          position="3 0.3 -3"
          radius="0.25"
          color="#4545ff"
          material="depthTest: true"
          shadow="cast: true"
          ball-deformation="intensity: 0.2; duration: 300"
          ball-damage="massRatio: 1.0; impactVelocity: 1.0; damageThreshold: 2.0"
          inelastic-collision="mass: 1.0; restitution: 0.0; damageEnabled: true">
        </a-sphere>
        <a-text 
          id="label2" 
          value="m2 = 1kg&#10;v2 = -1m/s" 
          position="3 1 -3" 
          align="center"
          color="white"
          material="depthTest: false; transparent: true">
        </a-text>

        <!-- Particle system untuk efek collision - Enhanced -->
        <a-entity id="collisionParticles"
                  position="0 0.3 -3"
                  visible="false"
                  particle-system="preset: spark;
                                  particleCount: 150;
                                  maxAge: 1.2;
                                  accelerationValue: 0, -8, 0;
                                  velocityValue: 4 4 4;
                                  velocitySpread: 2.5 2.5 2.5;
                                  size: 0.08, 0.01;
                                  color: #FFD700, #FFA500, #FF6347;
                                  opacity: 1.0, 0.0"
                  sound="src: #collisionSound; autoplay: false; volume: 0.5; poolSize: 3"
                  crack-sound="src: #crackSound; autoplay: false; volume: 0.7; poolSize: 2"
                  break-sound="src: #breakSound; autoplay: false; volume: 0.8; poolSize: 2"
                  demo-sound="src: #demoSound; autoplay: false; volume: 0.6; poolSize: 2">
        </a-entity>

        <!-- Shockwave ring untuk efek collision -->
        <a-ring id="collisionShockwave"
                position="0 0.3 -3"
                rotation="-90 0 0"
                radius-inner="0.1"
                radius-outer="0.2"
                color="#00FFFF"
                opacity="0"
                material="transparent: true; emissive: #00FFFF; emissiveIntensity: 2"
                visible="false">
        </a-ring>

        <!-- Glow sphere untuk impact point -->
        <a-sphere id="collisionGlow"
                  position="0 0.3 -3"
                  radius="0.15"
                  color="#FFFFFF"
                  opacity="0"
                  material="transparent: true; emissive: #FFFFFF; emissiveIntensity: 3; shader: flat"
                  visible="false">
        </a-sphere>

        <!-- Trail effects untuk bola -->
        <a-entity id="trail1" 
                  visible="false"
                  position="-4 0.3 -3"
                  particle-system="preset: default; 
                                  particleCount: 50; 
                                  maxAge: 2; 
                                  accelerationValue: 0, 0, 0; 
                                  velocityValue: 0 0 0; 
                                  velocitySpread: 0.1 0.1 0.1;
                                  size: 0.05;
                                  color: #cc2f2f, #ff6666;
                                  opacity: 0.8, 0.0">
        </a-entity>

        <a-entity id="trail2" 
                  visible="false"
                  position="4 0.3 -3"
                  particle-system="preset: default; 
                                  particleCount: 50; 
                                  maxAge: 2; 
                                  accelerationValue: 0, 0, 0; 
                                  velocityValue: 0 0 0; 
                                  velocitySpread: 0.1 0.1 0.1;
                                  size: 0.05;
                                  color: #4545ff, #7777ff;
                                  opacity: 0.8, 0.0">
        </a-entity>

        <!-- Control Panel Tumbukan - Modern Professional Design -->
        <a-entity id="settingsPanel" position="0 2.2 -3" rotation="-12 0 0">

          <!-- Main Background with Glass Effect -->
          <a-rounded
            width="3"
            height="1.4"
            radius="0.08"
            color="#0d0d1a"
            opacity="0.9"
            position="0 0 -0.04">
          </a-rounded>

          <!-- Border Accent -->
          <a-plane
            width="3.02"
            height="1.42"
            color="#00ccff"
            opacity="0.3"
            position="0 0 -0.05">
          </a-plane>

          <!-- Title with Icon -->
          <a-text
            value="‚öô PENGATURAN SIMULASI"
            position="0 0.65 0"
            align="center"
            color="#00ffff"
            width="3.5"
            material="depthTest: false; transparent: true; shader: flat">
          </a-text>

          <!-- Jenis Tumbukan Section -->
          <a-text
            value="‚ïê‚ïê‚ïê JENIS TUMBUKAN ‚ïê‚ïê‚ïê"
            position="0 0.38 0"
            align="center"
            color="#88ddff"
            width="3.0"
            material="depthTest: false; transparent: true">
          </a-text>

          <!-- Info Jenis Tumbukan -->
          <a-text
            value="Pilih jenis tumbukan untuk simulasi:"
            position="0 0.24 0"
            align="center"
            color="#aaddff"
            width="2.5"
            material="depthTest: false; transparent: true">
          </a-text>

          <!-- Elastic Button - Modern Style -->
          <a-entity position="-0.65 0.05 0">
            <!-- Outer Glow -->
            <a-box
              depth="0.06"
              height="0.28"
              width="0.9"
              color="#00ff88"
              opacity="0.2"
              position="0 0 -0.01">
            </a-box>
            <!-- Main Button -->
            <a-box
              id="btnElastic"
              class="clickable"
              depth="0.05"
              height="0.26"
              width="0.88"
              color="#00dd77"
              material="depthTest: true; metalness: 0.6; roughness: 0.3"
              event-set__enter="_event: mouseenter; scale:1.08 1.08 1.08; material.color: #00ff99; material.emissive: #00ff88; material.emissiveIntensity: 0.5"
              event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #00dd77; material.emissive: #000000; material.emissiveIntensity: 0">
            </a-box>
            <a-text
              value="‚úì ELASTIS"
              color="#ffffff"
              align="center"
              width="2.5"
              position="0 0.06 0.03"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>
            <a-text
              value="(Energi terjaga)"
              color="#ccffcc"
              align="center"
              width="1.8"
              position="0 -0.04 0.03"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>
          </a-entity>

          <!-- Inelastic Button - Modern Style -->
          <a-entity position="0.65 0.05 0">
            <!-- Outer Glow -->
            <a-box
              depth="0.06"
              height="0.28"
              width="0.9"
              color="#ff6600"
              opacity="0.2"
              position="0 0 -0.01">
            </a-box>
            <!-- Main Button -->
            <a-box
              id="btnInelastic"
              class="clickable"
              depth="0.05"
              height="0.26"
              width="0.88"
              color="#ff5500"
              material="depthTest: true; metalness: 0.6; roughness: 0.3"
              event-set__enter="_event: mouseenter; scale:1.08 1.08 1.08; material.color: #ff7722; material.emissive: #ff6600; material.emissiveIntensity: 0.5"
              event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #ff5500; material.emissive: #000000; material.emissiveIntensity: 0">
            </a-box>
            <a-text
              value="‚úó INELASTIS"
              color="#ffffff"
              align="center"
              width="2.3"
              position="0 0.06 0.03"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>
            <a-text
              value="(Energi hilang)"
              color="#ffccaa"
              align="center"
              width="1.8"
              position="0 -0.04 0.03"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>
          </a-entity>

          <!-- Divider with Gradient Effect -->
          <a-plane
            width="2.8"
            height="0.025"
            color="#00ccff"
            opacity="0.6"
            position="0 -0.22 0">
          </a-plane>

          <!-- Demo Massa Label -->
          <a-text
            value="‚ö° DEMO MASSA"
            position="0 -0.35 0"
            align="center"
            color="#88ddff"
            width="3.0"
            material="depthTest: false; transparent: true">
          </a-text>

          <!-- Info Demo Massa -->
          <a-text
            value="Pilih perbandingan massa untuk demo cepat:"
            position="0 -0.47 0"
            align="center"
            color="#aaddff"
            width="2.4"
            material="depthTest: false; transparent: true">
          </a-text>

          <!-- Mass Demo Buttons - Modern Compact with Better Labels -->
          <a-entity position="-0.82 -0.68 0">
            <a-box
              id="btnHeavyLight"
              class="clickable"
              depth="0.05"
              height="0.22"
              width="0.72"
              color="#ff9900"
              radius="0.02"
              material="depthTest: true; metalness: 0.5; roughness: 0.4"
              event-set__enter="_event: mouseenter; scale:1.12 1.12 1.12; material.color: #ffbb33; material.emissive: #ff9900; material.emissiveIntensity: 0.4"
              event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #ff9900; material.emissive: #000000; material.emissiveIntensity: 0">
            </a-box>
            <a-text
              value="BERAT ‚Üí RINGAN"
              color="#ffffff"
              align="center"
              width="2.2"
              position="0 0.04 0.03"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>
            <a-text
              value="(m‚ÇÅ > m‚ÇÇ)"
              color="#ffddaa"
              align="center"
              width="1.8"
              position="0 -0.05 0.03"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>
          </a-entity>

          <a-entity position="0 -0.68 0">
            <a-box
              id="btnEqualMass"
              class="clickable"
              depth="0.05"
              height="0.22"
              width="0.72"
              color="#00cc00"
              material="depthTest: true; metalness: 0.5; roughness: 0.4"
              event-set__enter="_event: mouseenter; scale:1.12 1.12 1.12; material.color: #00ff33; material.emissive: #00cc00; material.emissiveIntensity: 0.4"
              event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #00cc00; material.emissive: #000000; material.emissiveIntensity: 0">
            </a-box>
            <a-text
              value="MASSA SAMA"
              color="#ffffff"
              align="center"
              width="2.2"
              position="0 0.04 0.03"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>
            <a-text
              value="(m‚ÇÅ = m‚ÇÇ)"
              color="#ccffcc"
              align="center"
              width="1.8"
              position="0 -0.05 0.03"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>
          </a-entity>

          <a-entity position="0.82 -0.68 0">
            <a-box
              id="btnLightHeavy"
              class="clickable"
              depth="0.05"
              height="0.22"
              width="0.72"
              color="#dd00dd"
              material="depthTest: true; metalness: 0.5; roughness: 0.4"
              event-set__enter="_event: mouseenter; scale:1.12 1.12 1.12; material.color: #ff33ff; material.emissive: #dd00dd; material.emissiveIntensity: 0.4"
              event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #dd00dd; material.emissive: #000000; material.emissiveIntensity: 0">
            </a-box>
            <a-text
              value="RINGAN ‚Üí BERAT"
              color="#ffffff"
              align="center"
              width="2.2"
              position="0 0.04 0.03"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>
            <a-text
              value="(m‚ÇÅ < m‚ÇÇ)"
              color="#ffccff"
              align="center"
              width="1.8"
              position="0 -0.05 0.03"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>
          </a-entity>
        </a-entity>

        <!-- Kontrol untuk Bola 1 (Merah) - Modern Design -->
        <a-entity id="UImerahWrapper" position="-3.5 0.5 0.5" rotation="-5 35 0">

          <!-- Glass Background with Gradient -->
          <a-plane
            width="1.7"
            height="1.15"
            color="#1a0505"
            opacity="0.92"
            position="0 0 -0.03">
          </a-plane>

          <!-- Border Accent -->
          <a-plane
            width="1.72"
            height="1.17"
            color="#ff3333"
            opacity="0.4"
            position="0 0 -0.04">
          </a-plane>

          <!-- Title with Icon -->
          <a-text
            value="üî¥ BOLA MERAH"
            position="0 0.5 0"
            align="center"
            color="#ff5555"
            width="3"
            material="depthTest: false; transparent: true; shader: flat">
          </a-text>
          
          <!-- Massa Section -->
          <a-text
            value="‚öñ MASSA"
            position="0 0.28 0"
            align="center"
            color="#ffaaaa"
            width="2.8"
            material="depthTest: false; transparent: true; shader: flat">
          </a-text>

          <a-entity position="0 0.08 0">
            <!-- Minus Button - Modern -->
            <a-entity position="-0.48 0 0">
              <a-box
                id="btnM1Minus"
                class="clickable"
                depth="0.04"
                height="0.2"
                width="0.28"
                color="#cc2222"
                material="depthTest: true; metalness: 0.7; roughness: 0.2"
                event-set__enter="_event: mouseenter; scale:1.18 1.18 1.18; material.color: #ff4444; material.emissive: #ff0000; material.emissiveIntensity: 0.5"
                event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #cc2222; material.emissive: #000000; material.emissiveIntensity: 0">
              </a-box>
              <a-text
                value="‚àí"
                color="#ffffff"
                align="center"
                width="4.5"
                position="0 0 0.025"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>

            <!-- Display - Modern Glass -->
            <a-entity position="0 0 0">
              <a-box
                depth="0.02"
                height="0.2"
                width="0.52"
                color="#1a1a1a"
                opacity="0.95"
                material="depthTest: true; metalness: 0.3; roughness: 0.6">
              </a-box>
              <a-text
                id="inputM1Text"
                value="1.0 kg"
                color="#ffeeee"
                align="center"
                width="2.8"
                position="0 0 0.015"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>

            <!-- Plus Button - Modern -->
            <a-entity position="0.48 0 0">
              <a-box
                id="btnM1Plus"
                class="clickable"
                depth="0.04"
                height="0.2"
                width="0.28"
                color="#00bb00"
                material="depthTest: true; metalness: 0.7; roughness: 0.2"
                event-set__enter="_event: mouseenter; scale:1.18 1.18 1.18; material.color: #00ff33; material.emissive: #00ff00; material.emissiveIntensity: 0.5"
                event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #00bb00; material.emissive: #000000; material.emissiveIntensity: 0">
              </a-box>
              <a-text
                value="+"
                color="#ffffff"
                align="center"
                width="4.5"
                position="0 0 0.025"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>
          </a-entity>

          <!-- Kecepatan Section -->
          <a-text
            value="üöÄ KECEPATAN"
            position="0 -0.17 0"
            align="center"
            color="#ffaaaa"
            width="2.5"
            material="depthTest: false; transparent: true; shader: flat">
          </a-text>

          <a-entity position="0 -0.37 0">
            <!-- Minus Button - Modern -->
            <a-entity position="-0.48 0 0">
              <a-box
                id="btnV1Minus"
                class="clickable"
                depth="0.04"
                height="0.2"
                width="0.28"
                color="#cc2222"
                material="depthTest: true; metalness: 0.7; roughness: 0.2"
                event-set__enter="_event: mouseenter; scale:1.18 1.18 1.18; material.color: #ff4444; material.emissive: #ff0000; material.emissiveIntensity: 0.5"
                event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #cc2222; material.emissive: #000000; material.emissiveIntensity: 0">
              </a-box>
              <a-text
                value="‚àí"
                color="#ffffff"
                align="center"
                width="4.5"
                position="0 0 0.025"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>

            <!-- Display - Modern Glass -->
            <a-entity position="0 0 0">
              <a-box
                depth="0.02"
                height="0.2"
                width="0.52"
                color="#1a1a1a"
                opacity="0.95"
                material="depthTest: true; metalness: 0.3; roughness: 0.6">
              </a-box>
              <a-text
                id="inputV1Text"
                value="1.0 m/s"
                color="#ffeeee"
                align="center"
                width="2.3"
                position="0 0 0.015"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>

            <!-- Plus Button - Modern -->
            <a-entity position="0.48 0 0">
              <a-box
                id="btnV1Plus"
                class="clickable"
                depth="0.04"
                height="0.2"
                width="0.28"
                color="#00bb00"
                material="depthTest: true; metalness: 0.7; roughness: 0.2"
                event-set__enter="_event: mouseenter; scale:1.18 1.18 1.18; material.color: #00ff33; material.emissive: #00ff00; material.emissiveIntensity: 0.5"
                event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #00bb00; material.emissive: #000000; material.emissiveIntensity: 0">
              </a-box>
              <a-text
                value="+"
                color="#ffffff"
                align="center"
                width="4.5"
                position="0 0 0.025"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>
          </a-entity>
        </a-entity>

        <!-- Kontrol untuk Bola 2 (Biru) - Modern Design -->
        <a-entity id="UIbiruWrapper" position="3.5 0.5 0.5" rotation="-5 -35 0">

          <!-- Glass Background with Gradient -->
          <a-plane
            width="1.7"
            height="1.15"
            color="#05051a"
            opacity="0.92"
            position="0 0 -0.03">
          </a-plane>

          <!-- Border Accent -->
          <a-plane
            width="1.72"
            height="1.17"
            color="#3333ff"
            opacity="0.4"
            position="0 0 -0.04">
          </a-plane>

          <!-- Title with Icon -->
          <a-text
            value="üîµ BOLA BIRU"
            position="0 0.5 0"
            align="center"
            color="#5555ff"
            width="3"
            material="depthTest: false; transparent: true; shader: flat">
          </a-text>
          
          <!-- Massa Section -->
          <a-text
            value="‚öñ MASSA"
            position="0 0.28 0"
            align="center"
            color="#aaaaff"
            width="2.8"
            material="depthTest: false; transparent: true; shader: flat">
          </a-text>

          <a-entity position="0 0.08 0">
            <a-entity position="-0.48 0 0">
              <a-box
                id="btnM2Minus"
                class="clickable"
                depth="0.04"
                height="0.2"
                width="0.28"
                color="#cc2222"
                material="depthTest: true; metalness: 0.7; roughness: 0.2"
                event-set__enter="_event: mouseenter; scale:1.18 1.18 1.18; material.color: #ff4444; material.emissive: #ff0000; material.emissiveIntensity: 0.5"
                event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #cc2222; material.emissive: #000000; material.emissiveIntensity: 0">
              </a-box>
              <a-text
                value="‚àí"
                color="#ffffff"
                align="center"
                width="4.5"
                position="0 0 0.025"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>

            <a-entity position="0 0 0">
              <a-box
                depth="0.02"
                height="0.2"
                width="0.52"
                color="#1a1a1a"
                opacity="0.95"
                material="depthTest: true; metalness: 0.3; roughness: 0.6">
              </a-box>
              <a-text
                id="inputM2Text"
                value="1.0 kg"
                color="#eeeeff"
                align="center"
                width="2.8"
                position="0 0 0.015"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>

            <a-entity position="0.48 0 0">
              <a-box
                id="btnM2Plus"
                class="clickable"
                depth="0.04"
                height="0.2"
                width="0.28"
                color="#00bb00"
                material="depthTest: true; metalness: 0.7; roughness: 0.2"
                event-set__enter="_event: mouseenter; scale:1.18 1.18 1.18; material.color: #00ff33; material.emissive: #00ff00; material.emissiveIntensity: 0.5"
                event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #00bb00; material.emissive: #000000; material.emissiveIntensity: 0">
              </a-box>
              <a-text
                value="+"
                color="#ffffff"
                align="center"
                width="4.5"
                position="0 0 0.025"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>
          </a-entity>

          <!-- Kecepatan Section -->
          <a-text
            value="üöÄ KECEPATAN"
            position="0 -0.17 0"
            align="center"
            color="#aaaaff"
            width="2.5"
            material="depthTest: false; transparent: true; shader: flat">
          </a-text>

          <a-entity position="0 -0.37 0">
            <a-entity position="-0.48 0 0">
              <a-box
                id="btnV2Minus"
                class="clickable"
                depth="0.04"
                height="0.2"
                width="0.28"
                color="#cc2222"
                material="depthTest: true; metalness: 0.7; roughness: 0.2"
                event-set__enter="_event: mouseenter; scale:1.18 1.18 1.18; material.color: #ff4444; material.emissive: #ff0000; material.emissiveIntensity: 0.5"
                event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #cc2222; material.emissive: #000000; material.emissiveIntensity: 0">
              </a-box>
              <a-text
                value="‚àí"
                color="#ffffff"
                align="center"
                width="4.5"
                position="0 0 0.025"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>

            <a-entity position="0 0 0">
              <a-box
                depth="0.02"
                height="0.2"
                width="0.52"
                color="#1a1a1a"
                opacity="0.95"
                material="depthTest: true; metalness: 0.3; roughness: 0.6">
              </a-box>
              <a-text
                id="inputV2Text"
                value="-1.0 m/s"
                color="#eeeeff"
                align="center"
                width="2.3"
                position="0 0 0.015"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>

            <a-entity position="0.48 0 0">
              <a-box
                id="btnV2Plus"
                class="clickable"
                depth="0.04"
                height="0.2"
                width="0.28"
                color="#00bb00"
                material="depthTest: true; metalness: 0.7; roughness: 0.2"
                event-set__enter="_event: mouseenter; scale:1.18 1.18 1.18; material.color: #00ff33; material.emissive: #00ff00; material.emissiveIntensity: 0.5"
                event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #00bb00; material.emissive: #000000; material.emissiveIntensity: 0">
              </a-box>
              <a-text
                value="+"
                color="#ffffff"
                align="center"
                width="4.5"
                position="0 0 0.025"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>
          </a-entity>
        </a-entity>

        <!-- Action Buttons - Modern Premium Design -->

        <!-- Tombol Play/Start/Reset - Kanan Bawah -->
        <a-entity position="1.9 0.4 -0.5" rotation="-8 -20 0" visible="false">
          <!-- Glow Effect -->
          <a-box
            depth="0.12"
            height="0.42"
            width="1.08"
            color="#00ff66"
            opacity="0.15"
            position="0 0 -0.01">
          </a-box>
          <!-- Main Button -->
          <a-box
            id="btnPlay"
            class="clickable"
            depth="0.1"
            height="0.4"
            width="1.05"
            color="#00dd55"
            material="depthTest: true; metalness: 0.8; roughness: 0.2"
            event-set__enter="_event: mouseenter; scale:1.1 1.1 1.1; material.color: #00ff77; material.emissive: #00ff66; material.emissiveIntensity: 0.6"
            event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #00dd55; material.emissive: #000000; material.emissiveIntensity: 0">
          </a-box>
          <!-- Text -->
          <a-text
            id="btnPlayText"
            value="‚ñ∂ START"
            color="#ffffff"
            align="center"
            width="2.5"
            position="0 0 0.06"
            material="depthTest: false; transparent: true; shader: flat">
          </a-text>
        </a-entity>

        <!-- Tombol Kembali - Kiri Bawah -->
        <a-entity position="-1.9 0.4 -0.5" rotation="-8 20 0" visible="false">
          <!-- Glow Effect -->
          <a-box
            depth="0.12"
            height="0.42"
            width="1.08"
            color="#ff3333"
            opacity="0.15"
            position="0 0 -0.01">
          </a-box>
          <!-- Main Button -->
          <a-box
            id="btnKembali3"
            class="clickable"
            depth="0.1"
            height="0.4"
            width="1.05"
            color="#dd2222"
            material="depthTest: true; metalness: 0.8; roughness: 0.2"
            event-set__enter="_event: mouseenter; scale:1.1 1.1 1.1; material.color: #ff4444; material.emissive: #ff3333; material.emissiveIntensity: 0.6"
            event-set__leave="_event: mouseleave; scale:1 1 1; material.color: #dd2222; material.emissive: #000000; material.emissiveIntensity: 0">
          </a-box>
          <!-- Text -->
          <a-text
            value="‚óÑ KEMBALI"
            color="#ffffff"
            align="center"
            width="2.3"
            position="0 0 0.06"
            material="depthTest: false; transparent: true; shader: flat">
          </a-text>
        </a-entity>

        <!-- Panel Hasil Tumbukan - Redesigned Clean Layout -->
        <a-entity
          id="resultPanel"
          position="0 0.5 -4.2"
          rotation="-8 0 0"
          visible="false">

          <!-- Multi-Layer Shadow Effect for Depth -->
          <a-box
            width="5.4"
            height="3.6"
            depth="0.02"
            position="0 -0.05 -0.08"
            material="color: #000000; opacity: 0.35; transparent: true">
          </a-box>

          <!-- Outer Glow Layer -->
          <a-box
            width="5.35"
            height="3.55"
            depth="0.08"
            position="0 0 -0.06"
            material="color: #00ffff; opacity: 0.1; transparent: true; emissive: #00ffff; emissiveIntensity: 0.25">
          </a-box>

          <!-- Border Frame - Metallic -->
          <a-box
            width="5.3"
            height="3.5"
            depth="0.1"
            position="0 0 -0.05"
            material="color: #0a2540; opacity: 0.95; transparent: true; metalness: 0.8; roughness: 0.2">
          </a-box>

          <!-- Main Panel - Glass Morphism -->
          <a-box
            width="5.2"
            height="3.4"
            depth="0.12"
            position="0 0 -0.04"
            material="color: #0d1520; opacity: 0.97; transparent: true; metalness: 0.4; roughness: 0.6">
          </a-box>

          <!-- Inner Glow Accent -->
          <a-plane
            width="5.1"
            height="3.3"
            position="0 0 -0.03"
            material="color: #00ccff; opacity: 0.06; transparent: true">
          </a-plane>

          <!-- Header Bar - Premium Gradient -->
          <a-box
            width="5.05"
            height="0.5"
            depth="0.08"
            position="0 1.48 0.01"
            material="color: #001f3f; opacity: 1; transparent: false; metalness: 0.7; roughness: 0.3; emissive: #003366; emissiveIntensity: 0.2">
          </a-box>

          <!-- Header Accent Strip -->
          <a-box
            width="5.05"
            height="0.035"
            depth="0.05"
            position="0 1.23 0.05"
            material="color: #00ffff; opacity: 0.9; transparent: true; emissive: #00ffff; emissiveIntensity: 0.8">
          </a-box>

          <!-- Title with Premium Typography -->
          <a-text
            value="üìä HASIL ANALISIS TUMBUKAN"
            position="0 1.48 0.09"
            align="center"
            color="#00ffff"
            width="4.8"
            material="depthTest: false; transparent: true; shader: flat; emissive: #00ffff; emissiveIntensity: 0.3">
          </a-text>

          <!-- Status Indicator Bar -->
          <a-box
            width="4.2"
            height="0.32"
            depth="0.04"
            position="0 0.95 0.02"
            material="color: #1a1a2e; opacity: 0.9; transparent: true; metalness: 0.5">
          </a-box>

          <a-text
            id="statusIndicator"
            value="üîÑ Menunggu simulasi..."
            position="0 0.95 0.06"
            align="center"
            color="#ffdd00"
            width="4.2"
            material="depthTest: false; transparent: true; shader: flat">
          </a-text>

          <!-- Data Grid Container with 3D Depth -->
          <a-entity position="0 0.28 0">

            <!-- Left Card: Before Collision -->
            <a-entity position="-1.85 0 0">
              <!-- Card Shadow -->
              <a-box
                width="2.15"
                height="1.5"
                depth="0.02"
                position="0 -0.02 -0.02"
                material="color: #000000; opacity: 0.3; transparent: true">
              </a-box>

              <!-- Card Container -->
              <a-box
                width="2.1"
                height="1.45"
                depth="0.08"
                position="0 0 0.01"
                material="color: #0d1f35; opacity: 0.95; transparent: true; metalness: 0.6; roughness: 0.4">
              </a-box>

              <!-- Card Header -->
              <a-box
                width="2.08"
                height="0.32"
                depth="0.06"
                position="0 0.565 0.05"
                material="color: #1a4570; opacity: 1; transparent: false; metalness: 0.7; emissive: #1a4570; emissiveIntensity: 0.2">
              </a-box>

              <a-text
                value="üìà SEBELUM TUMBUKAN"
                position="0 0.565 0.09"
                align="center"
                color="#5fa8d3"
                width="3.4"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>

              <!-- Data Display -->
              <a-text
                id="beforeData"
                value="m‚ÇÅ = 1 kg  |  v‚ÇÅ = 1 m/s\nm‚ÇÇ = 1 kg  |  v‚ÇÇ = -1 m/s\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nŒ£p = 0 kg‚ãÖm/s\nEk = 1.0 J"
                position="0 0.02 0.09"
                align="center"
                color="#e8f4f8"
                width="2.6"
                line-height="58"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>

            <!-- Right Card: After Collision -->
            <a-entity position="1.85 0 0">
              <!-- Card Shadow -->
              <a-box
                width="2.15"
                height="1.5"
                depth="0.02"
                position="0 -0.02 -0.02"
                material="color: #000000; opacity: 0.3; transparent: true">
              </a-box>

              <!-- Card Container -->
              <a-box
                width="2.1"
                height="1.45"
                depth="0.08"
                position="0 0 0.01"
                material="color: #0d1f0d; opacity: 0.95; transparent: true; metalness: 0.6; roughness: 0.4">
              </a-box>

              <!-- Card Header -->
              <a-box
                width="2.08"
                height="0.32"
                depth="0.06"
                position="0 0.565 0.05"
                material="color: #1a5c1a; opacity: 1; transparent: false; metalness: 0.7; emissive: #1a5c1a; emissiveIntensity: 0.2">
              </a-box>

              <a-text
                value="üìâ SESUDAH TUMBUKAN"
                position="0 0.565 0.09"
                align="center"
                color="#62d662"
                width="3.4"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>

              <!-- Data Display -->
              <a-text
                id="afterData"
                value="v‚ÇÅ' = 0 m/s\nv‚ÇÇ' = 0 m/s\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nŒ£p = 0 kg‚ãÖm/s\nEk = 0.0 J"
                position="0 0.02 0.09"
                align="center"
                color="#e8f8e8"
                width="2.6"
                line-height="58"
                material="depthTest: false; transparent: true; shader: flat">
              </a-text>
            </a-entity>

          </a-entity>

          <!-- Bottom Analysis Panel -->
          <a-entity position="0 -1.05 0">

            <!-- Analysis Container with Glow -->
            <a-box
              width="5.0"
              height="0.95"
              depth="0.08"
              position="0 0 0.01"
              material="color: #1a0a1f; opacity: 0.95; transparent: true; metalness: 0.6; roughness: 0.4; emissive: #2a0a2f; emissiveIntensity: 0.15">
            </a-box>

            <!-- Analysis Header Bar -->
            <a-box
              width="4.98"
              height="0.28"
              depth="0.06"
              position="0 0.335 0.05"
              material="color: #4a1a5a; opacity: 1; transparent: false; metalness: 0.7; emissive: #4a1a5a; emissiveIntensity: 0.3">
            </a-box>

            <a-text
              value="üî¨ ANALISIS KONSERVASI"
              position="0 0.335 0.09"
              align="center"
              color="#d98fd9"
              width="4.0"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>

            <!-- Conservation Status -->
            <a-text
              id="conservationData"
              value="‚úÖ Momentum: TERJAGA  ‚Ä¢  ‚úÖ Energi: TERJAGA\n\nüè∑Ô∏è  Jenis: TUMBUKAN ELASTIS"
              position="0 0.02 0.09"
              align="center"
              color="#f0f0f0"
              width="3.4"
              line-height="58"
              material="depthTest: false; transparent: true; shader: flat">
            </a-text>

            <!-- Restitution Badge -->
            <a-box
              width="3.2"
              height="0.3"
              depth="0.04"
              position="0 -0.38 0.05"
              material="color: #3a1a4a; opacity: 1; transparent: false; metalness: 0.8; roughness: 0.2; emissive: #5a2a6a; emissiveIntensity: 0.4">
            </a-box>

            <a-text
              id="restitutionData"
              value="üìè Koefisien Restitusi: e = 1.00 (Elastis Sempurna)"
              position="0 -0.38 0.09"
              align="center"
              color="#ffaaff"
              width="3.2"
              material="depthTest: false; transparent: true; shader: flat; emissive: #ffaaff; emissiveIntensity: 0.2">
            </a-text>
          </a-entity>

        </a-entity>

    </a-entity>
  </a-scene>

    <script>
      // Flag untuk cek apakah model berhasil dimuat
      let modelsLoaded = false;
      let blockAnimationState = 'idle';
      
      // Variabel global - diinisialisasi setelah DOM loaded
      let statusText, ball1, ball2, label1, label2, btnPlay, uiContainer;
      let m1 = 1, v1 = 1;
      let m2 = 1, v2 = -1;
      let animating = false;
      let done = false;
      
      // Physics collision solver variables
      let collisionType = 'elastic'; // 'elastic' or 'inelastic'
      let coefficientOfRestitution = 1.0; // e = 1 for elastic, e = 0 for inelastic

      // Result Panel Elements
      let resultPanel, statusIndicator, beforeData, afterData, conservationData, restitutionData;
      
      // Physics calculation results
      let collisionResults = {
        before: { momentum: 0, energy: 0 },
        after: { momentum: 0, energy: 0, v1: 0, v2: 0 },
        conservation: { momentum: true, energy: true },
        collisionType: 'elastic',
        restitution: 1.0
      };

      // Ambil semua elemen UI dan 3D yang diperlukan

      // Inisialisasi setelah DOM loaded
      document.addEventListener('DOMContentLoaded', () => {
        statusText = document.querySelector('#statusText');
        ball1 = document.querySelector("#ball1");
        ball2 = document.querySelector("#ball2");
        label1 = document.querySelector("#label1");
        label2 = document.querySelector("#label2");
        btnPlay = document.querySelector("#btnPlay");
        uiContainer = document.querySelector('#ui-container');
        
        // Inisialisasi elemen panel hasil
        resultPanel = document.querySelector('#resultPanel');
        statusIndicator = document.querySelector('#statusIndicator');
        beforeData = document.querySelector('#beforeData');
        afterData = document.querySelector('#afterData');
        conservationData = document.querySelector('#conservationData');
        restitutionData = document.querySelector('#restitutionData');
        
        // Debug log untuk memastikan elemen panel ditemukan
        console.log('Panel elements found:', {
          resultPanel: !!resultPanel,
          statusIndicator: !!statusIndicator,
          beforeData: !!beforeData,
          afterData: !!afterData,
          conservationData: !!conservationData,
          restitutionData: !!restitutionData
        });
        
        // Pastikan visibility awal yang benar
        document.querySelector("#mainmenu").setAttribute("visible", "true");
        document.querySelector("#bab2").setAttribute("visible", "false");
        document.querySelector("#bab3").setAttribute("visible", "false");
        
        // Delay sedikit untuk memastikan DOM ready, lalu force hide elemen bab3
        setTimeout(() => {
          // Pastikan semua elemen UI bab3 tersembunyi
          const UImerah = document.querySelector("#UImerahWrapper");
          const UIbiru = document.querySelector("#UIbiruWrapper");
          const bab3Container = document.querySelector("#bab3");
          
          if (UImerah) UImerah.setAttribute("visible", "false");
          if (UIbiru) UIbiru.setAttribute("visible", "false");
          if (bab3Container) bab3Container.setAttribute("visible", "false");
          
          // Pastikan tombol-tombol bab3 tidak clickable di awal
          const elementsToHide = [
            "btnKembali3", "btnPlay", "btnM1Plus", "btnM1Minus", 
            "btnV1Plus", "btnV1Minus", "btnM2Plus", "btnM2Minus",
            "btnV2Plus", "btnV2Minus"
          ];
          
          elementsToHide.forEach(id => {
            const element = document.querySelector(`#${id}`);
            if (element) {
              element.classList.remove("clickable");
              // Force hide if it's somehow visible
              const parent = element.closest('#bab3');
              if (parent) {
                parent.setAttribute("visible", "false");
              }
            }
          });
          
          console.log('Force hidden all Bab3 elements');
        }, 100);
        
        console.log('Scene2 initialized with correct visibility:');
        console.log('- Main menu: visible');
        console.log('- Bab2 (Gesekan): hidden');
        console.log('- Bab3 (Tumbukan): hidden');
        console.log('- All Bab3 UI elements: hidden');
        console.log('- All Bab3 controls: disabled');
        
        // Setup event listeners setelah elemen tersedia
        setupEventListeners();
        setupInputHandlers();
        
        // Panggil inisialisasi
        updateInputDisplays();
        updateLabel();
        updateCollisionTypeDisplay(); // Initialize collision type display
        
        console.log('DOM loaded, elements found:', {
          ball1: !!ball1, 
          ball2: !!ball2, 
          btnPlay: !!btnPlay,
          label1: !!label1,
          label2: !!label2
        });
      });

      // Fungsi untuk animasi fallback (jika GLB tidak ada)
      // Modifikasi: Buat fungsi ini lebih fleksibel
      function animateBlock(state, acceleration = 0, direction = 1) {
        // Animasikan parent myModel agar semua child (termasuk forceArrow) ikut bergerak
        const myModel = document.querySelector('#myModel');
        const arrow = document.querySelector('#directionArrow');

        if (myModel) {
          // Hapus animasi sebelumnya jika ada
          myModel.removeAttribute('animation');

          // Posisi awal myModel
          const initialPosition = { x: 0, y: 0.55, z: -3 };

          // Reset posisi ke posisi awal
          myModel.setAttribute('position', `${initialPosition.x} ${initialPosition.y} ${initialPosition.z}`);

          if (state === 'move') {
            // Show arrow when block is moving
            if (arrow) {
              arrow.setAttribute('visible', 'true');
              // Position arrow above the block and point in direction of movement
              arrow.setAttribute('position', `${initialPosition.x} ${initialPosition.y + 1.2} ${initialPosition.z}`);
              // Point arrow in movement direction (negative Z direction since block moves that way)
              arrow.setAttribute('rotation', '0 90 0'); // Point forward in movement direction

              // Add pulsing animation to arrow to show it's active
              arrow.setAttribute('animation__pulse', {
                property: 'scale',
                to: '2.2 2.2 2.2',
                from: '2 2 2',
                dur: 800,
                direction: 'alternate',
                loop: true,
                easing: 'easeInOutSine'
              });
            }

            // Durasi animasi berbanding terbalik dengan percepatan
            const duration = Math.max(1000, 5000 / (1 + acceleration));
            // Jarak tempuh proporsional dengan percepatan (diperbesar 2x untuk pergerakan horizontal)
            const distance = 2 + acceleration * 0.2;

            // Posisi target adalah posisi awal ditambah jarak pergerakan
            // direction: 1 = ke kanan (positif X), -1 = ke kiri (negatif X)
            const targetPosition = `${initialPosition.x + (distance * direction)} ${initialPosition.y} ${initialPosition.z}`;

            const animationString = `property: position; to: ${targetPosition}; dur: ${duration}; easing: easeInOutQuad; startEvents: start-animation`;

            myModel.setAttribute('animation', animationString);

            // Move arrow along with the block (directionArrow, bukan forceArrow)
            if (arrow) {
              // Set arrow direction based on movement direction
              const arrowRotation = direction > 0 ? '0 90 0' : '0 -90 0';
              arrow.setAttribute('rotation', arrowRotation);

              arrow.setAttribute('animation__move', {
                property: 'position',
                to: `${initialPosition.x + (distance * direction)} ${initialPosition.y + 1.2} ${initialPosition.z}`,
                dur: duration,
                easing: 'easeInOutQuad',
                startEvents: 'start-animation'
              });
            }

            // Memicu event untuk memulai animasi
            myModel.emit('start-animation');
          } else {
            // Hide arrow when block is idle/stationary
            if (arrow) {
              arrow.setAttribute('visible', 'false');
              arrow.removeAttribute('animation__pulse');
              arrow.removeAttribute('animation__move');
            }
          }
        }
      }

      // Variables for 3D panel values (global scope)
      let massa_value_3d = 5;
      let gaya_tarik_value_3d = 0;
      let koef_statis_value_3d = 0.5;
      let koef_kinetis_value_3d = 0.3;

      // ===== CANVAS TEXTURE SYSTEM UNTUK NOTASI MATEMATIKA =====
      // Function untuk render teks dengan simbol Unicode (termasuk Œº) ke canvas
      function createMathTextCanvas(text, fontSize = 128, textColor = '#FFC107') {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // Setup font dengan fallback yang mendukung Unicode - BOLD untuk lebih jelas
        const fontFamily = 'Arial, "Segoe UI", "Noto Sans", sans-serif';
        ctx.font = `bold ${fontSize}px ${fontFamily}`;

        // Ukur teks
        const metrics = ctx.measureText(text);
        const textWidth = metrics.width;
        const padding = 40; // Padding lebih besar

        // Set ukuran canvas (power of 2 untuk texture WebGL) - LEBIH BESAR
        canvas.width = Math.pow(2, Math.ceil(Math.log2(textWidth + padding * 2)));
        canvas.height = Math.pow(2, Math.ceil(Math.log2(fontSize + padding * 2)));

        // Clear & set background transparent
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Render teks di tengah dengan BOLD
        ctx.font = `bold ${fontSize}px ${fontFamily}`;
        ctx.fillStyle = textColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // Anti-aliasing untuk kualitas lebih baik
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        ctx.fillText(text, canvas.width / 2, canvas.height / 2);

        return canvas;
      }

      // Global canvas cache untuk efisiensi
      const canvasCache = {};

      // Cache untuk tracking elemen yang sudah di-render (prevent flickering)
      const renderedElements = {};

      // Function untuk update teks matematika menggunakan canvas
      function updateMathText(elementId, text, fontSize = 128, color = '#FFC107') {
        const element = document.querySelector(elementId);
        if (!element) {
          console.warn(`Element ${elementId} tidak ditemukan`);
          return;
        }

        // Cek apakah konten sama dengan sebelumnya (prevent flickering)
        const contentKey = `${elementId}-${text}-${fontSize}-${color}`;
        if (renderedElements[contentKey]) {
          console.log(`‚è≠Ô∏è Skipping ${elementId} - already rendered`);
          return; // Sudah di-render, skip untuk menghindari flickering
        }

        // Cek apakah ada simbol Unicode Œº
        const hasGreekLetters = /[ŒºŒ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑Œ∏ŒπŒ∫ŒªŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâ]/i.test(text);

        if (hasGreekLetters) {
          console.log(`‚ú® Rendering ${elementId} dengan canvas texture: "${text}"`);

          // Gunakan canvas texture dengan font size LEBIH BESAR
          const cacheKey = `${text}-${fontSize}-${color}`;

          let canvas;
          if (canvasCache[cacheKey]) {
            canvas = canvasCache[cacheKey];
          } else {
            canvas = createMathTextCanvas(text, fontSize, color);
            canvasCache[cacheKey] = canvas;
          }

          // Convert canvas ke data URL
          const dataURL = canvas.toDataURL('image/png');

          // Sesuaikan ukuran plane berdasarkan aspect ratio dengan HEIGHT tetap
          const aspectRatio = canvas.width / canvas.height;
          const height = 0.45; // Tinggi tetap untuk semua baris (disesuaikan agar sama dengan text biasa)
          const width = height * aspectRatio; // Lebar proporsional berdasarkan konten

          // Set geometry sebagai plane
          element.setAttribute('geometry', {
            primitive: 'plane',
            width: width,
            height: height
          });

          // Set material dengan canvas texture
          element.setAttribute('material', {
            shader: 'flat',
            src: dataURL,
            transparent: true,
            opacity: 1,
            side: 'double',
            alphaTest: 0.5,
            depthTest: true,
            depthWrite: true
          });

          // Hapus atribut text jika ada
          element.removeAttribute('text');
          element.removeAttribute('value');

        } else {
          console.log(`üìù Rendering ${elementId} dengan text biasa: "${text}"`);

          // Gunakan text component A-Frame dengan ukuran disesuaikan
          element.setAttribute('text', {
            value: text,
            align: 'center',
            color: color,
            width: 4.2,
            wrapCount: 100,
            font: 'roboto'
          });

          // Hapus geometry dan material jika ada
          element.removeAttribute('geometry');
          element.removeAttribute('material');
        }

        // Tandai sudah di-render
        renderedElements[contentKey] = true;
      }

      // Function to setup 3D panel controls
      function setup3DPanelControls() {
        console.log('üîß Setting up 3D panel controls...');

        // Massa controls
        const massaMinus = document.querySelector('#massa-minus');
        const massaPlus = document.querySelector('#massa-plus');
        const massaDisplay = document.querySelector('#massa-display');

        if (massaMinus) {
          // Remove any existing listeners first
          massaMinus.replaceWith(massaMinus.cloneNode(true));
          const newMassaMinus = document.querySelector('#massa-minus');
          newMassaMinus.addEventListener('click', () => {
            massa_value_3d = Math.max(1, massa_value_3d - 2);
            const display = document.querySelector('#massa-display');
            if (display) display.setAttribute('value', massa_value_3d.toString());
            console.log('Massa decreased to:', massa_value_3d);
          });
          console.log('‚úÖ Massa minus button listener added');
        }

        if (massaPlus) {
          massaPlus.replaceWith(massaPlus.cloneNode(true));
          const newMassaPlus = document.querySelector('#massa-plus');
          newMassaPlus.addEventListener('click', () => {
            massa_value_3d = Math.min(100, massa_value_3d + 2);
            const display = document.querySelector('#massa-display');
            if (display) display.setAttribute('value', massa_value_3d.toString());
            console.log('Massa increased to:', massa_value_3d);
          });
          console.log('‚úÖ Massa plus button listener added');
        }

        // Gaya Tarik controls
        const gayaTarikMinus = document.querySelector('#gaya-tarik-minus');
        const gayaTarikPlus = document.querySelector('#gaya-tarik-plus');

        if (gayaTarikMinus) {
          gayaTarikMinus.replaceWith(gayaTarikMinus.cloneNode(true));
          const newGayaTarikMinus = document.querySelector('#gaya-tarik-minus');
          newGayaTarikMinus.addEventListener('click', () => {
            gaya_tarik_value_3d = Math.max(0, gaya_tarik_value_3d - 10);
            const display = document.querySelector('#gaya-tarik-display');
            if (display) display.setAttribute('value', gaya_tarik_value_3d.toString());
            console.log('Gaya tarik decreased to:', gaya_tarik_value_3d);
          });
          console.log('‚úÖ Gaya tarik minus button listener added');
        }

        if (gayaTarikPlus) {
          gayaTarikPlus.replaceWith(gayaTarikPlus.cloneNode(true));
          const newGayaTarikPlus = document.querySelector('#gaya-tarik-plus');
          newGayaTarikPlus.addEventListener('click', () => {
            gaya_tarik_value_3d = Math.min(200, gaya_tarik_value_3d + 10);
            const display = document.querySelector('#gaya-tarik-display');
            if (display) display.setAttribute('value', gaya_tarik_value_3d.toString());
            console.log('Gaya tarik increased to:', gaya_tarik_value_3d);
          });
          console.log('‚úÖ Gaya tarik plus button listener added');
        }

        // Koefisien Statis controls
        const koefStatisMinus = document.querySelector('#koef-statis-minus');
        const koefStatisPlus = document.querySelector('#koef-statis-plus');

        if (koefStatisMinus) {
          koefStatisMinus.replaceWith(koefStatisMinus.cloneNode(true));
          const newKoefStatisMinus = document.querySelector('#koef-statis-minus');
          newKoefStatisMinus.addEventListener('click', () => {
            koef_statis_value_3d = Math.max(0.1, Math.round((koef_statis_value_3d - 0.1) * 10) / 10);
            const display = document.querySelector('#koef-statis-display');
            if (display) display.setAttribute('value', koef_statis_value_3d.toFixed(1));
            console.log('Koef statis decreased to:', koef_statis_value_3d);
          });
          console.log('‚úÖ Koef statis minus button listener added');
        }

        if (koefStatisPlus) {
          koefStatisPlus.replaceWith(koefStatisPlus.cloneNode(true));
          const newKoefStatisPlus = document.querySelector('#koef-statis-plus');
          newKoefStatisPlus.addEventListener('click', () => {
            koef_statis_value_3d = Math.min(2.0, Math.round((koef_statis_value_3d + 0.1) * 10) / 10);
            const display = document.querySelector('#koef-statis-display');
            if (display) display.setAttribute('value', koef_statis_value_3d.toFixed(1));
            console.log('Koef statis increased to:', koef_statis_value_3d);
          });
          console.log('‚úÖ Koef statis plus button listener added');
        }

        // Koefisien Kinetis controls
        const koefKinetisMinus = document.querySelector('#koef-kinetis-minus');
        const koefKinetisPlus = document.querySelector('#koef-kinetis-plus');

        if (koefKinetisMinus) {
          koefKinetisMinus.replaceWith(koefKinetisMinus.cloneNode(true));
          const newKoefKinetisMinus = document.querySelector('#koef-kinetis-minus');
          newKoefKinetisMinus.addEventListener('click', () => {
            koef_kinetis_value_3d = Math.max(0.1, Math.round((koef_kinetis_value_3d - 0.1) * 10) / 10);
            const display = document.querySelector('#koef-kinetis-display');
            if (display) display.setAttribute('value', koef_kinetis_value_3d.toFixed(1));
            console.log('Koef kinetis decreased to:', koef_kinetis_value_3d);
          });
          console.log('‚úÖ Koef kinetis minus button listener added');
        }

        if (koefKinetisPlus) {
          koefKinetisPlus.replaceWith(koefKinetisPlus.cloneNode(true));
          const newKoefKinetisPlus = document.querySelector('#koef-kinetis-plus');
          newKoefKinetisPlus.addEventListener('click', () => {
            koef_kinetis_value_3d = Math.min(1.0, Math.round((koef_kinetis_value_3d + 0.1) * 10) / 10);
            const display = document.querySelector('#koef-kinetis-display');
            if (display) display.setAttribute('value', koef_kinetis_value_3d.toFixed(1));
            console.log('Koef kinetis increased to:', koef_kinetis_value_3d);
          });
          console.log('‚úÖ Koef kinetis plus button listener added');
        }

        // Template Buttons - Massa
        console.log('üéØ Setting up template buttons...');
        const massaTemplateValues = [5, 10, 15, 20, 25, 30, 35, 40, 45, 50];
        massaTemplateValues.forEach(value => {
          const btn = document.querySelector(`#massa-tmpl-${value}`);
          if (btn) {
            btn.replaceWith(btn.cloneNode(true));
            const newBtn = document.querySelector(`#massa-tmpl-${value}`);
            newBtn.addEventListener('click', () => {
              massa_value_3d = value;
              const display = document.querySelector('#massa-display');
              if (display) display.setAttribute('value', massa_value_3d.toString());
              console.log(`üìå Massa template ${value} clicked, value set to:`, massa_value_3d);
            });
          }
        });
        console.log('‚úÖ All massa template buttons configured');

        // Template Buttons - Gaya Tarik
        const gayaTarikTemplateValues = [0, 10, 20, 30, 40, 50, 75, 100, 125, 150, 175, 200];
        gayaTarikTemplateValues.forEach(value => {
          const btn = document.querySelector(`#gaya-tmpl-${value}`);
          if (btn) {
            btn.replaceWith(btn.cloneNode(true));
            const newBtn = document.querySelector(`#gaya-tmpl-${value}`);
            newBtn.addEventListener('click', () => {
              gaya_tarik_value_3d = value;
              const display = document.querySelector('#gaya-tarik-display');
              if (display) display.setAttribute('value', gaya_tarik_value_3d.toString());
              console.log(`üìå Gaya tarik template ${value} clicked, value set to:`, gaya_tarik_value_3d);
            });
          }
        });
        console.log('‚úÖ All gaya tarik template buttons configured');


        // 3D Calculate Button
        const calculateBtn3D = document.querySelector('#calculate-btn-3d');
        if (calculateBtn3D) {
          calculateBtn3D.replaceWith(calculateBtn3D.cloneNode(true));
          const newCalculateBtn3D = document.querySelector('#calculate-btn-3d');
          newCalculateBtn3D.addEventListener('click', () => {
            console.log('üßÆ 3D Calculate button clicked');

            // 1. Use values from 3D controls
            const massa = massa_value_3d;
            const F_tarik = gaya_tarik_value_3d;
            const mu_s = koef_statis_value_3d;
            const mu_k = koef_kinetis_value_3d;
            const g = 9.8; // Konstanta gravitasi (m/s^2)

            console.log('Values:', { massa, F_tarik, mu_s, mu_k });

            // Validation
            if (mu_k > mu_s) {
              alert("Koefisien Kinetis (Œºk) tidak boleh lebih besar dari Koefisien Statis (Œºs).");
              return;
            }

            // 2. Perform physics calculations
            const N = massa * g; // Gaya Normal (N)
            const Fs_max = mu_s * N; // Gaya Gesek Statis Maksimum (N)
            const Fk = mu_k * N; // Gaya Gesek Kinetis (N)

            let kesimpulan = "";
            let percepatan = 0;
            let statusInfo = "";
            let direction = Math.sign(F_tarik); // 1 for right, -1 for left
            const F_abs = Math.abs(F_tarik); // Absolute value for calculations

            // 3. Determine block condition (4 states sesuai storyboard)
            if (F_abs <= Fs_max) {
              // Block remains static - differentiate between states (a), (b), and (c)
              percepatan = 0;

              if (F_abs < Fs_max * 0.3) {
                // State (a): Small applied force with small static friction
                const directionText = direction > 0 ? "kanan" : "kiri";
                kesimpulan = `F (${Math.abs(F_tarik).toFixed(2)} N) ‚â§ Fs,max (${Fs_max.toFixed(2)} N) - Status: Diam`;
                statusInfo = `DIAM - Gaya tarik kecil ke ${directionText}, gaya gesek statis kecil.`;
                showForceArrows(F_tarik, F_tarik, 'static_small'); // fs = F_tarik (equilibrium)

              } else if (F_abs < Fs_max * 0.8) {
                // State (b): Larger applied force with larger static friction
                const directionText = direction > 0 ? "kanan" : "kiri";
                kesimpulan = `F (${Math.abs(F_tarik).toFixed(2)} N) ‚â§ Fs,max (${Fs_max.toFixed(2)} N) - Status: Diam`;
                statusInfo = `DIAM - Gaya tarik sedang ke ${directionText}, gaya gesek statis sedang.`;
                showForceArrows(F_tarik, F_tarik, 'static_medium'); // fs = F_tarik (equilibrium)

              } else {
                // State (c): Block about to move with maximum static friction
                const directionText = direction > 0 ? "kanan" : "kiri";
                kesimpulan = `F (${Math.abs(F_tarik).toFixed(2)} N) ‚âà Fs,max (${Fs_max.toFixed(2)} N) - Status: Diam (hampir bergerak)`;
                statusInfo = `DIAM (HAMPIR BERGERAK) - Gaya gesek statis mendekati maksimum ke ${directionText}.`;
                showForceArrows(F_tarik, Fs_max * direction, 'static_max'); // fs approaches fs,max
              }

              // Animate 3D model
              animateBlock('idle');

            } else {
              // State (d): Block moves with kinetic friction
              const Fk_resistance = Fk * (-direction); // Friction opposes motion
              percepatan = (F_tarik - Fk_resistance) / massa; // a = (F_applied - F_friction) / m
              const directionText = direction > 0 ? "kanan" : "kiri";

              kesimpulan = `F (${Math.abs(F_tarik).toFixed(2)} N) > Fs,max (${Fs_max.toFixed(2)} N) - Status: Bergerak ke ${directionText}`;
              statusInfo = `BERGERAK ke ${directionText}! Gaya gesek kinetik ${Fk.toFixed(2)} N, percepatan ${Math.abs(percepatan).toFixed(2)} m/s¬≤.`;

              // Show force arrows for moving case (use signed value for arrows)
              showForceArrows(F_tarik, Fk_resistance, 'moving');

              // Animate 3D model
              animateBlock('move', Math.abs(percepatan), direction);
            }

            // 4. Display results in 3D panel
            const statusText = document.querySelector('#statusText');
            if (statusText) statusText.setAttribute('value', statusInfo);

            // Show 3D result panel
            const resultPanel3D = document.querySelector('#result-panel-3d');
            if (resultPanel3D) resultPanel3D.setAttribute('visible', 'true');

            // Clear render cache untuk kalkulasi baru (prevent showing old results)
            for (let key in renderedElements) {
              if (key.includes('result-')) {
                delete renderedElements[key];
              }
            }

            // Update 3D result displays dengan Canvas Texture untuk simbol Œº
            const resultTexts = {
              '#result-normal-3d': { text: `N = m √ó g = ${massa.toFixed(2)} √ó ${g.toFixed(2)} = ${Math.abs(N).toFixed(2)} N`, color: '#FFC107' },
              '#result-fsmax-3d': { text: `Fs,max = Œºs √ó N = ${mu_s.toFixed(2)} √ó ${Math.abs(N).toFixed(2)} = ${Math.abs(Fs_max).toFixed(2)} N`, color: '#FFC107' },
              '#result-fk-3d': { text: `Fk = Œºk √ó N = ${mu_k.toFixed(2)} √ó ${Math.abs(N).toFixed(2)} = ${Math.abs(Fk).toFixed(2)} N`, color: '#FFC107' },
              '#result-kesimpulan-3d': { text: `${kesimpulan}`, color: '#4CAF50' },
              '#result-percepatan-3d': { text: `a = ${Math.abs(percepatan).toFixed(2)} m/s¬≤`, color: '#4CAF50' }
            };

            // Gunakan updateMathText dengan font size LEBIH BESAR (128px untuk keterbacaan optimal)
            Object.entries(resultTexts).forEach(([selector, { text, color }]) => {
              updateMathText(selector, text, 128, color);
            });

            console.log('‚úÖ 3D calculation completed and results displayed');
          });
          console.log('‚úÖ Calculate 3D button listener added');
        }

        console.log('üéâ All 3D panel controls setup completed!');
      }

      function setupEventListeners() {
        /* Event listeners untuk Bab3 dan kontrol lain akan ada di sini */

        // Note: 3D Panel controls are now handled by setup3DPanelControls() function

        // Legacy 2D Event listener for backward compatibility (if old elements exist)
        const btnCalculate = document.querySelector('#btnCalculate');
        if (btnCalculate) {
          btnCalculate.addEventListener('click', () => {
            // 1. Ambil nilai input dari user
            const massa = parseFloat(document.querySelector('#massa').value);
            const F_tarik = parseFloat(document.querySelector('#gaya-tarik').value);
            const mu_s = parseFloat(document.querySelector('#koef-statis').value);
            const mu_k = parseFloat(document.querySelector('#koef-kinetis').value);
            const g = 9.8; // Konstanta gravitasi (m/s^2)

            // Validasi input
            if (isNaN(massa) || isNaN(F_tarik) || isNaN(mu_s) || isNaN(mu_k)) {
              alert("Pastikan semua input terisi dengan angka yang valid.");
              return;
            }
            if (mu_k > mu_s) {
              alert("Koefisien Kinetis (Œºk) tidak boleh lebih besar dari Koefisien Statis (Œºs).");
              return;
            }

            // 2. Lakukan kalkulasi fisika
            const N = massa * g; // Gaya Normal (N)
            const Fs_max = mu_s * N; // Gaya Gesek Statis Maksimum (N)
            const Fk = mu_k * N; // Gaya Gesek Kinetis (N)

            let kesimpulan = "";
            let percepatan = 0;
            let statusInfo = "";

            // 3. Tentukan kondisi balok (diam atau bergerak)
            if (F_tarik <= Fs_max) {
              // Balok tetap diam
              percepatan = 0;
              kesimpulan = `F (${F_tarik.toFixed(2)} N) ‚â§ Fs,max (${Fs_max.toFixed(2)} N) - Status: Diam`;
              statusInfo = "DIAM - Gaya tarik tidak cukup untuk mengatasi gaya gesek statis.";

              // Animasikan model 3D
              animateBlock('idle');

            } else {
              // Balok bergerak
              percepatan = (F_tarik - Fk) / massa; // a = (F_tarik - Fk) / m
              kesimpulan = `F (${F_tarik.toFixed(2)} N) > Fs,max (${Fs_max.toFixed(2)} N) - Status: Bergerak ke kanan`;
              statusInfo = `BERGERAK ke kanan! Dengan percepatan ${percepatan.toFixed(2)} m/s¬≤.`;

              // Animasikan model 3D
              animateBlock('move', percepatan);
            }

            // 4. Tampilkan hasil di panel UI dan di scene
            const statusText = document.querySelector('#statusText');
            const resultContainer = document.querySelector('#result-container');
            if (statusText) statusText.setAttribute('value', statusInfo);
            if (resultContainer) resultContainer.style.display = 'block';

            // Menggunakan HTML entity &mu; untuk simbol Œº (mu) dan HTML subscript
            const resultElements = [
              { selector: '#result-normal', text: `N = m √ó g = ${massa.toFixed(2)} √ó ${g.toFixed(2)} = ${N.toFixed(2)} N` },
              { selector: '#result-fsmax', text: `F<sub>s,max</sub> = &mu;<sub>s</sub> √ó N = ${mu_s.toFixed(2)} √ó ${N.toFixed(2)} = ${Fs_max.toFixed(2)} N` },
              { selector: '#result-fk', text: `F<sub>k</sub> = &mu;<sub>k</sub> √ó N = ${mu_k.toFixed(2)} √ó ${N.toFixed(2)} = ${Fk.toFixed(2)} N` },
              { selector: '#result-kesimpulan', text: `<b>Kesimpulan: ${kesimpulan}</b>` },
              { selector: '#result-percepatan', text: `<b>a = ${percepatan.toFixed(2)} m/s¬≤</b>` }
            ];

            resultElements.forEach(({ selector, text }) => {
              const element = document.querySelector(selector);
              if (element) element.innerHTML = text;
            });
          });
        }

        // Event listener untuk tombol Reset (Bab 2)
        const btnReset2 = document.querySelector('#btnReset2');
        if (btnReset2) {
          btnReset2.addEventListener('click', () => {
            // Reset animasi model
            animateBlock('idle');

            // Hide force arrows
            hideForceArrows();

            // Reset teks status
            const statusText = document.querySelector('#statusText');
            if (statusText) statusText.setAttribute('value', 'Masukkan nilai pada panel di kiri untuk memulai simulasi.');

            // Hide 3D result panel and reset values
            const resultPanel3D = document.querySelector('#result-panel-3d');
            if (resultPanel3D) resultPanel3D.setAttribute('visible', 'false');

            // Reset 3D panel values to defaults
            massa_value_3d = 5;
            gaya_tarik_value_3d = 0;
            koef_statis_value_3d = 0.5;
            koef_kinetis_value_3d = 0.3;

            // Update displays
            const massaDisplay = document.querySelector('#massa-display');
            const gayaTarikDisplay = document.querySelector('#gaya-tarik-display');
            const koefStatisDisplay = document.querySelector('#koef-statis-display');
            const koefKinetisDisplay = document.querySelector('#koef-kinetis-display');

            if (massaDisplay) massaDisplay.setAttribute('value', massa_value_3d.toString());
            if (gayaTarikDisplay) gayaTarikDisplay.setAttribute('value', gaya_tarik_value_3d.toString());
            if (koefStatisDisplay) koefStatisDisplay.setAttribute('value', koef_statis_value_3d.toFixed(1));
            if (koefKinetisDisplay) koefKinetisDisplay.setAttribute('value', koef_kinetis_value_3d.toFixed(1));

            // Sembunyikan dan kosongkan hasil kalkulasi
            const resultContainer = document.querySelector('#result-container');
            if (resultContainer) resultContainer.style.display = 'none';

            const resultSelectors = ['#result-normal', '#result-fsmax', '#result-fk', '#result-kesimpulan', '#result-percepatan'];
            resultSelectors.forEach(selector => {
              const element = document.querySelector(selector);
              if (element) element.innerHTML = '';
            });
          });
        }

        // Event listeners untuk kontrol massa dan kecepatan (input fields)
        // Massa Bola 1
        document.querySelector('#btnM1Plus').addEventListener('click', () => {
          m1 += 0.5;
          if (m1 > 30) m1 = 30; // Batas maksimal
          updateInputDisplays();
          updateLabel();
        });

        document.querySelector('#btnM1Minus').addEventListener('click', () => {
          m1 -= 0.5;
          if (m1 < 0.5) m1 = 0.5; // Batas minimal
          updateInputDisplays();
          updateLabel();
        });

        // Kecepatan Bola 1
        document.querySelector('#btnV1Plus').addEventListener('click', () => {
          v1 += 0.5;
          if (v1 > 30) v1 = 30; // Batas maksimal
          updateInputDisplays();
          updateLabel();
        });

        document.querySelector('#btnV1Minus').addEventListener('click', () => {
          v1 -= 0.5;
          if (v1 < -30) v1 = -30; // Batas minimal
          updateInputDisplays();
          updateLabel();
        });

        // Event listener untuk tombol Plus/Minus Massa Bola 2
        document.querySelector('#btnM2Plus').addEventListener('click', () => {
          m2 = Math.min(10, m2 + 0.5);
          updateInputDisplays();
          updateLabel();
        });

        document.querySelector('#btnM2Minus').addEventListener('click', () => {
          m2 = Math.max(0.5, m2 - 0.5);
          updateInputDisplays();
          updateLabel();
        });

        // Event listener untuk tombol Plus/Minus Kecepatan Bola 2
        document.querySelector('#btnV2Plus').addEventListener('click', () => {
          v2 = Math.min(10, v2 + 0.5);
          updateInputDisplays();
          updateLabel();
        });

        document.querySelector('#btnV2Minus').addEventListener('click', () => {
          v2 = Math.max(-10, v2 - 0.5);
          updateInputDisplays();
          updateLabel();
        });

        // Event listener untuk tombol Play/Reset
        btnPlay.addEventListener("click", () => {
          if (done) {
            resetBab3();
            console.log('Reset button clicked - simulation reset');
            return;
          }

          if (animating) return;
          
          console.log('üöÄ Starting collision simulation with type:', collisionType);
          console.log('Current parameters: m1=', m1, 'v1=', v1, 'm2=', m2, 'v2=', v2);
          console.log('Coefficient of restitution:', coefficientOfRestitution);
          
          // Update result panel dengan data sebelum animasi dimulai
          updateResultPanel();
          console.log('üìä Result panel updated before animation starts');
          
          animating = true;

          // Nonaktifkan semua kontrol selama animasi dan sembunyikan panel pengaturan
          document.querySelector("#UImerahWrapper").setAttribute("visible", "false");
          document.querySelector("#UIbiruWrapper").setAttribute("visible", "false");
          document.querySelector("#settingsPanel").setAttribute("visible", "false");
          document.querySelector("#btnPlay").classList.remove("clickable"); 
          
          console.log(`Starting collision simulation with m1=${m1}, v1=${v1}, m2=${m2}, v2=${v2}`);
          
          // Hitung kecepatan setelah tumbukan
          const [v1p, v2p] = hitungKecepatan(m1, v1, m2, v2);
          console.log(`\n=== HASIL TUMBUKAN ===`);
          console.log(`Input: m1=${m1}kg, v1=${v1}m/s, m2=${m2}kg, v2=${v2}m/s`);
          console.log(`Output: v1'=${v1p.toFixed(3)}m/s, v2'=${v2p.toFixed(3)}m/s`);
          console.log(`Momentum: ${(m1*v1 + m2*v2).toFixed(3)} ‚Üí ${(m1*v1p + m2*v2p).toFixed(3)} kg‚ãÖm/s`);
          
          // Activate trails untuk pre-collision movement
          showPreCollisionTrail('trail1', ball1.getAttribute('position'));
          showPreCollisionTrail('trail2', ball2.getAttribute('position'));

          // Hitung radius bola berdasarkan massa (sama dengan updateBallSizes)
          const radius1 = 0.15 + (m1 * 0.02);
          const radius2 = 0.15 + (m2 * 0.02);

          // Set animasi menuju collision point dengan distance yang tepat untuk bersentuhan
          // Collision point di x=0, posisi bola disesuaikan dengan radius masing-masing
          const collisionX = 0;
          const ball1CollisionPos = collisionX + radius1; // Bola 1 center
          const ball2CollisionPos = collisionX - radius2; // Bola 2 center

          console.log(`Collision positions: Ball1=${ball1CollisionPos.toFixed(3)} (r=${radius1.toFixed(3)}), Ball2=${ball2CollisionPos.toFixed(3)} (r=${radius2.toFixed(3)})`);

          // Hitung durasi berdasarkan kecepatan dan massa untuk realisme
          // Bola yang lebih cepat dan ringan bergerak lebih cepat
          const baseDuration = 2500;
          const velocityFactor1 = Math.abs(v1) / 5; // Normalize velocity
          const velocityFactor2 = Math.abs(v2) / 5;
          const massFactor1 = 1 / Math.sqrt(m1); // Lighter = faster
          const massFactor2 = 1 / Math.sqrt(m2);

          const duration1 = Math.max(1500, baseDuration / (velocityFactor1 * massFactor1 + 0.5));
          const duration2 = Math.max(1500, baseDuration / (velocityFactor2 * massFactor2 + 0.5));

          console.log(`Approach durations: Ball1=${duration1.toFixed(0)}ms, Ball2=${duration2.toFixed(0)}ms`);

          ball1.setAttribute("animation__go", {
            property: "position",
            to: `${ball1CollisionPos} 0.3 -3`,
            dur: duration1,
            easing: "easeInQuad" // Smooth acceleration menuju collision
          });

          ball2.setAttribute("animation__go", {
            property: "position",
            to: `${ball2CollisionPos} 0.3 -3`,
            dur: duration2,
            easing: "easeInQuad" // Smooth acceleration menuju collision
          });
          
          // Set animasi setelah collision menggunakan durasi maksimum untuk sinkronisasi
          const collisionTime = Math.max(duration1, duration2);
          setTimeout(() => {
            console.log('Setting post-collision animations...');
            console.log(`Post-collision velocities: v1'=${v1p.toFixed(2)}, v2'=${v2p.toFixed(2)}`);
            
            // TRIGGER COLLISION EFFECTS
            triggerCollisionEffects();
            
            // Efek khusus untuk tumbukan inelastis - hanya jika massa dan kecepatan sama
            if (collisionType === 'inelastic') {
              // Cek apakah massa dan kecepatan sama (menghasilkan v_final = 0)
              const massesEqual = Math.abs(m1 - m2) < 0.01; // Toleransi kecil untuk floating point
              const velocitiesEqual = Math.abs(Math.abs(v1) - Math.abs(v2)) < 0.01; // Magnitude sama
              const velocitiesOpposite = (v1 * v2) < 0; // Arah berlawanan

              const shouldShowConnector = massesEqual && velocitiesEqual && velocitiesOpposite;

              if (shouldShowConnector) {
                console.log('üîó Special case: Equal masses and opposite velocities ‚Üí showing connector effect');
                console.log(`Masses: m1=${m1}, m2=${m2} | Velocities: v1=${v1}, v2=${v2}`);
                createInelasticJointEffect();
              } else {
                console.log('‚ÑπÔ∏è  Inelastic collision without connector effect');
                console.log(`Masses equal: ${massesEqual}, Velocities equal: ${velocitiesEqual}, Opposite: ${velocitiesOpposite}`);
              }
            }
            
            // Animasi berdasarkan kecepatan akhir dengan skala yang lebih realistic
            // Jarak yang ditempuh = kecepatan * waktu, dengan faktor skala untuk tampilan
            const timeScale = 1.5; // Faktor skala untuk durasi animasi
            const distanceScale = 1.2; // Skala jarak diperbesar agar lebih terlihat
            
            // Hitung posisi akhir dengan logic khusus untuk inelastis
            let finalPos1 = v1p * distanceScale;
            let finalPos2 = v2p * distanceScale;
            
            // Logika khusus untuk tumbukan inelastis - bola bergandengan
            if (collisionType === 'inelastic') {
              console.log(`üîó INELASTIC COLLISION: Both balls stick together with velocity ${v1p.toFixed(2)} m/s`);

              // Untuk tumbukan tidak elastis, kedua bola bergerak bersama
              // Posisi ditentukan dari kecepatan final yang sama
              const commonVelocity = v1p; // v1p = v2p dalam tumbukan inelastis
              const commonFinalPos = commonVelocity * distanceScale;

              // Bola-bola bersentuhan tepat tanpa tembus dan tanpa gabung
              const ballRadius = 0.25;
              const touchingDistance = ballRadius * 2; // Jarak tepat untuk bersentuhan = 0.5

              if (Math.abs(commonVelocity) < 0.005) {
                // Jika kecepatan akhir ‚âà 0, kedua bola berhenti bersentuhan tepat di titik tumbukan
                // Ball1 di posisi kanan, Ball2 di posisi kiri, bersentuhan tepat di tengah (x=0)
                finalPos1 = ballRadius;     // Ball1 center di +0.25, edge kiri tepat di 0
                finalPos2 = -ballRadius;    // Ball2 center di -0.25, edge kanan tepat di 0
                console.log('üõë PERFECT INELASTIC STOP: Both balls come to rest touching exactly at collision point');
                console.log(`Stop positions - Ball1: ${finalPos1}, Ball2: ${finalPos2} (touching perfectly)`);
              } else {
                // Kedua bola bergerak bersama ke arah yang sama, bersentuhan tepat
                if (commonVelocity > 0) {
                  // Bergerak ke kanan - Ball1 di depan, Ball2 mengikuti bersentuhan
                  finalPos1 = commonFinalPos + ballRadius;
                  finalPos2 = commonFinalPos - ballRadius;
                } else {
                  // Bergerak ke kiri - Ball2 di depan, Ball1 mengikuti bersentuhan
                  finalPos1 = commonFinalPos + ballRadius;
                  finalPos2 = commonFinalPos - ballRadius;
                }
                console.log(`üöÄ INELASTIC MOVEMENT: Both balls move together at ${commonVelocity.toFixed(2)} m/s (touching perfectly)`);
              }

              console.log(`Final positions - Ball1: ${finalPos1.toFixed(2)}, Ball2: ${finalPos2.toFixed(2)}`);
            } else {
              // Cegah overlap untuk tumbukan elastis jika posisi akhir terlalu dekat
              if (Math.abs(finalPos1 - finalPos2) < 0.4) {
                if (finalPos1 >= finalPos2) {
                  finalPos1 += 0.2;
                  finalPos2 -= 0.2;
                } else {
                  finalPos1 -= 0.2;
                  finalPos2 += 0.2;
                }
                console.log(`Anti-overlap correction applied: Ball1=${finalPos1.toFixed(2)}, Ball2=${finalPos2.toFixed(2)}`);
              }
            }
            
            // Untuk tumbukan inelastis, kedua bola harus bergerak dengan durasi dan easing yang sama
            let animationDuration1, animationDuration2;
            let easing1, easing2;

            if (collisionType === 'inelastic') {
              // Untuk inelastis: durasi dan easing yang sama karena bergerak bersama
              const commonVel = Math.abs(v1p);
              const commonMassFactor = (m1 + m2) / 2; // Average mass effect
              const commonDuration = commonVel > 0.005
                ? (2500 / (commonVel * Math.sqrt(commonMassFactor) + 0.5))
                : 1200;
              animationDuration1 = commonDuration;
              animationDuration2 = commonDuration;
              easing1 = "easeOutQuart"; // Smoother deceleration
              easing2 = "easeOutQuart";
              console.log(`üîó INELASTIC SYNC: Both balls animate with same duration ${commonDuration}ms`);
            } else {
              // Untuk elastis: durasi berbeda sesuai kecepatan dan massa masing-masing
              // Heavier objects move slower, lighter faster
              const baseDur = 2200;
              animationDuration1 = Math.abs(v1p) > 0.005
                ? baseDur / (Math.abs(v1p) * Math.sqrt(1/m1) + 0.5)
                : 1000;
              animationDuration2 = Math.abs(v2p) > 0.005
                ? baseDur / (Math.abs(v2p) * Math.sqrt(1/m2) + 0.5)
                : 1000;
              easing1 = "easeOutQuart"; // Smoother deceleration
              easing2 = "easeOutQuart";
            }

            // Ball 1 post-collision animation dengan efek penyok realistis
            if (Math.abs(v1p) > 0.005) {
              // Deformasi bola berdasarkan energi kinetik dan momentum transfer
              const momentumTransfer1 = Math.abs(v1p - v1) * m1;
              const impactIntensity1 = Math.min(momentumTransfer1 / 5, 1);

              // Squash effect yang lebih dramatis (penyok)
              const squashX1 = 1 + (impactIntensity1 * 0.35); // Horizontal expansion (lebih besar)
              const squashY1 = 1 - (impactIntensity1 * 0.30); // Vertical compression (lebih dalam)
              const squashZ1 = 1 + (impactIntensity1 * 0.35); // Depth expansion
              const squashDuration1 = 120 + (impactIntensity1 * 80);

              // Efek slow-motion pada saat impact
              ball1.setAttribute("animation__slowdown", {
                property: "position",
                to: `${ball1CollisionPos} 0.3 -3`,
                dur: 50,
                easing: "easeOutQuad"
              });

              // Penyok/squash saat impact
              setTimeout(() => {
                ball1.setAttribute("animation__squash", {
                  property: "scale",
                  to: `${squashX1.toFixed(2)} ${squashY1.toFixed(2)} ${squashZ1.toFixed(2)}`,
                  dur: squashDuration1,
                  easing: "easeInOutQuad"
                });
              }, 50);

              // Recovery dengan elastic bounce
              setTimeout(() => {
                ball1.setAttribute("animation__recover", {
                  property: "scale",
                  to: "1 1 1",
                  dur: 400,
                  easing: "easeOutElastic"
                });
              }, 50 + squashDuration1);

              // Smooth movement dengan trail - dimulai setelah squash selesai
              showTrail('trail1', ball1.getAttribute('position'));

              const moveDelay1 = 50 + squashDuration1;
              setTimeout(() => {
                ball1.setAttribute("animation__after", {
                  property: "position",
                  to: `${finalPos1} 0.3 -3`,
                  dur: animationDuration1,
                  easing: easing1
                });
                console.log(`Ball1 moving to position: ${finalPos1} in ${animationDuration1}ms`);
              }, moveDelay1);
            } else {
              // Jika v1p sangat kecil, tetap gerakkan ke posisi final
              ball1.setAttribute("animation__after", {
                property: "position",
                to: `${finalPos1} 0.3 -3`,
                dur: animationDuration1,
                easing: easing1
              });
              console.log(`Ball1 slow movement to position: ${finalPos1} (v1p ‚âà ${v1p.toFixed(3)})`);
            }
            
            // Ball 2 post-collision animation dengan efek penyok realistis
            if (Math.abs(v2p) > 0.005) {
              // Deformasi bola berdasarkan energi kinetik dan momentum transfer
              const momentumTransfer2 = Math.abs(v2p - v2) * m2;
              const impactIntensity2 = Math.min(momentumTransfer2 / 5, 1);

              // Squash effect yang lebih dramatis (penyok)
              const squashX2 = 1 + (impactIntensity2 * 0.35); // Horizontal expansion (lebih besar)
              const squashY2 = 1 - (impactIntensity2 * 0.30); // Vertical compression (lebih dalam)
              const squashZ2 = 1 + (impactIntensity2 * 0.35); // Depth expansion
              const squashDuration2 = 120 + (impactIntensity2 * 80);

              // Efek slow-motion pada saat impact
              ball2.setAttribute("animation__slowdown", {
                property: "position",
                to: `${ball2CollisionPos} 0.3 -3`,
                dur: 50,
                easing: "easeOutQuad"
              });

              // Penyok/squash saat impact
              setTimeout(() => {
                ball2.setAttribute("animation__squash", {
                  property: "scale",
                  to: `${squashX2.toFixed(2)} ${squashY2.toFixed(2)} ${squashZ2.toFixed(2)}`,
                  dur: squashDuration2,
                  easing: "easeInOutQuad"
                });
              }, 50);

              // Recovery dengan elastic bounce
              setTimeout(() => {
                ball2.setAttribute("animation__recover", {
                  property: "scale",
                  to: "1 1 1",
                  dur: 400,
                  easing: "easeOutElastic"
                });
              }, 50 + squashDuration2);

              // Smooth movement dengan trail - dimulai setelah squash selesai
              showTrail('trail2', ball2.getAttribute('position'));

              const moveDelay2 = 50 + squashDuration2;
              setTimeout(() => {
                ball2.setAttribute("animation__after", {
                  property: "position",
                  to: `${finalPos2} 0.3 -3`,
                  dur: animationDuration2,
                  easing: easing2
                });
                console.log(`Ball2 moving to position: ${finalPos2} in ${animationDuration2}ms`);
              }, moveDelay2);
            } else {
              // Jika v2p sangat kecil, tetap gerakkan ke posisi final
              ball2.setAttribute("animation__after", {
                property: "position",
                to: `${finalPos2} 0.3 -3`,
                dur: animationDuration2,
                easing: easing2
              });
              console.log(`Ball2 slow movement to position: ${finalPos2} (v2p ‚âà ${v2p.toFixed(3)})`);
            }

            // Fungsi untuk menyelesaikan animasi dan menampilkan UI
            function completeAnimation() {
              console.log('üé¨ completeAnimation() called');
              console.log('Current collision type:', collisionType);
              console.log('resultPanel exists:', !!resultPanel);
              
              animating = false;
              done = true;
              document.querySelector("#btnPlayText").setAttribute("value", "Reset");
              document.querySelector("#btnPlay").classList.add("clickable");
              
              console.log('üîÑ Animation finished, showing reset button and result panel');
              
              // Restore UI visibility setelah animasi selesai
              document.querySelector("#UImerahWrapper").setAttribute("visible", "true");
              document.querySelector("#UIbiruWrapper").setAttribute("visible", "true");
              console.log('‚úÖ UI controls restored after animation');

              // Hapus efek inelastic connector setelah animasi selesai
              const connector = document.querySelector('#inelasticConnector');
              if (connector && connector.parentNode) {
                console.log('üóëÔ∏è Removing inelastic connector line after animation completed');
                connector.parentNode.removeChild(connector);
              }

              // Hapus partikel welding yang mungkin masih ada
              for (let i = 0; i < 10; i++) {
                const particle = document.querySelector(`#weldParticle${i}`);
                if (particle && particle.parentNode) {
                  particle.parentNode.removeChild(particle);
                }
              }

              // Tampilkan panel hasil
              console.log('üìä About to call showResultPanel()');
              showResultPanel();
              console.log('üìä showResultPanel() called');
            }
            
            // Tentukan durasi animasi maksimum untuk menunggu semua animasi selesai
            let maxAnimationDuration = Math.max(animationDuration1, animationDuration2);

            console.log(`Animation durations - Ball1: ${animationDuration1}ms, Ball2: ${animationDuration2}ms, Max: ${maxAnimationDuration}ms`);
            
            // Untuk tumbukan inelastis, tambahkan waktu untuk efek visual
            if (collisionType === 'inelastic') {
              maxAnimationDuration = Math.max(maxAnimationDuration, 3200); // 3000ms efek + buffer
              console.log('üîó Inelastic collision detected - extending animation wait time for effects');
            }
            
            console.log(`‚è±Ô∏è Waiting for animation completion. Max duration: ${maxAnimationDuration}ms (collision type: ${collisionType})`);
            
            // Tunggu sampai semua animasi selesai
            setTimeout(completeAnimation, maxAnimationDuration + 200); // +200ms buffer
          }, collisionTime);
        });


        // Navigation - Main Menu untuk Bab 2
        document.querySelector('#btnBab2').addEventListener('click', () => {
          console.log('üéØ Bab 2 (Gaya Gesek) button clicked - showing friction simulation');

          document.querySelector("#bab2").setAttribute("visible", true);
          if (uiContainer) uiContainer.style.display = 'block'; // Tampilkan panel UI
          document.querySelector("#mainmenu").setAttribute("visible", false);

          // Show 3D friction panel with entrance animation
          const frictionPanel = document.querySelector('#friction-panel-3d');
          if (frictionPanel) {
            frictionPanel.setAttribute('visible', 'true');
            frictionPanel.setAttribute('animation__show', {
              property: 'scale',
              from: '0.1 0.1 0.1',
              to: '1 1 1',
              dur: 600,
              easing: 'easeOutBack'
            });

            // Setup 3D panel controls after panel becomes visible
            setTimeout(() => {
              setup3DPanelControls();
            }, 100); // Small delay to ensure panel is fully rendered
          }

          // Show template panel with entrance animation (synced with control panel)
          const templatePanel = document.querySelector('#template-panel-3d');
          if (templatePanel) {
            templatePanel.setAttribute('visible', 'true');
            templatePanel.setAttribute('animation__show', {
              property: 'scale',
              from: '0.1 0.1 0.1',
              to: '1 1 1',
              dur: 600,
              easing: 'easeOutBack'
            });
            console.log('‚úÖ Template panel shown with animation');
          }

          // Atur ulang kelas 'clickable'
          document.querySelector("#btnReset2").classList.add("clickable");
          document.querySelector("#btnKembali2").classList.add("clickable");
          document.querySelector("#btnBab2").classList.remove("clickable");
          document.querySelector("#btnBab3").classList.remove("clickable");
        });

        // Navigation - Kembali dari Bab 2
        document.querySelector('#btnKembali2').addEventListener('click', () => {
          // Panggil fungsi reset untuk membersihkan scene Bab 2
          document.querySelector('#btnReset2').click();

          document.querySelector("#bab2").setAttribute("visible", false);
          if (uiContainer) uiContainer.style.display = 'none'; // Sembunyikan panel UI
          document.querySelector("#mainmenu").setAttribute("visible", true);

          // Hide 3D friction panel when exiting Bab 2
          const frictionPanel = document.querySelector('#friction-panel-3d');
          const templatePanel = document.querySelector('#template-panel-3d');
          const resultPanel3D = document.querySelector('#result-panel-3d');
          if (frictionPanel) frictionPanel.setAttribute('visible', 'false');
          if (templatePanel) templatePanel.setAttribute('visible', 'false');
          if (resultPanel3D) resultPanel3D.setAttribute('visible', 'false');

          // Atur ulang kelas 'clickable'
          document.querySelector("#btnReset2").classList.remove("clickable");
          document.querySelector("#btnKembali2").classList.remove("clickable");
          document.querySelector("#btnBab2").classList.add("clickable");
          document.querySelector("#btnBab3").classList.add("clickable");
        });

        // Navigation untuk Bab 3
        document.querySelector('#btnBab3').addEventListener('click', () => {
          console.log('User clicked Bab3 (Tumbukan) button - switching to collision simulation');
          document.querySelector("#bab3").setAttribute("visible", true);
          document.querySelector("#mainmenu").setAttribute("visible", false);
          
          // Tampilkan kontrol UI massa dan kecepatan untuk KEDUA bola serta panel pengaturan
          document.querySelector("#UImerahWrapper").setAttribute("visible", "true");
          document.querySelector("#UIbiruWrapper").setAttribute("visible", "true");
          document.querySelector("#settingsPanel").setAttribute("visible", "true");
          document.querySelector("#UImerahWrapper").style.display = "block";
          document.querySelector("#UIbiruWrapper").style.display = "block";
          
          // Tampilkan tombol-tombol Tumbukan (btnPlay dan btnKembali3)
          const btnPlayParent = document.querySelector("#btnPlay").parentElement;
          const btnKembali3Parent = document.querySelector("#btnKembali3").parentElement;
          if (btnPlayParent) btnPlayParent.setAttribute("visible", "true");
          if (btnKembali3Parent) btnKembali3Parent.setAttribute("visible", "true");
          
          document.querySelector("#btnBab2").classList.remove("clickable"); 
          document.querySelector("#btnBab3").classList.remove("clickable"); 
          document.querySelector("#btnKembali3").classList.add("clickable"); 
          document.querySelector("#btnPlay").classList.add("clickable"); 
          
          // Aktifkan semua tombol kontrol baru
          document.querySelector("#btnM1Plus").classList.add("clickable"); 
          document.querySelector("#btnM1Minus").classList.add("clickable"); 
          document.querySelector("#btnV1Plus").classList.add("clickable"); 
          document.querySelector("#btnV1Minus").classList.add("clickable"); 
          
          // Aktifkan kontrol bola 2
          document.querySelector("#btnM2Plus").classList.add("clickable"); 
          document.querySelector("#btnM2Minus").classList.add("clickable"); 
          document.querySelector("#btnV2Plus").classList.add("clickable"); 
          document.querySelector("#btnV2Minus").classList.add("clickable"); 
          
          updateInputDisplays();
          updateLabel();
        });

        document.querySelector('#btnKembali3').addEventListener('click', () => {
          document.querySelector("#bab3").setAttribute("visible", false);
          document.querySelector("#mainmenu").setAttribute("visible", true);
          
          // Sembunyikan kontrol UI untuk KEDUA bola dan panel pengaturan saat kembali ke menu utama
          document.querySelector("#UImerahWrapper").setAttribute("visible", "false");
          document.querySelector("#UIbiruWrapper").setAttribute("visible", "false");
          document.querySelector("#settingsPanel").setAttribute("visible", "false");
          document.querySelector("#UImerahWrapper").style.display = "none";
          document.querySelector("#UIbiruWrapper").style.display = "none";
          
          // Sembunyikan tombol-tombol Tumbukan saat kembali ke menu utama
          const btnPlayParent = document.querySelector("#btnPlay").parentElement;
          const btnKembali3Parent = document.querySelector("#btnKembali3").parentElement;
          if (btnPlayParent) btnPlayParent.setAttribute("visible", "false");
          if (btnKembali3Parent) btnKembali3Parent.setAttribute("visible", "false");
          
          document.querySelector("#btnBab2").classList.add("clickable"); 
          document.querySelector("#btnBab3").classList.add("clickable"); 
          removeAllBab3Clickables();
        });

        // Event listeners for collision type selection
        document.querySelector('#btnElastic').addEventListener('click', () => {
          collisionType = 'elastic';
          coefficientOfRestitution = 1.0;
          updateCollisionTypeDisplay();
          console.log('‚úÖ Collision type set to ELASTIC');
        });

        document.querySelector('#btnInelastic').addEventListener('click', () => {
          collisionType = 'inelastic';
          coefficientOfRestitution = 0.0;
          updateCollisionTypeDisplay();
          console.log('‚úÖ Collision type set to INELASTIC');
          console.log('Current collisionType variable:', collisionType);
          console.log('Current coefficient of restitution:', coefficientOfRestitution);
        });

        // Mass demo event listeners
        document.querySelector('#btnHeavyLight').addEventListener('click', () => {
          setMassDemo(10, 1, 2, -2); // Heavy ball 1, Light ball 2
          console.log('Demo set: Heavy (10kg) vs Light (1kg)');
        });

        document.querySelector('#btnEqualMass').addEventListener('click', () => {
          setMassDemo(5, 5, 2, -2); // Equal masses
          console.log('Demo set: Equal masses (5kg each)');
        });

        document.querySelector('#btnLightHeavy').addEventListener('click', () => {
          setMassDemo(1, 10, 2, -2); // Light ball 1, Heavy ball 2
          console.log('Demo set: Light (1kg) vs Heavy (10kg)');
        });
      }

      function setupInputHandlers() {
        // Input handlers sudah ditangani di setupEventListeners
      }

      // Function to show force arrows based on calculation state
      function showForceArrows(appliedForce, frictionForce, state) {
        const forceArrow = document.querySelector('#forceArrow');
        const frictionArrow = document.querySelector('#frictionArrow');
        const frictionLabel = document.querySelector('#frictionLabel');

        if (!forceArrow || !frictionArrow) {
          console.log('Force arrows not found in DOM');
          return;
        }

        // Show all visual elements
        forceArrow.setAttribute('visible', 'true');
        frictionArrow.setAttribute('visible', 'true');

        // Scale arrows based on force magnitude (relative scaling)
        const baseScale = 1.5; // Base scale untuk panah (lebih kecil, lebih rapi)
        const forceScale = Math.max(0.6, Math.min(1.8, Math.abs(appliedForce) / 60)); // Scale between 0.6-1.8
        const frictionScale = Math.max(0.6, Math.min(1.8, Math.abs(frictionForce) / 60)); // Scale between 0.6-1.8

        // Update force arrow (F) - red arrow pointing right, scale X untuk panjang panah
        forceArrow.setAttribute('scale', `${forceScale * baseScale} ${baseScale} ${baseScale}`);

        // Update friction arrow (fs/fk) - blue arrow pointing left
        frictionArrow.setAttribute('scale', `${frictionScale * baseScale} ${baseScale} ${baseScale}`);

        // Update label based on state
        if (state === 'static') {
          frictionLabel.setAttribute('value', 'fs');
        } else if (state === 'moving') {
          frictionLabel.setAttribute('value', 'fk');
        }

        // Add pulsing animation to show active forces (subtle pulse)
        forceArrow.setAttribute('animation__pulse', {
          property: 'scale',
          to: `${forceScale * baseScale * 1.05} ${baseScale * 1.05} ${baseScale * 1.05}`,
          from: `${forceScale * baseScale} ${baseScale} ${baseScale}`,
          dur: 1500,
          direction: 'alternate',
          loop: true,
          easing: 'easeInOutSine'
        });

        frictionArrow.setAttribute('animation__pulse', {
          property: 'scale',
          to: `${frictionScale * baseScale * 1.05} ${baseScale * 1.05} ${baseScale * 1.05}`,
          from: `${frictionScale * baseScale} ${baseScale} ${baseScale}`,
          dur: 1500,
          direction: 'alternate',
          loop: true,
          easing: 'easeInOutSine'
        });

        console.log(`Force arrows displayed - F: ${appliedForce}N (scale: ${forceScale}), Friction: ${frictionForce}N (scale: ${frictionScale}), State: ${state}`);
      }

      // Function to hide force arrows when resetting
      function hideForceArrows() {
        const forceArrow = document.querySelector('#forceArrow');
        const frictionArrow = document.querySelector('#frictionArrow');

        if (forceArrow) {
          forceArrow.setAttribute('visible', 'false');
          forceArrow.removeAttribute('animation__pulse');
        }
        if (frictionArrow) {
          frictionArrow.setAttribute('visible', 'false');
          frictionArrow.removeAttribute('animation__pulse');
        }
      }

      // Coba load model GLB secara opsional
      function loadGLBModels() {
        const myModelEntity = document.querySelector('#myModel');
        if (!myModelEntity) return;
        
        // Coba load model bab2.glb
        const bab2Model = document.createElement('a-entity');
        bab2Model.setAttribute('id', 'glbBlockModel'); // ID ditambahkan untuk target animasi
        bab2Model.setAttribute('gltf-model', 'assets/scene2/balok.glb');
        bab2Model.setAttribute('position', '1.5 0 0');
        bab2Model.setAttribute('rotation', '0 90 0');
        bab2Model.setAttribute('scale', '3.5 3.5 3.5');
        bab2Model.setAttribute('material', 'depthTest: true');
        bab2Model.setAttribute('class', 'collidable');
        
        bab2Model.addEventListener('model-loaded', () => {
          console.log('Bab2 model loaded successfully');
          // Sembunyikan fallback model
          if (blockModel) blockModel.setAttribute('visible', 'false');
          modelsLoaded = true;
        });
        
        bab2Model.addEventListener('model-error', (e) => {
          console.log('Bab2 model failed to load, using fallback');
          // Tetap gunakan fallback model
        });
        
        myModelEntity.appendChild(bab2Model);

        // Add arrow to show movement direction
        const arrowModel = document.createElement('a-entity');
        arrowModel.setAttribute('id', 'directionArrow');
        arrowModel.setAttribute('gltf-model', 'assets/scene2/arrow.glb');
        arrowModel.setAttribute('position', '1.5 1 0'); // Above the block
        arrowModel.setAttribute('rotation', '0 90 0'); // Point in movement direction
        arrowModel.setAttribute('scale', '2 2 2');
        arrowModel.setAttribute('visible', 'false'); // Initially hidden

        arrowModel.addEventListener('model-loaded', () => {
          console.log('Arrow model loaded successfully');
        });

        arrowModel.addEventListener('model-error', (e) => {
          console.log('Arrow model failed to load');
        });

        myModelEntity.appendChild(arrowModel);

        // Coba load environment model
        const environment = document.querySelector('#environment');
        if (environment) {
          const classModel = document.createElement('a-entity');
          classModel.setAttribute('gltf-model', 'assets/scene2/class.glb');
          classModel.setAttribute('position', '0 0.95 7');
          classModel.setAttribute('scale', '5 5 5');
          classModel.setAttribute('rotation', '0 90 0');
          classModel.setAttribute('static-body', 'shape: mesh');
          classModel.setAttribute('material', 'depthTest: true');
          classModel.setAttribute('class', 'collidable');
          
          classModel.addEventListener('model-loaded', () => {
            console.log('Sekolah model loaded successfully');
            const fallbackEnv = document.querySelector('#fallback-environment');
            if (fallbackEnv) fallbackEnv.setAttribute('visible', 'false');
          });
          
          environment.appendChild(classModel);
        }
      }

      // Initialize mobile controls
      function setupMobileControls() {
        const camera = document.querySelector('[camera]');
        const rig = document.getElementById('rig');

        if (!camera) {
          console.error('Camera element not found');
          return;
        }

        let joystick = null;
        const movementSpeed = 0.1;
        let isMobile = false;
        
        // Initialize joystick
        function initJoystick() {
          joystick = new JoyStick('joystick', {
            title: 'joystick',
            width: 150,
            height: 150,
            internalFillColor: 'rgba(255, 255, 255, 0.5)',
            internalLineWidth: 2,
            internalStrokeColor: '#FFFFFF',
            externalLineWidth: 2,
            externalStrokeColor: 'rgba(255, 255, 255, 0.3)',
            autoReturnToCenter: true
          }, function (stickData) {
            if (stickData.x !== 0 || stickData.y !== 0) {
              updateCameraMovement(stickData.x, stickData.y);
            }
          });
        }
        
        // Update camera movement based on joystick input
        function updateCameraMovement(x, y) {
          if (!camera) return;
          
          const cameraEl = camera.object3D;
          const direction = new THREE.Vector3();
          cameraEl.getWorldDirection(direction);
          
          // Project direction onto XZ plane (ignore Y-axis for movement)
          const forward = new THREE.Vector3(direction.x, 0, direction.z).normalize();
          
          // Calculate movement vector based on joystick input (no inversion for Y-axis)
          const movementSpeed = 0.1;
          const moveX = x * movementSpeed;
          const moveZ = y * movementSpeed;
          
          // Strafe movement (left/right) - use camera right vector
          const right = new THREE.Vector3();
          right.crossVectors(new THREE.Vector3(0, 1, 0), forward).normalize();
          
          // Calculate final movement direction
          const movement = new THREE.Vector3();
          // Forward/backward movement based on camera forward (positive Z is forward)
          movement.addScaledVector(forward, moveZ);
          // Left/right strafing (positive X is right)
          movement.addScaledVector(right, moveX);
          
          // Apply movement to camera position
          const currentPosition = camera.getAttribute('position');
          camera.setAttribute('position', {
            x: currentPosition.x + movement.x,
            y: currentPosition.y,  // Keep Y position the same (no flying)
            z: currentPosition.z + movement.z
          });
        }
        
        // Show joystick for mobile devices
        function checkDeviceType() {
          const deviceType = localStorage.getItem('deviceType');
          isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

          console.log('Device type from localStorage:', deviceType);
          console.log('Is mobile device:', isMobile);

          // Show joystick if:
          // 1. User selected 'mobile' in localStorage, OR
          // 2. Device is detected as mobile (regardless of localStorage)
          if (deviceType === 'mobile' || isMobile) {
            console.log('Showing joystick for mobile device');
            document.getElementById('mobile-controls').style.display = 'block';
            initJoystick();
          } else {
            console.log('Hiding joystick for desktop');
            document.getElementById('mobile-controls').style.display = 'none';
          }
        }

        // Initialize mobile controls
        checkDeviceType();
        
        // Start animation loop for smooth movement
        function animate() {
          requestAnimationFrame(animate);
        }
        animate();
      }

      // Load models dan setup mobile controls setelah DOM ready
      document.addEventListener('DOMContentLoaded', () => {
        loadGLBModels();
        createSpeedTrails();
        setupMobileControls();
      });

      // Fungsi untuk membuat efek garis kecepatan
      function createSpeedTrails() {
        // Buat trail untuk ball1
        const trail1 = document.createElement('a-entity');
        trail1.setAttribute('id', 'trail1');
        trail1.setAttribute('position', '-2 0.3 -3');
        trail1.setAttribute('visible', 'false');
        document.querySelector('a-scene').appendChild(trail1);

        // Buat trail untuk ball2
        const trail2 = document.createElement('a-entity');
        trail2.setAttribute('id', 'trail2');
        trail2.setAttribute('position', '2 0.3 -3');
        trail2.setAttribute('visible', 'false');
        document.querySelector('a-scene').appendChild(trail2);

        // Buat beberapa segmen trail untuk setiap bola
        for (let i = 0; i < 12; i++) {
          // Trail segments untuk ball1 dengan variasi ukuran dan opacity
          const segment1 = document.createElement('a-cylinder');
          segment1.setAttribute('id', `trail1-segment-${i}`);
          segment1.setAttribute('radius', `${0.03 - i * 0.002}`); // Semakin mengecil
          segment1.setAttribute('height', `${0.4 - i * 0.02}`); // Semakin pendek
          segment1.setAttribute('rotation', '0 0 90');
          segment1.setAttribute('material', {
            color: '#ff4444',
            opacity: Math.max(0.9 - i * 0.07, 0.1),
            transparent: true,
            emissive: '#ff2222',
            emissiveIntensity: 0.3
          });
          segment1.setAttribute('visible', 'false');
          trail1.appendChild(segment1);

          // Trail segments untuk ball2 dengan variasi ukuran dan opacity
          const segment2 = document.createElement('a-cylinder');
          segment2.setAttribute('id', `trail2-segment-${i}`);
          segment2.setAttribute('radius', `${0.03 - i * 0.002}`);
          segment2.setAttribute('height', `${0.4 - i * 0.02}`);
          segment2.setAttribute('rotation', '0 0 90');
          segment2.setAttribute('material', {
            color: '#4444ff',
            opacity: Math.max(0.9 - i * 0.07, 0.1),
            transparent: true,
            emissive: '#2222ff',
            emissiveIntensity: 0.3
          });
          segment2.setAttribute('visible', 'false');
          trail2.appendChild(segment2);
        }
      }

      // Fungsi untuk menampilkan trail berdasarkan kecepatan
      function showSpeedTrails(ballId, velocity, position) {
        const trail = document.querySelector(`#trail${ballId}`);
        const absVelocity = Math.abs(velocity);
        
        if (absVelocity > 0.5) { // Tampilkan trail bahkan pada kecepatan rendah
          trail.setAttribute('visible', 'true');
          trail.setAttribute('position', position);
          
          // Animasikan setiap segment dengan delay dan efek yang lebih smooth
          for (let i = 0; i < 12; i++) {
            const segment = document.querySelector(`#trail${ballId}-segment-${i}`);
            segment.setAttribute('visible', 'true');
            
            // Posisi awal berdasarkan kecepatan dan indeks
            const initialOffset = -i * 0.15 * Math.sign(velocity);
            const finalOffset = -(i + 6) * 0.15 * Math.sign(velocity);
            
            setTimeout(() => {
              segment.setAttribute('animation__move', {
                property: 'position',
                from: `${initialOffset} 0 0`,
                to: `${finalOffset} 0 0`,
                dur: 1500,
                easing: 'easeOutQuart'
              });
              
              // Animasi fade out yang lebih smooth
              segment.setAttribute('animation__fade', {
                property: 'material.opacity',
                to: '0',
                dur: 1500,
                delay: 200,
                easing: 'easeOutQuart'
              });
              
              // Animasi scale untuk efek menghilang
              segment.setAttribute('animation__scale', {
                property: 'scale',
                to: '0.5 0.5 0.5',
                dur: 1500,
                delay: 400,
                easing: 'easeOutQuart'
              });
            }, i * 30); // Delay lebih pendek untuk efek yang lebih fluid
          }
                
          // Sembunyikan trail setelah animasi selesai
          setTimeout(() => {
            trail.setAttribute('visible', 'false');
            for (let i = 0; i < 12; i++) {
              const segment = document.querySelector(`#trail${ballId}-segment-${i}`);
              segment.setAttribute('visible', 'false');
              segment.removeAttribute('animation__move');
              segment.removeAttribute('animation__fade');
              segment.removeAttribute('animation__scale');
              // Reset scale
              segment.setAttribute('scale', '1 1 1');
            }
          }, 2500);
        }
      }

      // Fungsi untuk membuat efek memantul
      function createBounceEffect(ballElement, intensity = 1) {
        const enhancedIntensity = Math.min(intensity * 1.5, 3); // Perkuat intensitas
        
        // Efek skala memantul yang lebih dramatis
        ballElement.setAttribute('animation__bounce_scale', {
          property: 'scale',
          from: `${1 + enhancedIntensity * 0.4} ${0.6 - enhancedIntensity * 0.1} ${1 + enhancedIntensity * 0.4}`,
          to: '1 1 1',
          dur: 300,
          easing: 'easeOutQuad'
        });
        
        // Efek partikel sederhana
        createImpactParticles(ballElement);
      }

      // Fungsi untuk membuat partikel saat impact
      function createImpactParticles(ballElement) {
        const ballPosition = ballElement.getAttribute('position');
        
        // Buat beberapa partikel kecil
        for (let i = 0; i < 6; i++) {
          const particle = document.createElement('a-sphere');
          particle.setAttribute('radius', '0.05');
          particle.setAttribute('position', `${ballPosition.x} ${ballPosition.y} ${ballPosition.z}`);
          particle.setAttribute('material', 'color: #ffff00; emissive: #ffaa00; opacity: 0.8; transparent: true');
          
          // Animasi partikel terbang
          const randomX = (Math.random() - 0.5) * 2;
          const randomY = Math.random() * 1 + 0.5;
          const randomZ = (Math.random() - 0.5) * 2;
          
          particle.setAttribute('animation__fly', {
            property: 'position',
            to: `${ballPosition.x + randomX} ${ballPosition.y + randomY} ${ballPosition.z + randomZ}`,
            dur: 800,
            easing: 'easeOutQuart'
          });
          
          particle.setAttribute('animation__fade', {
            property: 'material.opacity',
            to: '0',
            dur: 800,
            easing: 'easeOutQuart'
          });
          
          particle.setAttribute('animation__shrink', {
            property: 'scale',
            to: '0.1 0.1 0.1',
            dur: 800,
            easing: 'easeOutQuart'
          });
          
          document.querySelector('a-scene').appendChild(particle);
          
          // Hapus partikel setelah animasi selesai
          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 1000);
        }
      }

      // Fungsi untuk efek gandengan inelastis
      function createInelasticJointEffect() {
        console.log('üîó Creating inelastic joint effect - balls will be connected temporarily');

        // Buat garis penghubung antara kedua bola
        const connector = document.createElement('a-cylinder');
        connector.setAttribute('id', 'inelasticConnector');
        connector.setAttribute('position', '0 0.3 -3'); // Di tengah antara bola
        connector.setAttribute('rotation', '0 0 90'); // Horizontal
        connector.setAttribute('radius', '0.02');
        connector.setAttribute('height', '0.5'); // Panjang garis sesuai jarak pusat bola bersentuhan
        connector.setAttribute('material', 'color: #ffff00; opacity: 0.9; transparent: true; emissive: #ffaa00');
        connector.setAttribute('visible', 'true');

        // Animasi garis penghubung untuk memberikan efek "welding" yang cepat
        connector.setAttribute('animation__glow', {
          property: 'material.emissive',
          from: '#ffaa00',
          to: '#ff0000',
          dur: 150,
          dir: 'alternate',
          loop: true
        });

        // Tambahkan ke scene
        document.querySelector('a-scene').appendChild(connector);

        // Efek partikel untuk "pengelasan" yang lebih sedikit dan cepat
        setTimeout(() => {
          for (let i = 0; i < 3; i++) {
            createWeldingParticle(i);
          }
        }, 50);

        // Hilangkan garis setelah 0.3 detik - efek sekejap untuk impact moment
        setTimeout(() => {
          if (connector && connector.parentNode) {
            console.log('üóëÔ∏è Removing inelastic connector line after 0.3 seconds (quick impact effect)');

            // Animasi fade out cepat
            connector.setAttribute('animation__fadeout', {
              property: 'material.opacity',
              to: '0',
              dur: 150,
              easing: 'easeOutQuad'
            });

            // Hapus setelah fade out selesai
            setTimeout(() => {
              if (connector && connector.parentNode) {
                connector.parentNode.removeChild(connector);
              }
            }, 200);
          }
        }, 300);
      }

      // Fungsi untuk membuat partikel efek pengelasan
      function createWeldingParticle(index) {
        const particle = document.createElement('a-sphere');
        particle.setAttribute('id', `weldParticle${index}`);
        particle.setAttribute('radius', '0.02');
        particle.setAttribute('position', `${(Math.random() - 0.5) * 0.4} 1 -3`); // Random di sekitar titik tumbukan
        particle.setAttribute('material', 'color: #ffff00; emissive: #ff6600; transparent: true; opacity: 0.8');

        // Animasi partikel beterbangan yang lebih cepat
        particle.setAttribute('animation__fly', {
          property: 'position',
          to: `${(Math.random() - 0.5) * 1.5} ${1 + Math.random() * 0.5} ${-3 + (Math.random() - 0.5) * 0.5}`,
          dur: 400,
          easing: 'easeOutQuad'
        });

        // Animasi fade out yang lebih cepat
        particle.setAttribute('animation__fade', {
          property: 'material.opacity',
          to: '0',
          dur: 400,
          easing: 'easeOutQuad'
        });

        document.querySelector('a-scene').appendChild(particle);

        // Hapus partikel setelah animasi selesai
        setTimeout(() => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
        }, 450);
        
        // Efek pulsing pada garis penghubung
        connector.setAttribute('animation__pulse', {
          property: 'material.opacity',
          from: '0.8',
          to: '0.3',
          dur: 600,
          loop: true,
          easing: 'easeInOutSine'
        });
        
        // Timer untuk menghentikan pulsing setelah beberapa loop
        setTimeout(() => {
          connector.setAttribute('animation__pulse', {
            property: 'material.opacity',
            to: '0.8',
            dur: 300,
            easing: 'easeInOutSine'
          });
        }, 2400); // 4 loops @ 600ms each
        
        // Efek deformasi pada bola untuk menunjukkan "lengket"
        if (ball1) {
          ball1.setAttribute('animation__deform1', {
            property: 'scale',
            from: '1 1 1',
            to: '1.1 0.9 1.1', // Agak gepeng
            dur: 200,
            easing: 'easeInOutQuad'
          });
          
          setTimeout(() => {
            ball1.setAttribute('animation__deform2', {
              property: 'scale',
              to: '1 1 1',
              dur: 200,
              easing: 'easeInOutQuad'
            });
          }, 200);
        }
        
        if (ball2) {
          ball2.setAttribute('animation__deform1', {
            property: 'scale',
            from: '1 1 1',
            to: '1.1 0.9 1.1', // Agak gepeng
            dur: 200,
            easing: 'easeInOutQuad'
          });
          
          setTimeout(() => {
            ball2.setAttribute('animation__deform2', {
              property: 'scale',
              to: '1 1 1',
              dur: 200,
              easing: 'easeInOutQuad'
            });
          }, 200);
        }
        
        // Efek partikel "lem" di titik kontak
        createStickyParticles();
        
        // Hapus efek setelah beberapa detik
        setTimeout(() => {
          if (connector.parentNode) {
            connector.parentNode.removeChild(connector);
          }
        }, 3000);
      }
      
      // Fungsi untuk partikel "lengket" 
      function createStickyParticles() {
        for (let i = 0; i < 8; i++) {
          const particle = document.createElement('a-sphere');
          particle.setAttribute('radius', '0.02');
          particle.setAttribute('position', `${(Math.random() - 0.5) * 0.3} 0.3 -3`);
          particle.setAttribute('material', 'color: #ffcc00; emissive: #ff8800; opacity: 0.9; transparent: true');
          
          // Animasi partikel lengket yang bergerak perlahan
          particle.setAttribute('animation__float', {
            property: 'position',
            to: `${(Math.random() - 0.5) * 0.6} ${1 + Math.random() * 0.3} -3`,
            dur: 2000 + Math.random() * 1000,
            easing: 'easeOutQuart'
          });
          
          particle.setAttribute('animation__fade', {
            property: 'material.opacity',
            to: '0',
            dur: 2500,
            easing: 'easeOutQuart'
          });
          
          document.querySelector('a-scene').appendChild(particle);
          
          // Hapus partikel setelah animasi selesai
          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 3000);
        }
      }

      // Fungsi helper
      function hitungKecepatan(m1, v1, m2, v2) {
        let v1p, v2p;
        
        if (collisionType === 'elastic') {
          // Rumus tumbukan elastis
          v1p = ((m1 - m2) * v1 + 2 * m2 * v2) / (m1 + m2);
          v2p = ((m2 - m1) * v2 + 2 * m1 * v1) / (m1 + m2);
        } else {
          // Tumbukan inelastis - bola bergandengan tetapi tidak menyatu sepenuhnya
          const vFinal = (m1 * v1 + m2 * v2) / (m1 + m2);
          // Bola bergerak dengan kecepatan hampir sama tapi ada sedikit perbedaan
          // untuk menciptakan efek bergandengan
          v1p = vFinal * 0.98; // Ball1 sedikit lebih lambat
          v2p = vFinal * 1.02; // Ball2 sedikit lebih cepat
        }
        
        // Debug: Verifikasi kekekalan momentum
        const momentumBefore = m1 * v1 + m2 * v2;
        const momentumAfter = m1 * v1p + m2 * v2p;
        console.log(`\n=== MASS EFFECT ANALYSIS ===`);
        console.log(`Collision Type: ${collisionType}`);
        console.log(`Input: m1=${m1}kg@${v1}m/s, m2=${m2}kg@${v2}m/s`);
        console.log(`Output: v1'=${v1p.toFixed(3)}m/s, v2'=${v2p.toFixed(3)}m/s`);
        
        // Mass effect analysis
        const massRatio = m1 / m2;
        const velocityChange1 = Math.abs(v1p - v1);
        const velocityChange2 = Math.abs(v2p - v2);
        
        console.log(`Mass Ratio (m1/m2): ${massRatio.toFixed(3)}`);
        console.log(`Velocity Change: Ball1=${velocityChange1.toFixed(3)}m/s, Ball2=${velocityChange2.toFixed(3)}m/s`);
        
        if (massRatio > 3) {
          console.log(`MASS EFFECT: Heavy Ball1 dominates - small velocity change`);
        } else if (massRatio < 0.33) {
          console.log(`MASS EFFECT: Light Ball1 bounces hard - large velocity change`);
        } else {
          console.log(`MASS EFFECT: Similar masses - moderate velocity exchange`);
        }
        
        console.log(`Momentum check: before=${momentumBefore.toFixed(3)}, after=${momentumAfter.toFixed(3)}, diff=${(momentumAfter-momentumBefore).toFixed(6)}`);
        
        // Calculate kinetic energy
        const keBefore = 0.5 * m1 * v1 * v1 + 0.5 * m2 * v2 * v2;
        const keAfter = 0.5 * m1 * v1p * v1p + 0.5 * m2 * v2p * v2p;
        console.log(`Kinetic Energy: before=${keBefore.toFixed(3)}J, after=${keAfter.toFixed(3)}J, lost=${(keBefore-keAfter).toFixed(3)}J`);
        
        return [v1p, v2p];
      }

      // Fungsi untuk efek collision yang dramatis
      function triggerCollisionEffects() {
        // Play collision sound with safety check
        const soundEntity = document.querySelector('#collisionParticles');
        if (soundEntity && soundEntity.components && soundEntity.components.sound) {
          try {
            soundEntity.components.sound.playSound();
          } catch (error) {
            console.log('Sound not ready yet, skipping collision sound');
          }
        }
        
        // Enhanced collision effects based on collision type and parameters
        const massRatio1 = Math.abs(m1 - m2) / Math.min(m1, m2);
        const massRatio2 = Math.abs(m2 - m1) / Math.min(m1, m2);
        const impactVelocity = Math.abs(v1) + Math.abs(v2);

        // Calculate damage for inelastic collisions
        if (collisionType === 'inelastic' && impactVelocity > 0.5) {
          // Apply damage to ball1
          if (ball1 && ball1.components && ball1.components['ball-damage']) {
            const damageType1 = ball1.components['ball-damage'].calculateDamageType(massRatio1, impactVelocity);
            ball1.components['ball-damage'].applyDamage(damageType1, {x: 0, y: 1, z: -3});
            console.log(`Ball1 damage applied: ${damageType1}`);
          }

          // Apply damage to ball2
          if (ball2 && ball2.components && ball2.components['ball-damage']) {
            const damageType2 = ball2.components['ball-damage'].calculateDamageType(massRatio2, impactVelocity);
            ball2.components['ball-damage'].applyDamage(damageType2, {x: 0, y: 1, z: -3});
            console.log(`Ball2 damage applied: ${damageType2}`);
          }

          // Enhanced particle effects for damage
          if (impactVelocity > 2) {
            // Create additional debris particles
            createDebrisEffect({x: 0, y: 1, z: -3}, impactVelocity);
          }
        } else {
          // Standard deformation for elastic collisions or low-impact inelastic
          if (ball1 && ball1.components && ball1.components['ball-deformation']) {
            ball1.components['ball-deformation'].deform('impact');
          }
          if (ball2 && ball2.components && ball2.components['ball-deformation']) {
            ball2.components['ball-deformation'].deform('impact');
          }
        }
        
        // Calculate collision intensity based on momentum change
        const momentumChange = Math.abs((m1 * v1 + m2 * v2));
        const collisionIntensity = Math.min(momentumChange / 2, 5);

        // Enhanced lighting flash based on intensity
        const flashLight = document.querySelector('#collisionFlash');
        if (flashLight) {
          const flashIntensity = 2.0 + collisionIntensity;
          flashLight.setAttribute('animation__flash', {
            property: 'light.intensity',
            to: flashIntensity.toFixed(2),
            dur: 60,
            easing: 'easeOutQuad'
          });

          setTimeout(() => {
            flashLight.setAttribute('animation__fade', {
              property: 'light.intensity',
              to: '0',
              dur: 500,
              easing: 'easeOutCubic'
            });
          }, 60);
        }

        // Shockwave ring effect
        const shockwave = document.querySelector('#collisionShockwave');
        if (shockwave) {
          shockwave.setAttribute('visible', 'true');
          shockwave.setAttribute('opacity', '0.8');
          shockwave.setAttribute('radius-inner', '0.1');
          shockwave.setAttribute('radius-outer', '0.15');

          // Expand shockwave
          shockwave.setAttribute('animation__expand', {
            property: 'radius-outer',
            to: '1.5',
            dur: 600,
            easing: 'easeOutQuad'
          });

          shockwave.setAttribute('animation__fade', {
            property: 'opacity',
            to: '0',
            dur: 600,
            easing: 'easeOutQuad'
          });

          setTimeout(() => {
            shockwave.setAttribute('visible', 'false');
          }, 650);
        }

        // Glow sphere effect at impact point
        const glow = document.querySelector('#collisionGlow');
        if (glow) {
          glow.setAttribute('visible', 'true');
          glow.setAttribute('opacity', '0.9');
          glow.setAttribute('radius', '0.2');

          // Pulse and fade
          glow.setAttribute('animation__pulse', {
            property: 'radius',
            to: '0.4',
            dur: 200,
            easing: 'easeOutQuad'
          });

          glow.setAttribute('animation__fade', {
            property: 'opacity',
            to: '0',
            dur: 400,
            easing: 'easeOutCubic'
          });

          setTimeout(() => {
            glow.setAttribute('visible', 'false');
          }, 450);
        }
        
        // Show particle explosion at collision point
        const particles = document.querySelector('#collisionParticles');
        if (particles) {
          particles.setAttribute('visible', true);
          particles.setAttribute('position', '0 0.3 -3'); // Collision point
          
          // Start particle emission
          particles.setAttribute('particle-system', {
            preset: 'spark',
            particleCount: 400,
            maxAge: 3,
            accelerationValue: '0, -18, 0',
            velocityValue: '12 12 12',
            velocitySpread: '6 6 6',
            size: '0.25, 0.01',
            color: '#FFD700, #FF6347, #FF0000, #FFFFFF, #FFA500, #FF1493',
            opacity: '1.0, 0.0'
          });
        }
        
        // Screen shake effect untuk drama dengan multiple pulses
        const camera = document.querySelector('[camera]');
        if (camera) {
          // First shake
          camera.setAttribute('animation__shake1', {
            property: 'rotation',
            to: '1.0 1.0 1.0',
            dur: 60,
            easing: 'easeInOutQuad'
          });
          
          setTimeout(() => {
            camera.setAttribute('animation__shake2', {
              property: 'rotation',
              to: '-0.5 -0.5 -0.5',
              dur: 40,
              easing: 'easeInOutQuad'
            });
          }, 60);
          
          setTimeout(() => {
            camera.setAttribute('animation__shake-back', {
              property: 'rotation',
              to: '0 0 0',
              dur: 350,
              easing: 'easeOutBounce'
            });
          }, 100);
        }
        
        // Hide particles after effect
        setTimeout(() => {
          if (particles) particles.setAttribute('visible', false);
        }, 3000);
      }

      // Create debris effect for high-impact collisions
      function createDebrisEffect(collisionPoint, intensity) {
        const debrisCount = Math.min(Math.floor(intensity * 5), 20);

        for (let i = 0; i < debrisCount; i++) {
          const debris = document.createElement('a-sphere');
          debris.setAttribute('radius', Math.random() * 0.05 + 0.02);
          debris.setAttribute('position', {
            x: collisionPoint.x + (Math.random() - 0.5) * 0.3,
            y: collisionPoint.y + (Math.random() - 0.5) * 0.3,
            z: collisionPoint.z + (Math.random() - 0.5) * 0.3
          });
          debris.setAttribute('material', {
            color: Math.random() > 0.5 ? '#888888' : '#666666',
            opacity: 0.9
          });

          // Random debris motion
          debris.setAttribute('animation', {
            property: 'position',
            to: {
              x: collisionPoint.x + (Math.random() - 0.5) * 4,
              y: collisionPoint.y - Math.random() * 3,
              z: collisionPoint.z + (Math.random() - 0.5) * 4
            },
            dur: 1500 + Math.random() * 1000,
            easing: 'easeOutQuad'
          });

          debris.setAttribute('animation__fade', {
            property: 'material.opacity',
            to: 0,
            dur: 2000,
            delay: 500
          });

          document.querySelector('a-scene').appendChild(debris);

          // Clean up debris
          setTimeout(() => {
            if (debris.parentNode) {
              debris.parentNode.removeChild(debris);
            }
          }, 3000);
        }
      }

      // Fungsi untuk menampilkan trail bola
      function showTrail(trailId, startPosition) {
        const trail = document.querySelector(`#${trailId}`);
        if (!trail) return;
        
        trail.setAttribute('visible', true);
        trail.setAttribute('position', startPosition);
        
        // Configure trail particle system
        trail.setAttribute('particle-system', {
          preset: 'default',
          particleCount: 80,
          maxAge: 3,
          accelerationValue: '0, -2, 0',
          velocityValue: '0 0 0',
          velocitySpread: '0.3 0.3 0.3',
          size: '0.08, 0.02',
          color: trailId === 'trail1' ? '#cc2f2f, #ff8888' : '#4545ff, #8888ff',
          opacity: '0.9, 0.0'
        });
        
        // Hide trail after some time
        setTimeout(() => {
          trail.setAttribute('visible', false);
        }, 3000);
      }

      // Fungsi untuk trail pre-collision yang lebih intens
      function showPreCollisionTrail(trailId, startPosition) {
        const trail = document.querySelector(`#${trailId}`);
        if (!trail) return;
        
        trail.setAttribute('visible', true);
        trail.setAttribute('position', startPosition);
        
        // Configure intense pre-collision trail
        trail.setAttribute('particle-system', {
          preset: 'default',
          particleCount: 120,
          maxAge: 2.5,
          accelerationValue: '0, -1, 0',
          velocityValue: '0 0 -2',
          velocitySpread: '0.2 0.2 0.5',
          size: '0.12, 0.03',
          color: trailId === 'trail1' ? '#cc2f2f, #ff4444, #ffaaaa' : '#4545ff, #6666ff, #aaaaff',
          opacity: '1.0, 0.0'
        });
        
        // Keep trail active during movement
        setTimeout(() => {
          trail.setAttribute('visible', false);
        }, 2200);
      }

      function updateLabel() {
        if (label1) label1.setAttribute("value", `m1 = ${m1}kg\nv1 = ${v1}m/s`);
        if (label2) label2.setAttribute("value", `m2 = ${m2}kg\nv2 = ${v2}m/s`);
        
        // Update ukuran bola saat label berubah
        updateBallSizes();
      }

      function updateInputDisplays() {
        // Update display text di input fields dengan unit
        const inputM1Text = document.querySelector('#inputM1Text');
        const inputV1Text = document.querySelector('#inputV1Text');
        const inputM2Text = document.querySelector('#inputM2Text');
        const inputV2Text = document.querySelector('#inputV2Text');
        
        if (inputM1Text) inputM1Text.setAttribute('value', m1.toFixed(1) + ' kg');
        if (inputV1Text) inputV1Text.setAttribute('value', v1.toFixed(1) + ' m/s');
        if (inputM2Text) inputM2Text.setAttribute('value', m2.toFixed(1) + ' kg');
        if (inputV2Text) inputV2Text.setAttribute('value', v2.toFixed(1) + ' m/s');
        
        // Update ukuran bola berdasarkan massa (radius proporsional dengan massa)
        updateBallSizes();
        
        // Update result panel dengan data terbaru
        updateResultPanel();
      }

      function updateBallSizes() {
        if (!ball1 || !ball2) return; 
        
        // Radius base = 0.15, ditambah proporsional dengan massa
        const radius1 = 0.15 + (m1 * 0.02);  // 0.15 + (massa * 0.02)
        const radius2 = 0.15 + (m2 * 0.02);
        
        ball1.setAttribute('radius', radius1.toFixed(3));
        ball2.setAttribute('radius', radius2.toFixed(3));
        
        console.log(`Updated ball sizes: ball1 radius=${radius1.toFixed(3)} (m=${m1}), ball2 radius=${radius2.toFixed(3)} (m=${m2})`);
      }

      // Fungsi untuk update panel hasil tumbukkan
      function updateResultPanel() {
        if (!resultPanel) return;
        
        console.log('üìä updateResultPanel called with collision type:', collisionType);
        
        // Kalkulasi momentum dan energi sebelum tumbukkan
        const momentumBefore = m1 * v1 + m2 * v2;
        const energyBefore = 0.5 * m1 * v1 * v1 + 0.5 * m2 * v2 * v2;
        
        // Kalkulasi kecepatan setelah tumbukkan berdasarkan jenis tumbukkan
        let v1After, v2After;
        const totalMass = m1 + m2;
        
        if (collisionType === 'inelastic') {
          // Untuk tumbukan inelastis (e = 0), gunakan rumus khusus
          v1After = (m1 * v1 + m2 * v2) / totalMass;
          v2After = v1After; // Kecepatan sama setelah tumbukkan inelastis sempurna
          console.log('üîó Using inelastic collision formulas');
        } else {
          // Untuk tumbukan elastis (e = 1)
          v1After = ((m1 - m2) * v1 + 2 * m2 * v2) / totalMass;
          v2After = ((m2 - m1) * v2 + 2 * m1 * v1) / totalMass;
          console.log('‚ö° Using elastic collision formulas');
        }
        
        // Kalkulasi momentum dan energi setelah tumbukkan
        const momentumAfter = m1 * v1After + m2 * v2After;
        const energyAfter = 0.5 * m1 * v1After * v1After + 0.5 * m2 * v2After * v2After;
        
        // Cek konservasi (toleransi untuk error floating point)
        const momentumConserved = Math.abs(momentumBefore - momentumAfter) < 0.001;
        const energyConserved = Math.abs(energyBefore - energyAfter) < 0.001;
        
        // Kalkulasi koefisien restitusi aktual
        const restitution = v1 !== v2 ? Math.abs((v2After - v1After) / (v1 - v2)) : 0;
        
        console.log('üìà Calculation results:', {
          v1After: v1After.toFixed(3),
          v2After: v2After.toFixed(3),
          momentumConserved,
          energyConserved,
          restitution: restitution.toFixed(3)
        });
        
        // Simpan hasil untuk digunakan saat animasi
        collisionResults = {
          before: { momentum: momentumBefore, energy: energyBefore },
          after: { momentum: momentumAfter, energy: energyAfter, v1: v1After, v2: v2After },
          conservation: { momentum: momentumConserved, energy: energyConserved },
          collisionType: collisionType,
          restitution: restitution
        };
        
        // Update display sebelum tumbukkan
        if (beforeData) {
          beforeData.setAttribute('value', 
            `Bola 1: m=${m1}kg, v=${v1.toFixed(1)}m/s\n` +
            `Bola 2: m=${m2}kg, v=${v2.toFixed(1)}m/s\n` +
            `Momentum Total: ${momentumBefore.toFixed(2)} kg‚ãÖm/s\n` +
            `Energi Kinetik: ${energyBefore.toFixed(2)} J`
          );
        }
        
        // Update display sesudah tumbukkan
        if (afterData) {
          afterData.setAttribute('value', 
            `Bola 1: v'=${v1After.toFixed(2)}m/s\n` +
            `Bola 2: v'=${v2After.toFixed(2)}m/s\n` +
            `Momentum Total: ${momentumAfter.toFixed(2)} kg‚ãÖm/s\n` +
            `Energi Kinetik: ${energyAfter.toFixed(2)} J`
          );
        }
        
        // Update analisis konservasi
        if (conservationData) {
          const momentumIcon = momentumConserved ? '‚úÖ' : '‚ùå';
          const energyIcon = energyConserved ? '‚úÖ' : '‚ùå';
          
          // Label berdasarkan collision type yang dipilih user, bukan hasil kalkulasi
          const typeLabel = collisionType === 'inelastic' ? 'TUMBUKKAN INELASTIS' : 'TUMBUKKAN ELASTIS';
          
          conservationData.setAttribute('value', 
            `${momentumIcon} Momentum: ${momentumConserved ? 'KONSERVATIF' : 'TIDAK KONSERVATIF'}\n` +
            `${energyIcon} Energi: ${energyConserved ? 'KONSERVATIF' : 'TIDAK KONSERVATIF'}\n` +
            `üè∑Ô∏è  Jenis: ${typeLabel}`
          );
        }
        
        // Update koefisien restitusi
        if (restitutionData) {
          let restitutionType = '';
          if (restitution >= 0.9) restitutionType = '(Elastis Sempurna)';
          else if (restitution >= 0.5) restitutionType = '(Sebagian Elastis)';
          else if (restitution > 0.1) restitutionType = '(Sebagian Inelastis)';
          else restitutionType = '(Inelastis Sempurna)';
          
          restitutionData.setAttribute('value', `e = ${restitution.toFixed(2)} ${restitutionType}`);
        }
        
        console.log('Result panel updated with collision data');
      }
      
      // Fungsi untuk menampilkan/menyembunyikan panel hasil
      function showResultPanel() {
        console.log('üéØ showResultPanel called, resultPanel exists:', !!resultPanel);
        if (resultPanel) {
          resultPanel.setAttribute('visible', 'true');
          console.log('‚úÖ Result panel made visible');
          if (statusIndicator) {
            statusIndicator.setAttribute('value', '‚úÖ Simulasi selesai!');
            statusIndicator.setAttribute('color', '#4caf50');
          }
        } else {
          console.error('‚ùå Result panel not found!');
        }
      }
      
      function hideResultPanel() {
        if (resultPanel) {
          resultPanel.setAttribute('visible', 'false');
          if (statusIndicator) {
            statusIndicator.setAttribute('value', 'üîÑ Menunggu simulasi...');
            statusIndicator.setAttribute('color', '#ffd700');
          }
        }
      }

      // Event handlers untuk input boxes
      function resetBab3() {
        console.log('resetBab3() called from:', new Error().stack);
        animating = false;
        done = false;
        
        // Reset posisi bola ke posisi start yang konsisten
        if (ball1) ball1.setAttribute("position", "-3 0.3 -3");
        if (ball2) ball2.setAttribute("position", "3 0.3 -3");

        // Reset damage on balls
        if (ball1 && ball1.components && ball1.components['ball-damage']) {
          ball1.components['ball-damage'].reset();
          console.log('Ball1 damage reset');
        }
        if (ball2 && ball2.components && ball2.components['ball-damage']) {
          ball2.components['ball-damage'].reset();
          console.log('Ball2 damage reset');
        }
        
        // Hapus semua animasi
        if (ball1) {
          ball1.removeAttribute("animation__go");
          ball1.removeAttribute("animation__after");
          ball1.removeAttribute("animation__bounce");
          ball1.removeAttribute("animation__bounce-back");
          ball1.setAttribute("scale", "1 1 1");
        }
        if (ball2) {
          ball2.removeAttribute("animation__go");
          ball2.removeAttribute("animation__after");
          ball2.removeAttribute("animation__bounce");
          ball2.removeAttribute("animation__bounce-back");
          ball2.setAttribute("scale", "1 1 1");
        }
        
        // Reset trails dan effects
        console.log('Resetting all effects...');
        hideTrailEffects();
        
        // Hide result panel
        hideResultPanel();
        
        // Reset nilai default
        m1 = 1, v1 = 1;
        m2 = 1, v2 = -1;
        
        // Update displays dan ukuran bola
        updateInputDisplays();
        updateLabel();
        
        // Pastikan kontrol UI dan panel pengaturan terlihat kembali setelah reset
        document.querySelector("#UImerahWrapper").setAttribute("visible", "true");
        document.querySelector("#UIbiruWrapper").setAttribute("visible", "true");
        document.querySelector("#settingsPanel").setAttribute("visible", "true");
        
        // Pastikan tombol Play dan Kembali tetap visible setelah reset
        const btnPlayParent = document.querySelector("#btnPlay").parentElement;
        const btnKembali3Parent = document.querySelector("#btnKembali3").parentElement;
        if (btnPlayParent) {
          btnPlayParent.setAttribute("visible", "true");
          console.log('‚úÖ Play button parent made visible after reset');
        }
        if (btnKembali3Parent) {
          btnKembali3Parent.setAttribute("visible", "true");
          console.log('‚úÖ Kembali button parent made visible after reset');
        }
        
        // Aktifkan kembali semua tombol kontrol massa dan kecepatan
        const controlButtons = [
          "#btnM1Plus", "#btnM1Minus", "#btnV1Plus", "#btnV1Minus",
          "#btnM2Plus", "#btnM2Minus", "#btnV2Plus", "#btnV2Minus"
        ];
        controlButtons.forEach(selector => {
          const btn = document.querySelector(selector);
          if (btn) btn.classList.add("clickable");
        });
        
        // Pastikan tombol Play kembali clickable setelah reset
        const btnPlay = document.querySelector("#btnPlay");
        if (btnPlay) {
          btnPlay.classList.add("clickable");
          console.log('‚úÖ Play button made clickable after reset');
        }
        
        // Reset tombol text
        const btnPlayText = document.querySelector("#btnPlayText");
        if (btnPlayText) {
          btnPlayText.setAttribute("value", "Start");
          console.log('‚úÖ Play button text reset to "Start"');
        }
        
        console.log('Reset complete - returned to main menu');
      }

      function hideTrailEffects() {
        // Hide all trail effects
        const trail1 = document.querySelector('#trail1');
        const trail2 = document.querySelector('#trail2');
        const particles = document.querySelector('#collisionParticles');
        
        if (trail1) trail1.setAttribute('visible', 'false');
        if (trail2) trail2.setAttribute('visible', 'false');
        if (particles) particles.setAttribute('visible', 'false');
        
        // Reset collision flash light
        const flashLight = document.querySelector('#collisionFlash');
        if (flashLight) {
          flashLight.setAttribute('light', 'intensity: 0');
        }
        
        // Hapus efek inelastis jika ada
        const connector = document.querySelector('#inelasticConnector');
        if (connector && connector.parentNode) {
          connector.parentNode.removeChild(connector);
        }
        
        // Hide any trail segments
        for (let i = 0; i < 12; i++) {
          const segment1 = document.querySelector(`#trail1_${i}`);
          const segment2 = document.querySelector(`#trail2_${i}`);
          if (segment1) segment1.setAttribute('visible', 'false');
          if (segment2) segment2.setAttribute('visible', 'false');
        }
      }

      function removeAllBab3Clickables() {
        const bab3Buttons = [
          "#btnKembali3", "#btnPlay", "#btnM1Plus", "#btnM1Minus", 
          "#btnV1Plus", "#btnV1Minus"
        ];
        bab3Buttons.forEach(selector => {
          const btn = document.querySelector(selector);
          if (btn) btn.classList.remove("clickable");
        });
      }

      // Physics Guide Functions
      function updateCollisionTypeDisplay() {
        const elasticBtn = document.querySelector('#btnElastic');
        const inelasticBtn = document.querySelector('#btnInelastic');
        
        console.log('üé® Updating collision type display:', collisionType);
        console.log('Buttons found:', { elastic: !!elasticBtn, inelastic: !!inelasticBtn });
        
        if (elasticBtn && inelasticBtn) {
          if (collisionType === 'elastic') {
            elasticBtn.setAttribute('color', '#00ff88');
            elasticBtn.setAttribute('material', 'depthTest: true; color: #00ff88');
            inelasticBtn.setAttribute('color', '#4444ff');
            inelasticBtn.setAttribute('material', 'depthTest: true; color: #4444ff');
            console.log('‚úÖ Set to ELASTIC (green)');
          } else {
            elasticBtn.setAttribute('color', '#0088ff');
            elasticBtn.setAttribute('material', 'depthTest: true; color: #0088ff');
            inelasticBtn.setAttribute('color', '#ff4444');
            inelasticBtn.setAttribute('material', 'depthTest: true; color: #ff4444');
            console.log('‚úÖ Set to INELASTIC (red)');
          }
        }
      }

      function calculateMassEffect(m1, m2, v1, v2) {
        if (collisionType === 'elastic') {
          const v1p = ((m1 - m2) * v1 + 2 * m2 * v2) / (m1 + m2);
          const v2p = ((m2 - m1) * v2 + 2 * m1 * v1) / (m1 + m2);
          return [v1p, v2p];
        } else {
          const vFinal = (m1 * v1 + m2 * v2) / (m1 + m2);
          return [vFinal, vFinal];
        }
      }

      function setMassDemo(newM1, newM2, newV1, newV2) {
        // Set the demo values
        m1 = newM1;
        m2 = newM2;
        v1 = newV1;
        v2 = newV2;
        
        // Update displays
        updateInputDisplays();
        updateLabel();
        
        // Show prediction in console
        const [predictedV1, predictedV2] = calculateMassEffect(m1, m2, v1, v2);
        console.log(`\n=== MASS DEMO PREDICTION ===`);
        console.log(`Before: m1=${m1}kg at ${v1}m/s, m2=${m2}kg at ${v2}m/s`);
        console.log(`After: v1'=${predictedV1.toFixed(2)}m/s, v2'=${predictedV2.toFixed(2)}m/s`);
        console.log(`Mass Effect: ${m1 > m2 ? 'Heavy ball 1 barely moves' : m1 < m2 ? 'Light ball 1 bounces hard' : 'Equal masses exchange velocities'}`);
        
        // Tidak auto-reset, biarkan user mengklik tombol reset manual
        console.log('Demo values set. Click Reset button to clear animation if needed.');
      }

      // Clickable component for VR interactions
      AFRAME.registerComponent('clickable', {
        init: function () {
          // Handle VR cursor/controller clicks and mouse clicks
          this.el.addEventListener('click', (evt) => {
            const id = this.el.id;
            console.log('Clickable element clicked:', id);
            
            // Trigger button specific actions
            switch(id) {
              // Tombol Play/Reset
              case 'btnPlay':
                console.log('Play button clicked, done =', done);
                if (done) {
                  resetBab3();
                  return;
                }

                if (animating) return;

                animating = true;
                done = false;
                document.querySelector("#UImerahWrapper").setAttribute("visible", "false");
                document.querySelector("#UIbiruWrapper").setAttribute("visible", "false");
                document.querySelector("#settingsPanel").setAttribute("visible", "false");
                document.querySelector("#btnPlay").classList.remove("clickable"); 
                
                console.log(`\n=== HASIL TUMBUKAN ===`);
                console.log(`Input: m1=${m1}kg, v1=${v1}m/s, m2=${m2}kg, v2=${v2}m/s`);
                
                // Hitung kecepatan setelah tumbukan
                const [v1p, v2p] = hitungKecepatan(m1, v1, m2, v2);
                console.log(`Output: v1'=${v1p.toFixed(3)}m/s, v2'=${v2p.toFixed(3)}m/s`);
                console.log(`Momentum: ${(m1*v1 + m2*v2).toFixed(3)} ‚Üí ${(m1*v1p + m2*v2p).toFixed(3)} kg‚ãÖm/s`);
                
                // Set animasi menuju collision point (bersentuhan, tidak overlap)
                ball1.setAttribute("animation__go", {
                  property: "position",
                  to: "0.25 1 -3", // Ball1 center di +0.25, edge kiri di 0
                  dur: 2000,
                  easing: "linear"
                });

                ball2.setAttribute("animation__go", {
                  property: "position",
                  to: "-0.25 1 -3", // Ball2 center di -0.25, edge kanan di 0
                  dur: 2000,
                  easing: "linear"
                });
                
                // Set animasi setelah collision
                setTimeout(() => {
                  console.log('Setting post-collision animations...');
                  console.log(`Post-collision velocities: v1'=${v1p.toFixed(2)}, v2'=${v2p.toFixed(2)}`);
                  
                  // Animasi berdasarkan kecepatan akhir dengan skala yang lebih realistic
                  const distanceScale = 0.8; // Faktor skala untuk jarak
                  
                  if (Math.abs(v1p) > 0.01) {
                    const finalPos1 = v1p * distanceScale;
                    ball1.setAttribute("animation__after", {
                      property: "position", 
                      to: `${finalPos1} 0.3 -3`, 
                      dur: Math.abs(v1p) * 200 + 1000, // Durasi proporsional dengan kecepatan
                      easing: "easeOutQuad"
                    });
                    console.log(`Ball1 moving to position: ${finalPos1}`);
                  } else {
                    ball1.setAttribute("position", "0 0.3 -3");
                    console.log('Ball1 staying at collision point (v1p ‚âà 0)');
                  }
                  
                  if (Math.abs(v2p) > 0.01) {
                    const finalPos2 = v2p * distanceScale;
                    ball2.setAttribute("animation__after", {
                      property: "position", 
                      to: `${finalPos2} 0.3 -3`, 
                      dur: Math.abs(v2p) * 200 + 1000, // Durasi proporsional dengan kecepatan
                      easing: "easeOutQuad"
                    });
                    console.log(`Ball2 moving to position: ${finalPos2}`);
                  } else {
                    ball2.setAttribute("position", "0 0.3 -3");
                    console.log('Ball2 staying at collision point (v2p ‚âà 0)');
                  }

                  animating = false;
                  done = true;
                  document.querySelector("#btnPlayText").setAttribute("value", "Reset");
                  document.querySelector("#btnPlay").classList.add("clickable");
                  
                  console.log('üîÑ Second animation path finished, showing reset button and result panel');
                  
                  // Restore UI visibility setelah animasi selesai
                  document.querySelector("#UImerahWrapper").setAttribute("visible", "true");
                  document.querySelector("#UIbiruWrapper").setAttribute("visible", "true");
                  console.log('‚úÖ UI controls restored after second animation path');
                  
                  // Tampilkan panel hasil
                  showResultPanel(); 
                }, 2100);
                break;
              default:
                // For other buttons, try to trigger existing event listeners
                const button = document.querySelector(`#${id}`);
                if (button && button.click) {
                  button.click();
                }
                break;
            }
          });
          
          // Add visual feedback on hover (for VR cursor)
          this.el.addEventListener('mouseenter', () => {
            this.el.setAttribute('scale', '1.1 1.1 1.1');
          });
          
          this.el.addEventListener('mouseleave', () => {
            this.el.setAttribute('scale', '1 1 1');
          });
        }
      });

      // Smooth movement component untuk animasi yang lebih fluid
      AFRAME.registerComponent('smooth-movement', {
        schema: {
          targetPosition: { type: 'vec3' },
          duration: { default: 1000 },
          easing: { default: 'easeOutCubic' }
        },
        init: function () {
          this.startPosition = new THREE.Vector3();
          this.currentPosition = new THREE.Vector3();
          this.targetPosition = new THREE.Vector3();
          this.animationProgress = 0;
          this.isAnimating = false;
        },
        
        update: function () {
          if (this.data.targetPosition) {
            this.startPosition.copy(this.el.object3D.position);
            this.targetPosition.copy(this.data.targetPosition);
            this.animationProgress = 0;
            this.isAnimating = true;
            this.startTime = Date.now();
          }
        },
        
        tick: function () {
          if (!this.isAnimating) return;
          
          const elapsed = Date.now() - this.startTime;
          const progress = Math.min(elapsed / this.data.duration, 1);
          
          // Apply easing function
          let easedProgress;
          switch (this.data.easing) {
            case 'easeOutCubic':
              easedProgress = 1 - Math.pow(1 - progress, 3);
              break;
            case 'easeInCubic':
              easedProgress = progress * progress * progress;
              break;
            case 'easeInOutCubic':
              easedProgress = progress < 0.5 ? 
                4 * progress * progress * progress : 
                1 - Math.pow(-2 * progress + 2, 3) / 2;
              break;
            case 'easeOutBounce':
              const n1 = 7.5625;
              const d1 = 2.75;
              if (progress < 1 / d1) {
                easedProgress = n1 * progress * progress;
              } else if (progress < 2 / d1) {
                easedProgress = n1 * (progress -= 1.5 / d1) * progress + 0.75;
              } else if (progress < 2.5 / d1) {
                easedProgress = n1 * (progress -= 2.25 / d1) * progress + 0.9375;
              } else {
                easedProgress = n1 * (progress -= 2.625 / d1) * progress + 0.984375;
              }
              break;
            default:
              easedProgress = progress;
          }
          
          // Interpolate position
          this.currentPosition.lerpVectors(this.startPosition, this.targetPosition, easedProgress);
          this.el.object3D.position.copy(this.currentPosition);
          
          if (progress >= 1) {
            this.isAnimating = false;
            this.el.emit('smooth-movement-complete');
          }
        }
      });

      // Ball deformation component untuk efek realistis
      AFRAME.registerComponent('ball-deformation', {
        schema: {
          intensity: { default: 0.15 },
          duration: { default: 200 }
        },
        
        init: function () {
          this.originalScale = this.el.getAttribute('scale') || { x: 1, y: 1, z: 1 };
        },
        
        deform: function (direction = 'impact') {
          const intensity = this.data.intensity;
          let deformScale;
          
          if (direction === 'impact') {
            // Compression effect on impact
            deformScale = {
              x: 1 + intensity,
              y: 1 - intensity,
              z: 1 + intensity
            };
          } else {
            // Stretch effect during movement
            deformScale = {
              x: 1 - intensity * 0.5,
              y: 1,
              z: 1 + intensity
            };
          }
          
          this.el.setAttribute('animation__deform', {
            property: 'scale',
            to: `${deformScale.x} ${deformScale.y} ${deformScale.z}`,
            dur: this.data.duration / 2,
            easing: 'easeOutQuad'
          });
          
          // Return to normal
          setTimeout(() => {
            this.el.setAttribute('animation__reform', {
              property: 'scale',
              to: `${this.originalScale.x} ${this.originalScale.y} ${this.originalScale.z}`,
              dur: this.data.duration,
              easing: 'easeOutBounce'
            });
          }, this.data.duration / 2);
        }
      });

      // Ball damage system for inelastic collisions
      AFRAME.registerComponent('ball-damage', {
        schema: {
          massRatio: { default: 1.0 },      // Ratio between colliding balls
          impactVelocity: { default: 1.0 }, // Impact velocity
          damageThreshold: { default: 2.0 } // Threshold for damage effects
        },

        init: function () {
          this.originalGeometry = this.el.getAttribute('geometry');
          this.originalMaterial = this.el.getAttribute('material');
          this.isDamaged = false;
          this.isDestroyed = false;
        },

        // Calculate damage type based on mass ratio and impact
        calculateDamageType: function(massRatio, impactVelocity) {
          const impactForce = massRatio * impactVelocity;

          console.log('Impact Analysis:', {
            massRatio: massRatio,
            impactVelocity: impactVelocity,
            impactForce: impactForce
          });

          if (impactForce > 8) {
            return 'destroy'; // Complete destruction
          } else if (impactForce > 4) {
            return 'severe_damage'; // Severe cracking/breaking
          } else if (impactForce > 2) {
            return 'moderate_damage'; // Visible deformation
          } else if (impactForce > 0.5) {
            return 'minor_damage'; // Light denting
          } else {
            return 'no_damage'; // Just bounce
          }
        },

        // Apply damage effects based on type
        applyDamage: function(damageType, collisionPoint) {
          if (this.isDestroyed) return;

          console.log(`Applying ${damageType} to ball ${this.el.id}`);

          // Play appropriate sound effect
          this.playDamageSound(damageType);

          switch(damageType) {
            case 'destroy':
              this.destroyBall(collisionPoint);
              break;
            case 'severe_damage':
              this.severeDamage();
              break;
            case 'moderate_damage':
              this.moderateDamage();
              break;
            case 'minor_damage':
              this.minorDamage();
              break;
            default:
              // Just deformation effect
              if (this.el.components['ball-deformation']) {
                this.el.components['ball-deformation'].deform('impact');
              }
          }
        },

        // Complete ball destruction with fragments
        destroyBall: function(collisionPoint) {
          this.isDestroyed = true;

          // Hide original ball
          this.el.setAttribute('visible', false);

          // Create destruction particles
          this.createDestructionParticles(collisionPoint);

          // Create ball fragments
          this.createBallFragments();
        },

        // Severe damage - cracked appearance
        severeDamage: function() {
          this.isDamaged = true;

          // Change material to damaged appearance
          this.el.setAttribute('material', {
            color: this.originalMaterial.color || '#ff0000',
            roughness: 0.9,
            metalness: 0.1,
            opacity: 0.8
          });

          // Add crack texture overlay
          this.addCrackPattern();

          // Deform geometry
          this.el.setAttribute('geometry', {
            primitive: 'sphere',
            radius: (this.originalGeometry.radius || 0.25) * 0.9,
            segmentsWidth: 8,
            segmentsHeight: 6
          });
        },

        // Moderate damage - dented ball
        moderateDamage: function() {
          this.isDamaged = true;

          // Create dent effect by changing to dodecahedron
          this.el.setAttribute('geometry', {
            primitive: 'dodecahedron',
            radius: (this.originalGeometry.radius || 0.25) * 0.95
          });

          // Darken color slightly
          const originalColor = this.originalMaterial.color || '#ff0000';
          const darkerColor = this.darkenColor(originalColor, 0.3);
          this.el.setAttribute('material', {
            color: darkerColor,
            roughness: 0.7
          });
        },

        // Minor damage - small dent
        minorDamage: function() {
          this.isDamaged = true;

          // Slightly flatten the ball
          this.el.setAttribute('animation__damage', {
            property: 'scale',
            to: '0.95 0.9 0.95',
            dur: 300,
            easing: 'easeOutQuad'
          });

          // Slightly change material
          this.el.setAttribute('material', {
            roughness: 0.6
          });
        },

        // Create destruction particle system
        createDestructionParticles: function(collisionPoint) {
          const particles = document.createElement('a-entity');
          particles.setAttribute('position', collisionPoint || this.el.getAttribute('position'));
          particles.setAttribute('particle-system', {
            preset: 'default',
            particleCount: 300,
            maxAge: 2.0,
            accelerationValue: '0, -9.8, 0',
            velocityValue: '0, 5, 0',
            velocitySpread: '8, 3, 8',
            size: '0.1, 0.01',
            color: this.originalMaterial.color || '#ff0000',
            opacity: '1.0, 0.0'
          });

          this.el.sceneEl.appendChild(particles);

          // Remove particles after animation
          setTimeout(() => {
            if (particles.parentNode) {
              particles.parentNode.removeChild(particles);
            }
          }, 3000);
        },

        // Create ball fragments
        createBallFragments: function() {
          const position = this.el.getAttribute('position');
          const color = this.originalMaterial.color || '#ff0000';

          for (let i = 0; i < 6; i++) {
            const fragment = document.createElement('a-box');
            fragment.setAttribute('position', {
              x: position.x + (Math.random() - 0.5) * 0.5,
              y: position.y + (Math.random() - 0.5) * 0.5,
              z: position.z + (Math.random() - 0.5) * 0.5
            });
            fragment.setAttribute('width', Math.random() * 0.1 + 0.05);
            fragment.setAttribute('height', Math.random() * 0.1 + 0.05);
            fragment.setAttribute('depth', Math.random() * 0.1 + 0.05);
            fragment.setAttribute('material', {
              color: color,
              opacity: 0.8
            });
            fragment.setAttribute('animation', {
              property: 'position',
              to: {
                x: position.x + (Math.random() - 0.5) * 3,
                y: position.y - 2,
                z: position.z + (Math.random() - 0.5) * 3
              },
              dur: 2000 + Math.random() * 1000,
              easing: 'easeOutQuad'
            });
            fragment.setAttribute('animation__fade', {
              property: 'material.opacity',
              to: 0,
              dur: 3000,
              delay: 1000
            });

            this.el.sceneEl.appendChild(fragment);

            // Clean up fragments
            setTimeout(() => {
              if (fragment.parentNode) {
                fragment.parentNode.removeChild(fragment);
              }
            }, 4000);
          }
        },

        // Add crack pattern (simplified version)
        addCrackPattern: function() {
          // Create thin crack lines as child entities
          for (let i = 0; i < 3; i++) {
            const crack = document.createElement('a-cylinder');
            crack.setAttribute('position', {
              x: (Math.random() - 0.5) * 0.3,
              y: (Math.random() - 0.5) * 0.3,
              z: 0.24
            });
            crack.setAttribute('rotation', {
              x: 0,
              y: 0,
              z: Math.random() * 360
            });
            crack.setAttribute('radius', 0.01);
            crack.setAttribute('height', 0.3);
            crack.setAttribute('material', {
              color: '#000000',
              opacity: 0.7
            });

            this.el.appendChild(crack);
          }
        },

        // Play damage sound based on damage type
        playDamageSound: function(damageType) {
          const particles = document.getElementById('collisionParticles');
          if (!particles) return;

          try {
            switch(damageType) {
              case 'destroy':
                if (particles.components['break-sound']) {
                  particles.components['break-sound'].playSound();
                }
                break;
              case 'severe_damage':
                if (particles.components['crack-sound']) {
                  particles.components['crack-sound'].playSound();
                }
                break;
              case 'moderate_damage':
                if (particles.components['demo-sound']) {
                  particles.components['demo-sound'].playSound();
                }
                break;
              case 'minor_damage':
                if (particles.components.sound) {
                  particles.components.sound.playSound();
                }
                break;
              default:
                if (particles.components.sound) {
                  particles.components.sound.playSound();
                }
            }
          } catch (error) {
            console.log('Damage sound not ready:', error);
          }
        },

        // Utility function to darken colors
        darkenColor: function(color, amount) {
          const hex = color.replace('#', '');
          const r = Math.max(0, parseInt(hex.substr(0, 2), 16) - Math.floor(255 * amount));
          const g = Math.max(0, parseInt(hex.substr(2, 2), 16) - Math.floor(255 * amount));
          const b = Math.max(0, parseInt(hex.substr(4, 2), 16) - Math.floor(255 * amount));

          return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        },

        // Reset ball to original state
        reset: function() {
          if (this.isDestroyed) {
            this.el.setAttribute('visible', true);
            this.isDestroyed = false;
          }

          if (this.isDamaged) {
            this.el.setAttribute('geometry', this.originalGeometry);
            this.el.setAttribute('material', this.originalMaterial);
            this.el.setAttribute('scale', '1 1 1');

            // Remove crack patterns
            const cracks = this.el.querySelectorAll('a-cylinder');
            cracks.forEach(crack => crack.parentNode.removeChild(crack));

            this.isDamaged = false;
          }
        }
      });

      // Enhanced collision detection with inelastic effects
      AFRAME.registerComponent('inelastic-collision', {
        schema: {
          mass: { default: 1.0 },
          restitution: { default: 0.0 }, // 0 for completely inelastic
          damageEnabled: { default: true }
        },

        init: function () {
          this.velocity = new THREE.Vector3();
          this.hasCollided = false;
        },

        // Handle collision with another ball
        handleCollision: function(otherBall, otherMass, otherVelocity) {
          if (this.hasCollided) return;

          const myMass = this.data.mass;
          const myVelocity = this.velocity.clone();
          const massRatio = Math.abs(myMass - otherMass) / Math.min(myMass, otherMass);
          const impactVelocity = myVelocity.length() + otherVelocity.length();

          console.log('Collision detected:', {
            ball1: this.el.id,
            ball2: otherBall.id,
            massRatio: massRatio,
            impactVelocity: impactVelocity
          });

          // Apply damage if enabled
          if (this.data.damageEnabled && this.el.components['ball-damage']) {
            const damageType = this.el.components['ball-damage'].calculateDamageType(massRatio, impactVelocity);
            this.el.components['ball-damage'].applyDamage(damageType);
          }

          // Calculate collision point
          const myPos = this.el.getAttribute('position');
          const otherPos = otherBall.getAttribute('position');
          const collisionPoint = {
            x: (myPos.x + otherPos.x) / 2,
            y: (myPos.y + otherPos.y) / 2,
            z: (myPos.z + otherPos.z) / 2
          };

          // Trigger collision effects
          this.triggerCollisionEffects(collisionPoint, impactVelocity);

          this.hasCollided = true;

          // Reset collision flag after some time
          setTimeout(() => {
            this.hasCollided = false;
          }, 1000);
        },

        // Trigger visual and audio effects
        triggerCollisionEffects: function(collisionPoint, intensity) {
          // Trigger collision flash
          const flash = document.getElementById('collisionFlash');
          if (flash) {
            flash.setAttribute('position', collisionPoint);
            flash.setAttribute('intensity', Math.min(intensity * 2, 10));

            // Animate flash
            flash.setAttribute('animation__flash', {
              property: 'intensity',
              from: flash.getAttribute('intensity'),
              to: 0,
              dur: 500,
              easing: 'easeOutQuad'
            });
          }

          // Trigger particle effects
          const particles = document.getElementById('collisionParticles');
          if (particles) {
            particles.setAttribute('position', collisionPoint);
            particles.setAttribute('visible', true);

            setTimeout(() => {
              particles.setAttribute('visible', false);
            }, 2000);
          }

          // Play collision sound
          const sound = particles.components.sound;
          if (sound) {
            sound.playSound();
          }
        }
      });

      // Audio components for different damage types
      AFRAME.registerComponent('crack-sound', {
        schema: {
          src: { type: 'audio' },
          volume: { default: 0.7 },
          autoplay: { default: false },
          poolSize: { default: 2 }
        },
        init: function() {
          this.pool = [];
          this.setupPool();
        },
        setupPool: function() {
          for (let i = 0; i < this.data.poolSize; i++) {
            this.pool.push(new Audio(this.data.src));
          }
        },
        playSound: function() {
          const audio = this.pool.find(a => a.ended || a.paused);
          if (audio) {
            audio.volume = this.data.volume;
            audio.play().catch(e => console.log('Audio play failed:', e));
          }
        }
      });

      AFRAME.registerComponent('break-sound', {
        schema: {
          src: { type: 'audio' },
          volume: { default: 0.8 },
          autoplay: { default: false },
          poolSize: { default: 2 }
        },
        init: function() {
          this.pool = [];
          this.setupPool();
        },
        setupPool: function() {
          for (let i = 0; i < this.data.poolSize; i++) {
            this.pool.push(new Audio(this.data.src));
          }
        },
        playSound: function() {
          const audio = this.pool.find(a => a.ended || a.paused);
          if (audio) {
            audio.volume = this.data.volume;
            audio.play().catch(e => console.log('Audio play failed:', e));
          }
        }
      });

      AFRAME.registerComponent('demo-sound', {
        schema: {
          src: { type: 'audio' },
          volume: { default: 0.6 },
          autoplay: { default: false },
          poolSize: { default: 2 }
        },
        init: function() {
          this.pool = [];
          this.setupPool();
        },
        setupPool: function() {
          for (let i = 0; i < this.data.poolSize; i++) {
            this.pool.push(new Audio(this.data.src));
          }
        },
        playSound: function() {
          const audio = this.pool.find(a => a.ended || a.paused);
          if (audio) {
            audio.volume = this.data.volume;
            audio.play().catch(e => console.log('Audio play failed:', e));
          }
        }
      });

      // Player collider: stops the player from penetrating any .collidable object
      AFRAME.registerComponent('collider', {
        schema: { 
          distance: { default: 1.2 },
          debug: { default: false }
        },
        init: function () {
          this.raycaster = new THREE.Raycaster();
          this.lastSafePosition = new THREE.Vector3();
          this.directions = [
            new THREE.Vector3(0, 0, -1), // forward
            new THREE.Vector3(0, 0, 1), // backward
            new THREE.Vector3(-1, 0, 0), // left
            new THREE.Vector3(1, 0, 0), // right
            new THREE.Vector3(-0.7, 0, -0.7), // diagonal front-left
            new THREE.Vector3(0.7, 0, -0.7), // diagonal front-right
            new THREE.Vector3(-0.7, 0, 0.7), // diagonal back-left
            new THREE.Vector3(0.7, 0, 0.7), // diagonal back-right
          ];
          this.el.addEventListener('loaded', () => {
            this.el.object3D.getWorldPosition(this.lastSafePosition);
          });
        },
        tick: function (time, delta) {
          const collidableEls = this.el.sceneEl.querySelectorAll('.collidable');
          if (collidableEls.length === 0) return;

          const collidables = [];
          collidableEls.forEach((el) => {
            if (el.object3D) {
              collidables.push(el.object3D);
            }
          });

          let collision = false;
          const currentPosition = new THREE.Vector3();
          this.el.object3D.getWorldPosition(currentPosition);

          for (const dir of this.directions) {
            const worldDir = dir.clone().applyQuaternion(this.el.object3D.quaternion);
            this.raycaster.set(currentPosition, worldDir);
            this.raycaster.far = this.data.distance;
            const intersects = this.raycaster.intersectObjects(collidables, true);

          if (intersects.length > 0 && intersects[0].distance < this.data.distance) {
            const hitEl = intersects[0].object.el;

            if (this.data.debug) {
              console.log('Collision detected with:', hitEl ? hitEl.id : 'unknown', 'distance:', intersects[0].distance);
            }

            // Prevent penetration
            this.el.object3D.position.copy(this.lastSafePosition);
            collision = true;
            break;
          }
        }

        if (!collision) {
          this.el.object3D.getWorldPosition(this.lastSafePosition);
        }
      },
    });

    // Info untuk pengguna
    console.log('BioExplore loaded successfully!');
    console.log('If GLB models fail to load due to CORS, fallback models will be used.');
    console.log('To use GLB models properly, serve this file from a local server (e.g., Live Server extension)');

    // Custom VR Button Setup
    function setupVRButton() {
      const vrButton = document.getElementById('custom-vr-btn');
      const scene = document.querySelector('a-scene');

      if (!vrButton || !scene) return;

      vrButton.addEventListener('click', function() {
        if (scene.is('vr-mode')) {
          // Exit VR and clear localStorage flag
          scene.exitVR();
          localStorage.removeItem('vrModeActive');
          document.body.classList.remove('vr-mode');
          vrButton.style.display = 'flex';
          console.log('Exited VR mode - cleared localStorage flag');
        } else {
          // Enter VR and set localStorage flag
          scene.enterVR();
          localStorage.setItem('vrModeActive', 'true');
          document.body.classList.add('vr-mode');
          vrButton.style.display = 'none';
          console.log('Entered VR mode - set localStorage flag');
        }
      });

      // Listen to VR mode events
      scene.addEventListener('enter-vr', function() {
        document.body.classList.add('vr-mode');
        vrButton.style.display = 'none';
        localStorage.setItem('vrModeActive', 'true');
        console.log('Entered VR mode');
      });

      scene.addEventListener('exit-vr', function() {
        document.body.classList.remove('vr-mode');
        vrButton.style.display = 'flex';
        localStorage.removeItem('vrModeActive');
        console.log('Exited VR mode');
      });

      // Auto-enter VR if flag is set in localStorage
      const vrModeActive = localStorage.getItem('vrModeActive');
      if (vrModeActive === 'true') {
        console.log('VR mode was active, re-entering VR mode...');
        // Wait longer for scene to fully load before entering VR (2 seconds for safety)
        setTimeout(() => {
          scene.enterVR();
        }, 2000);
      }
    }

    // Setup VR-Safe Navigation - Exit VR Before Navigation
    function setupVRSafeNavigation() {
      const scene = document.querySelector('a-scene');
      if (!scene) return;

      // Intercept all a-link clicks
      const links = document.querySelectorAll('a-link, [link]');

      links.forEach(link => {
        link.addEventListener('click', function(evt) {
          // Get href from link attribute
          const linkAttr = this.getAttribute('link');
          const href = this.getAttribute('href') ||
                      (linkAttr ? linkAttr.split(';').find(s => s.includes('href')).split(':')[1].trim() : null);

          if (href && scene.is('vr-mode')) {
            // Exit VR first to prevent stuck state
            evt.preventDefault();
            evt.stopPropagation();

            console.log('Exiting VR before navigation to:', href);
            scene.exitVR();

            // Wait for VR exit to complete, then navigate
            setTimeout(() => {
              window.location.href = href;
            }, 500);
          }
        });
      });

      console.log('VR-safe navigation setup complete for', links.length, 'links');
    }

    // Initialize VR button and navigation on scene load
    const sceneEl = document.querySelector('a-scene');
    if (sceneEl.hasLoaded) {
      setupVRButton();
      setupVRSafeNavigation();
    } else {
      sceneEl.addEventListener('loaded', function() {
        setupVRButton();
        setupVRSafeNavigation();
      });
    }
  </script>
</body>

</html>