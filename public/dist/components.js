!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var i=e();for(var n in i)("object"==typeof exports?exports:t)[n]=i[n]}}(self,()=>(()=>{var t={134:()=>{const t=[["SittingIdle","/SittingIdle_man.fbx",{ignoreBones:["Spine1","Spine2","Neck","Head","LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.1}],["Idle","/BreathingIdle.fbx",{ignoreBones:["Spine1","Spine2","Neck","Head","LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.1}],["Walking","/Walking.fbx",{ignoreBones:["LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.1,removeHipsForwardAnimation:!0}],["Dying","/Dying.fbx",{ignoreBones:["LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:0}]],e=[["SittingIdle","/SittingIdle_woman.fbx",{ignoreBones:["Spine1","Spine2","Neck","Head","LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.1}],["Idle","/BreathingIdle.fbx",{ignoreBones:["Spine1","Spine2","Neck","Head","LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.168}],["Walking","/Walking.fbx",{ignoreBones:["LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.168,removeHipsForwardAnimation:!0}],["Dying","/Dying.fbx",{ignoreBones:["LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:0}]],i={};NAF.schemas.getComponentsOriginal=NAF.schemas.getComponents,NAF.schemas.getComponents=t=>(NAF.schemas.hasTemplate("#avatar-template")||NAF.schemas.add({template:"#avatar-template",components:["avatar-bones","player-info",{component:"position",requiresNetworkUpdate:NAF.utils.vectorRequiresUpdate(.001)},{component:"rotation",requiresNetworkUpdate:NAF.utils.vectorRequiresUpdate(.5)},{selector:".model",component:"rotation",requiresNetworkUpdate:NAF.utils.vectorRequiresUpdate(.5)}]}),NAF.schemas.getComponentsOriginal(t));const n=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI),s=t=>Math.round(100*t)/100;function o(t,e){for(let i=0,n=function(t){return Array.isArray(t)?t:t.bones}(e);i<n.length;i++)if(t===n[i].name)return n[i]}function a(t,e,i={}){const n=i.names??{},s=i.offsets??{},a=i.positionMultiplier??1,r=i.inverseBones??!1,h=i.ignoreBones??[],l=i.removeHipsForwardAnimation??!1,d=i.positionOffset??0,c=[],u=new THREE.Quaternion;return e.tracks.forEach(p=>{const m=p.name.split("."),f=m[0],y=n[f]||f,g=m[1];if(o(y,t.skeleton)||"Armature"===y)if(h.indexOf(y)>-1)console.log(e.name,"ignore track",y);else if(p instanceof THREE.VectorKeyframeTrack&&p.name.endsWith("position")&&i.hip===y){const t=new THREE.VectorKeyframeTrack(`${y}.${g}`,p.times,p.values.map((t,e)=>(t*=a,l&&e%3==1&&(t=0),0!==d&&e%3==2&&(t+=d),t)));c.push(t)}else if(p instanceof THREE.QuaternionKeyframeTrack){const t=p.times,e=p.values.map((t,e)=>r&&e%2==0?-t:t),i=s[y];if(i){const t=p.values.length/4;for(let n=0;n<t;++n)u.fromArray(e,4*n),u.multiply(i),u.toArray(e,4*n)}const n=new THREE.QuaternionKeyframeTrack(`${y}.${g}`,t,e);c.push(n)}}),new THREE.AnimationClip(e.name,e.duration,c)}AFRAME.registerComponent("avatar-bones",{schema:{Head:{type:"vec4"}},init:function(){"rig"!==this.el.id&&(this.headBuffer=new NAF.InterpolationBuffer(0,.1)),this.localEuler=new THREE.Euler,this.localQuaternion=new THREE.Quaternion,this.localQuaternion2=new THREE.Quaternion,this.localQuaternion3=new THREE.Quaternion,this.tmpQuaternion=new THREE.Quaternion,this.transitionQuaternionStart=new THREE.Quaternion,this.transitionQuaternionEnd=new THREE.Quaternion,this.prevTime=0,this.transitionProgress=1},events:{"model-loaded":function(){queueMicrotask(()=>{if(this.mesh=this.el.components["player-info"].mesh,this.mesh){const t=this.mesh.skeleton.bones;this.hips=o("Hips",t),this.spine=o("Spine",t),this.spine1=o("Spine1",t),this.spine2=o("Spine2",t),this.neck=o("Neck",t),this.head=o("Head",t),this.spine1quaternion=(new THREE.Quaternion).copy(this.spine1.quaternion),this.spine2quaternion=(new THREE.Quaternion).copy(this.spine2.quaternion),this.neckquaternion=(new THREE.Quaternion).copy(this.neck.quaternion)}})}},update:function(t){"rig"===this.el.id||this.headBuffer.setQuaternion(this.data.Head)},tick:function(t,e){if("rig"===this.el.id){if(this.head){if(!this.cameraEl&&(this.cameraEl=this.el.querySelector(".camera"),!this.cameraEl))return void console.log("No .camera found on rig children");const i=this.cameraEl.object3D,o=this.el.components["player-info"].avatarEl.object3D.quaternion,a=this.localQuaternion.copy(i.quaternion).multiply(n),r=this.localEuler.setFromQuaternion(a,"YXZ");r.x=0,r.z=0;const h=this.localQuaternion2.setFromEuler(r);if((o.angleTo(h)>.5||t-this.prevTime>2e3)&&(this.transitionProgress=0,this.transitionQuaternionStart.copy(o),this.transitionQuaternionEnd.copy(h),this.prevTime=t),this.transitionProgress<1&&(this.transitionProgress+=.006*e,o.slerpQuaternions(this.transitionQuaternionStart,this.transitionQuaternionEnd,this.transitionProgress)),"Idle"!==this.el.components["player-info"].data.state)return;this.spine1.quaternion.copy(this.spine1quaternion),this.spine2.quaternion.copy(this.spine2quaternion),this.neck.quaternion.copy(this.neckquaternion),this.head.quaternion.copy(a).premultiply(this.localQuaternion3.copy(o).invert());const l=this.head.rotation.z;this.head.rotation.z=-this.head.rotation.x,this.head.rotation.x=l,this.head.rotation.y-=.3,this.head.rotation.z=Math.max(-1,Math.min(.7,this.head.rotation.z)),this.head.rotation.x=Math.max(-1,Math.min(1,this.head.rotation.x)),this.data.Head.x=s(this.head.quaternion.x),this.data.Head.y=s(this.head.quaternion.y),this.data.Head.z=s(this.head.quaternion.z),this.data.Head.w=s(this.head.quaternion.w)}}else{if("Idle"!==this.el.components["player-info"].data.state)return;this.spine1&&this.spine1.quaternion.copy(this.spine1quaternion),this.spine2&&this.spine2.quaternion.copy(this.spine2quaternion),this.neck&&this.neck.quaternion.copy(this.neckquaternion),this.headBuffer.update(e),this.head&&this.head.quaternion.copy(this.headBuffer.getQuaternion())}}}),AFRAME.registerComponent("player-info",{dependencies:["avatar-bones"],schema:{name:{type:"string",default:"anonymous"},color:{type:"color",default:"#ffffff"},avatarSrc:{type:"string",default:""},state:{type:"string",default:"Idle"},muted:{type:"boolean",default:!1},avatarPose:{type:"string",default:"stand",oneOf:["stand","sit"]},seatRotation:{type:"number",default:0}},init:function(){this.nametag=this.el.querySelector(".nametag"),this.setAnimation=this.setAnimation.bind(this),this.setAnimationFromState=this.setAnimationFromState.bind(this),this.getAnimationMixer=this.getAnimationMixer.bind(this),this.removeAnimationMixer=this.removeAnimationMixer.bind(this),this.positionChanged=this.positionChanged.bind(this),this.isAtCloseDistance=this.isAtCloseDistance.bind(this),this.maxDistanceSquared=.25,this.rig=document.querySelector("#rig"),this.fbxLoader=new THREE.FBXLoader,this.glbLoader=new THREE.GLTFLoader,this.updatedEventDetail={el:void 0,data:void 0,oldData:void 0}},update:function(t){this.updatedEventDetail.data=this.data,this.updatedEventDetail.oldData=t,this.updatedEventDetail.el=this.el,this.el.sceneEl.emit("player-info-updated",this.updatedEventDetail),this.updatedEventDetail.data=void 0,this.updatedEventDetail.oldData=void 0,this.updatedEventDetail.el=void 0,this.nametag&&this.nametag.setAttribute("value",this.data.name),this.avatarEl=this.el.querySelector(".model"),this.avatarEl||(this.avatarEl=document.createElement("a-entity"),this.el.appendChild(this.avatarEl),this.avatarEl.setAttribute("class","model")),this.avatarEl.setAttribute("shadow",""),this.el.object3D.rotation.order="YXZ",this.avatarEl.object3D.rotation.order="YXZ",t&&this.data.avatarSrc&&t.avatarSrc&&this.data.avatarSrc!==t.avatarSrc&&(this.mesh=void 0,this.removeAnimationMixer()),this.data.avatarSrc&&this.avatarEl.setAttribute("gltf-model",this.data.avatarSrc),this.mesh&&this.mixer&&t&&this.data&&(t.state!==this.data.state||t.avatarPose!==this.data.avatarPose)&&this.setAnimationFromState()},tick:function(t){if("rig"!==this.el.id&&(this.el.object3D.visible=!this.isAtCloseDistance(this.rig.object3D,this.el.object3D)),this.mesh){const e=this.mesh.morphTargetDictionary;t%6e3<500&&(this.startBlinking=!0);const i=(Math.sin(t/100)+1)/2;i<.3&&(this.startBlinking=!1,this.mesh.morphTargetInfluences[e["h_expressions.ReyeClose_h"]]=0,this.mesh.morphTargetInfluences[e["h_expressions.LeyeClose_h"]]=0),this.startBlinking&&(this.mesh.morphTargetInfluences[e["h_expressions.ReyeClose_h"]]=i,this.mesh.morphTargetInfluences[e["h_expressions.LeyeClose_h"]]=i)}},setAnimation:function(t){this.avatarEl.setAttribute("animation-mixer",t)},setAnimationFromState(){let t=this.data.state;"Idle"===this.data.state&&(t="sit"===this.data.avatarPose?"SittingIdle":"Idle"),this.setAnimation(`clip:${t};loop:repeat`)},getAnimationMixer:function(){return this.avatarEl.getAttribute("animation-mixer")},removeAnimationMixer:function(){this.avatarEl.removeAttribute("animation-mixer"),this.mixer=null},positionChanged(){this.el.sceneEl.systems.waypoint?.occupyWaypoint&&this.el.sceneEl.systems.waypoint.unoccupyWaypoint(),this.mixer&&(clearTimeout(this.revertToIdleTimeout),this.revertToIdleTimeout=setTimeout(()=>{this.el.setAttribute("player-info","state","Idle")},100),this.el.setAttribute("player-info","state","Walking"))},isAtCloseDistance:function(t,e){const i=t.position,n=e.position,s=i.x-n.x,o=i.z-n.z;return s*s+o*o<this.maxDistanceSquared},events:{teleported:function(t){this.positionChanged()},moved:function(t){this.positionChanged()},"navigation-start":function(t){this.el.sceneEl.systems.waypoint?.occupyWaypoint&&this.el.sceneEl.systems.waypoint.unoccupyWaypoint(),this.el.hasAttribute("simple-navmesh-constraint")&&this.el.setAttribute("simple-navmesh-constraint","enabled",!1),this.el.setAttribute("player-info","state","Walking")},"navigation-end":function(t){this.el.hasAttribute("simple-navmesh-constraint")&&this.el.setAttribute("simple-navmesh-constraint","enabled",!0),this.el.setAttribute("player-info","state","Idle")},"model-loaded":function(n){"rig"===this.el.id&&this.avatarEl.object3D.traverse(t=>{t.layers&&(t.layers.disableAll(),t.layers.enable(3))}),this.avatarEl.object3D.traverse(t=>{t.isMesh&&(t.frustumCulled=!1)});const s=n.detail.model;if(s.name="Armature",this.mesh=s.getObjectByName("H_DDS_HighRes"),!this.mesh)return;const o=()=>{s.animations=Array.from(i[h].animations),this.setAnimationFromState(),this.mixer=this.getAnimationMixer()},r=this.data.avatarSrc.indexOf("_F_")>-1,h=`valid-${r}`;if(i[h]=i[h]||{},i[h].animations)o();else{if(!i[h].promise){const n=new Promise((n,s)=>{(async()=>{const s=r?e:t,o=[];for(let[t,e,i]of s){const n=e.indexOf(".glb")>-1?this.glbLoader:this.fbxLoader;i=i??{};const s=(await n.loadAsync(e)).animations[0];let r=s;s.name=t,r=a(this.mesh,s,{hip:"Hips",names:{Reference:"Armature"},offsets:i.quatOffsets??{},positionMultiplier:i.positionMultiplier??1,positionOffset:i.positionOffset??0,ignoreBones:i.ignoreBones??[],removeHipsForwardAnimation:i.removeHipsForwardAnimation??!1}),console.log("retargeted",s.name,"renamed to",t),o.push(r),console.log("animation after conversion",r)}i[h].animations=o,n()})()});i[h].promise=n}i[h].promise.then(o).catch(()=>{console.error("Error loading the animations")})}}}})},430:()=>{AFRAME.registerComponent("car-pusher",{schema:{pushStrength:{default:5},radius:{default:1.5}},init:function(){this.playerPos=new THREE.Vector3,this.carPos=new THREE.Vector3,this.pushVector=new THREE.Vector3,this.carBody=null,this.physicsSystem=this.el.sceneEl.systems.physics},tick:function(t,e){if(!this.carBody){if(!this.physicsSystem)return;if(this.carBody=this.physicsSystem.getBodyById("ferrariBody"),!this.carBody)return}this.el.object3D.getWorldPosition(this.playerPos),this.carBody.el.object3D.getWorldPosition(this.carPos);const i=this.playerPos.distanceTo(this.carPos);if(i<this.data.radius){const t=this.data.radius-i;if(t<=0)return;this.pushVector.subVectors(this.carPos,this.playerPos).normalize();const e=t*this.data.pushStrength;this.carBody.velocity.set(this.pushVector.x*e,0,this.pushVector.z*e)}}})},585:()=>{AFRAME.registerComponent("follow-entity",{schema:{target:{type:"selector"}},tick:function(){if(!this.data.target)return;const t=this.data.target.object3D.position,e=this.data.target.object3D.quaternion;this.el.object3D.position.copy(t),this.el.object3D.quaternion.copy(e)}})},710:()=>{let t,e=!1;AFRAME.registerComponent("change-room",{schema:{on:{type:"string",default:"click"},room:{type:"string",default:""},url:{type:"string",default:""},select:{type:"string",default:"#scene"},target:{type:"string",default:"#scene"}},init(){this.changeRoom=this.changeRoom.bind(this)},async changeRoom(){if(e)return;const i=this.el.sceneEl,{url:n,select:s,target:o}=this.data;try{e=!0,window.history.pushState(null,"",n);const a=await fetch(n);if(!a.ok)throw new Error("Network response was not ok");const r=await a.text(),h=(new DOMParser).parseFromString(r,"text/html").querySelector(s);if(h?document.querySelector(o).outerHTML=h.outerHTML:console.error(`Element ${o} not found in the fetched document.`),i.getAttribute("networked-scene").room===this.data.room)return void(e=!1);t||(t={...i.getAttribute("networked-scene"),connectOnLoad:!1}),t.room=this.data.room,i.removeAttribute("networked-scene"),setTimeout(()=>{i.setAttribute("networked-scene",t),i.emit("connect"),document.body.addEventListener("connected",()=>{e=!1;const t=document.getElementById("rig");t.setAttribute("networked-aframe",{creator:NAF.clientId}),NAF.utils.takeOwnership(t)},{once:!0})},1e3)}catch(t){e=!1,console.error("There has been a problem with the fetch operation:",t)}},play(){this.el.addEventListener(this.data.on,this.changeRoom)},pause(){this.el.removeEventListener(this.data.on,this.changeRoom)}})}},e={};function i(n){var s=e[n];if(void 0!==s)return s.exports;var o=e[n]={exports:{}};return t[n](o,o.exports,i),o.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};return(()=>{"use strict";i.r(n),i(134),i(710),i(430),i(585),AFRAME.registerComponent("spawn-in-circle",{schema:{radius:{type:"number",default:1}},init:function(){const t=this.el,e=t.getAttribute("position"),i=this.getRandomAngleInRadians(),n=this.randomPointOnCircle(this.data.radius,i),s={x:n.x+e.x,y:e.y,z:n.y+e.z};t.setAttribute("position",s)},getRandomAngleInRadians:function(){return 2*Math.PI*(Math.floor(8*Math.random())/8)},randomPointOnCircle:function(t,e){return{x:Math.cos(e)*t,y:Math.sin(e)*t}}})})(),n})());
//# sourceMappingURL=components.js.map